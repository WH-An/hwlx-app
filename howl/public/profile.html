<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ä¸ªäººä¸»é¡µ</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#ffffff; --text:#0f172a; --muted:#64748b; --accent:#16a34a;
      --border:#e5e7eb; --shadow:0 10px 30px rgba(0,0,0,.18); --radius:18px;
      --chip:#f8fafc; --chipText:#0f172a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:'Microsoft YaHei',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'PingFang SC',sans-serif;
      background:radial-gradient(1200px 600px at 10% -10%,#1f8db8 18%, transparent 60%),
                 radial-gradient(900px 500px at 110% 110%,#2bb8d6 12%, transparent 60%),var(--bg);
      color:#fff;
      overflow:hidden;
    }
    .container{display:grid;grid-template-columns:220px 1fr;gap:18px;height:100vh;padding:24px}

    .sidebar{
      background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);
      box-shadow:var(--shadow);padding:20px 16px;color:var(--text);display:flex;flex-direction:column;gap:16px
    }
    .account-info{
      display:flex;flex-direction:column;align-items:center;gap:10px;text-decoration:none;color:inherit;
      border:1px dashed #eef2ff;border-radius:14px;padding:14px;background:#fff
    }
    .avatar{width:56px;height:56px;border-radius:50%;object-fit:cover}
    .username{font-weight:700}
    .nav-list{list-style:none;margin:6px 0 0;padding:0;display:flex;flex-direction:column;gap:10px}
    .nav-list a{
      display:flex;align-items:center;gap:10px;text-decoration:none;color:var(--text);
      border:1px solid var(--border);background:#fafafa;border-radius:12px;padding:10px 14px;transition:.2s
    }
    .nav-list a:hover{background:#f3f4f6;transform:translateY(-1px)}
    .nav-icon{width:22px;display:inline-flex;justify-content:center}

    .panel{
      background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);
      box-shadow:var(--shadow);padding:18px;color:var(--text);display:flex;flex-direction:column;gap:14px;
      height:100%;
      overflow-y:auto;
    }
    .panel-header{display:flex;align-items:center;gap:12px}
    .panel-title{font-size:18px;font-weight:800;margin:0}
    .spacer{flex:1}
    .btn{
      display:inline-flex;align-items:center;gap:8px;cursor:pointer;border:1px solid var(--border);
      background:#fff;color:#111827;border-radius:12px;padding:8px 12px;font-weight:700;transition:.2s
    }
    .btn:hover{background:#f3f4f6}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}

    .card{
      display:grid;grid-template-columns:120px 1fr;gap:18px;align-items:center;
      background:#fff;border:1px solid var(--border);border-radius:14px;padding:16px;
      box-shadow:0 6px 18px rgba(0,0,0,.06)
    }
    .big-avatar{width:120px;height:120px;border-radius:50%;object-fit:cover;border:1px solid #e5e7eb}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .muted{color:#64748b;font-size:13px}
    .tip{min-height:18px;color:#d33}
    .file-label.btn{display:inline-flex}

    .headline{display:flex;align-items:baseline;gap:10px;flex-wrap:wrap}
    .headline .name{font-size:20px;font-weight:800}
    .headline .email{
      font-size:13px;color:var(--muted);padding:6px 8px;border:1px solid var(--border);
      border-radius:999px;background:var(--chip);color:var(--chipText)
    }

    .info-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    @media (max-width:680px){ .container{grid-template-columns:1fr} .info-grid{grid-template-columns:1fr} }

    .info-item{
      display:flex;align-items:center;gap:10px;border:1px solid var(--border);
      padding:10px 12px;border-radius:12px;background:#fafafa
    }
    .info-item .icon{width:22px;text-align:center}
    .info-item .label{font-size:12px;color:#6b7280}
    .info-item .value{font-weight:700;color:#111827}

    .id-row{display:flex;gap:8px;align-items:center}
    .mini-btn{
      border:1px solid var(--border);background:#fff;border-radius:999px;padding:4px 8px;cursor:pointer;font-size:12px
    }
    .mini-btn:hover{background:#f3f4f6}

    /* é¡¶éƒ¨è¡Œï¼šæˆ‘çš„å¸–å­ / æˆ‘çš„æ”¶è— åˆ‡æ¢ */
    .section-bar{display:flex;align-items:center;gap:10px;margin-top:8px}
    .section-title{font-size:16px;font-weight:800;margin:6px 0 2px}
    .tabs{display:flex;gap:8px;align-items:center}
    .tab{
      border:1px solid var(--border);background:#fff;border-radius:999px;padding:6px 12px;cursor:pointer;font-size:13px;
    }
    .tab.active{background:#0f172a;color:#fff;border-color:#0f172a}

    /* Masonry å¸ƒå±€ä¸å¡ç‰‡ */
    .posts-masonry{column-count:3; column-gap:14px}
    @media (max-width:1200px){ .posts-masonry{ column-count:2 } }
    @media (max-width:640px){  .posts-masonry{ column-count:1 } }

    .post-card{
      position:relative; display:inline-block; width:100%;
      margin:0 0 14px; border:1px solid var(--border); background:#fff;
      border-radius:14px; overflow:hidden; box-shadow:0 6px 18px rgba(0,0,0,.06);
      padding-bottom:46px; break-inside:avoid; -webkit-column-break-inside:avoid; page-break-inside:avoid;
      cursor:pointer;
    }
    .post-card img{ width:100%; display:block; aspect-ratio:4/5; object-fit:cover }
    .post-card-text{ padding:10px 12px; color:#374151; line-height:1.6 }

    .post-author-badge{
      position:absolute; right:10px; bottom:8px; display:flex; align-items:center; gap:8px;
      background:rgba(255,255,255,.92); border:1px solid var(--border);
      padding:6px 8px; border-radius:999px; box-shadow:0 4px 12px rgba(0,0,0,.10); max-width:80%;
    }
    .post-author-badge img{ width:22px; height:22px; border-radius:50%; object-fit:cover }
    .post-author-badge .name{ font-size:12px; color:#111827; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:150px }
  </style>
</head>
<body>
  <div class="container">
    <div class="sidebar">
      <a class="account-info" href="profile.html">
        <img src="" alt="å¤´åƒ" class="avatar"><span class="username">æˆ‘çš„è´¦å·</span>
      </a>
      <ul class="nav-list">
        <li><a href="main page.html"><span class="nav-icon">ğŸ </span><span>ä¸»é¡µ</span></a></li>
        <li><a href="life-tips.html"><span class="nav-icon">ğŸ’¡</span><span>ç”Ÿæ´»å°è´´å£«</span></a></li>
        <li><a href="study-guide.html"><span class="nav-icon">ğŸ“š</span><span>å­¦ä¹ æŒ‡å¯¼</span></a></li>
        <li><a href="enrollment-steps.html"><span class="nav-icon">ğŸ“</span><span>å…¥å­¦æ­¥éª¤</span></a></li>
        <li><a href="share.html"><span class="nav-icon">ğŸ”—</span><span>åˆ†äº«</span></a></li>
        <li><a href="fun.html"><span class="nav-icon">ğŸ‰</span><span>å¨±ä¹</span></a></li>
        <li><a href="hospital.html"><span class="nav-icon">ğŸ¥</span><span>åŒ»é™¢</span></a></li>
      </ul>
    </div>

    <div class="panel">
      <div class="panel-header">
        <h2 class="panel-title">ä¸ªäººä¸»é¡µ</h2>
        <div class="spacer"></div>
        <button id="logoutBtn" class="btn primary">é€€å‡ºç™»å½•</button>
      </div>

      <!-- èµ„æ–™å¡ -->
      <div class="card">
        <img id="profileAvatar" class="big-avatar" src="" alt="å¤´åƒ">
        <div>
          <div class="headline">
            <span id="profileName" class="name">â€”â€”</span>
            <span id="profileEmail" class="email">â€”â€”</span>
          </div>

          <div class="info-grid" style="margin-top:8px">
            <div class="info-item">
              <span class="icon">ğŸ“</span>
              <div>
                <div class="label">åŒºåŸŸ</div>
                <div id="profileArea" class="value">æœªå¡«å†™</div>
              </div>
            </div>
            <div class="info-item">
              <span class="icon">ğŸ†”</span>
              <div>
                <div class="label">å”¯ä¸€ ID</div>
                <div class="id-row">
                  <span id="profileId" class="value">â€”</span>
                  <button id="copyIdBtn" class="mini-btn" title="å¤åˆ¶ID">å¤åˆ¶</button>
                </div>
              </div>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <label class="file-label btn" for="avatar-upload">æ›´æ¢å¤´åƒ</label>
            <input id="avatar-upload" type="file" accept="image/*" style="display:none">
            <span id="upload-hint" class="muted">æ”¯æŒ JPG/PNG</span>
          </div>

          <div id="profile-tip" class="tip"></div>
        </div>
      </div>

      <!-- é¡¶éƒ¨åˆ‡æ¢è¡Œï¼šæˆ‘çš„å¸–å­ / æˆ‘çš„æ”¶è— -->
      <div class="section-bar">
        <h3 id="postsTitle" class="section-title">æˆ‘çš„å¸–å­</h3>
        <div class="tabs">
          <button id="tabMyPosts" class="tab active">æˆ‘çš„å¸–å­</button>
          <button id="tabMyFavs"  class="tab">æˆ‘çš„æ”¶è—</button>
        </div>
      </div>

      <!-- åˆ—è¡¨å®¹å™¨ï¼ˆå…±ç”¨ï¼‰ -->
      <div id="postList" class="posts-masonry"></div>
    </div>
  </div>

  <script>
  const BASE_URL = 'http://127.0.0.1:3001';
  const FALLBACK = 'https://raw.githubusercontent.com/WH-An/hwlx-app/2df4e97b395bebb7977074fbb31741f3c35da9a0/assets-task_01k3v2vy06fra8er06x602xnpe-1756476933_img_1.webp';

  const $ = sel => document.querySelector(sel);
  function toAbs(u){ if(!u) return ''; if(/^https?:\/\//i.test(u)) return u; return u.startsWith('/') ? (BASE_URL + u) : (BASE_URL + '/' + u); }
  function getParam(k){ try{ return new URL(location.href).searchParams.get(k); }catch{ return null; } }
  function fmt(v, fallback='æœªå¡«å†™'){ return (v===0 || v) ? String(v) : fallback; }
  const norm = s => String(s||'').trim().toLowerCase();

  // tabs åˆ‡æ¢å·¥å…·
  function activateTab(which){
    $('#tabMyPosts').classList.toggle('active', which==='posts');
    $('#tabMyFavs').classList.toggle('active',  which==='favs');
    $('#postsTitle').textContent = which === 'posts' ? 'æˆ‘çš„å¸–å­' : 'æˆ‘çš„æ”¶è—';
  }

  // å·¦ä¾§è´¦å·å¡ç‰‡
  async function renderSidebarUser(){
    try{
      const avatarEl = document.querySelector('.avatar');
      const nameEl = document.querySelector('.username');
      
      // ä¼˜å…ˆä»æœåŠ¡å™¨è·å–æœ€æ–°ç”¨æˆ·ä¿¡æ¯
      try {
        const response = await fetch(BASE_URL + '/api/users/me', { 
          credentials: 'include' 
        });
        
        if (response.ok) {
          const user = await response.json();
          const name = user.nickname || user.username || user.displayName || user.name || user.email || 'æˆ‘çš„è´¦å·';
          let avatar = user.avatarPath || user.avatarUrl || user.avatar || '';
          if(avatar && !/^https?:\/\//i.test(avatar)) avatar = toAbs(avatar);
          
          nameEl.textContent = name;
          nameEl.title = name;
          avatarEl.onerror = () => { avatarEl.src = FALLBACK; };
          avatarEl.src = avatar || FALLBACK;
          avatarEl.alt = name;
          
          // æ›´æ–°æœ¬åœ°å­˜å‚¨
          localStorage.setItem('currentUser', JSON.stringify(user));
          return;
        }
      } catch (e) {
        console.warn('ä»æœåŠ¡å™¨è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨:', e);
      }

      // å¦‚æœæœåŠ¡å™¨è·å–å¤±è´¥ï¼Œå›é€€åˆ°æœ¬åœ°å­˜å‚¨
      const raw = localStorage.getItem('currentUser')
            || localStorage.getItem('user')
            || localStorage.getItem('USER')
            || localStorage.getItem('auth_user');
      if(!raw){ nameEl.textContent='æˆ‘çš„è´¦å·'; avatarEl.src=FALLBACK; return; }
      const u = JSON.parse(raw)||{};
      const name = u.nickname || u.username || u.displayName || u.name || u.email || 'æˆ‘çš„è´¦å·';
      let avatar = u.avatarPath || u.avatarUrl || u.avatar || '';
      if(avatar && !/^https?:\/\//i.test(avatar)) avatar = toAbs(avatar);
      nameEl.textContent = name;
      nameEl.title = name;
      avatarEl.onerror = () => { avatarEl.src = FALLBACK; };
      avatarEl.src = avatar || FALLBACK;
      avatarEl.alt = name;
    }catch(e){
      console.error('æ¸²æŸ“ä¾§è¾¹æ ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', e);
      const avatarEl = document.querySelector('.avatar');
      const nameEl = document.querySelector('.username');
      if(nameEl) {
        nameEl.textContent = 'æˆ‘çš„è´¦å·';
        nameEl.title = 'æˆ‘çš„è´¦å·';
      }
      if(avatarEl) {
        avatarEl.src = FALLBACK;
        avatarEl.alt = 'æˆ‘çš„å¤´åƒ';
      }
    }
  }

  // æ¸²æŸ“ä¸»å¡ç‰‡
  function renderUser(u, opts = {}){
  const isOther = !!opts.isOther;

  const name  = u.nickname || u.username || u.displayName || u.name || u.email || 'â€”â€”';
  const email = u.email || 'â€”â€”';
  const area  = u.area;
  const uid   = u.id || u._id || '';
  let avatar  = u.avatarPath || u.avatarUrl || u.avatar || '';
  if(avatar && !/^https?:\/\//i.test(avatar)) avatar = toAbs(avatar);

  $('#profileName').textContent = name;
  const emailChip = $('#profileEmail');
  emailChip.textContent = email;
  emailChip.title = email;

  const img = $('#profileAvatar');
  img.onerror = () => { img.src = FALLBACK; };
  img.src = avatar || FALLBACK;
  img.alt = name;

  $('#profileArea').textContent = fmt(area);
  $('#profileId').textContent   = fmt(uid,'â€”');

  const copyBtn = $('#copyIdBtn');
  copyBtn.onclick = async () => {
    try{ await navigator.clipboard.writeText(String(uid||'')); toast('ID å·²å¤åˆ¶'); }
    catch{ toast('å¤åˆ¶å¤±è´¥'); }
  };

  // âœ… å…³é”®ï¼šåªæœ‰â€œçœ‹è‡ªå·±â€æ—¶æ‰æ›´æ–° currentUser / meUserï¼›çœ‹åˆ«äººæ”¾åˆ° lastViewedUser
  try{
    if (isOther) {
      localStorage.setItem('lastViewedUser', JSON.stringify(u));
    } else {
      localStorage.setItem('meUser', JSON.stringify(u));
      localStorage.setItem('currentUser', JSON.stringify(u));
    }
  }catch{}
}

  function toast(text){
    const tip = $('#profile-tip');
    tip.style.color = '#16a34a';
    tip.textContent = text;
    setTimeout(()=>{ tip.textContent=''; tip.style.color='#d33'; }, 1500);
  }

  function setButtonToLogin(){
    const btn = $('#logoutBtn');
    btn.textContent = 'ç™»å½•';
    btn.title = 'ç‚¹å‡»ç™»å½•';
    btn.classList.add('primary');
    const cloned = btn.cloneNode(true);
    cloned.addEventListener('click', () => { location.href = 'login.html'; });
    btn.parentNode.replaceChild(cloned, btn);

    $('#avatar-upload').disabled = true;
    const lab = document.querySelector('.file-label.btn');
    if (lab) lab.style.display = 'none';
    $('#upload-hint').textContent = 'è¯·ç™»å½•åå¯æ›´æ¢å¤´åƒ';
  }

  function setButtonToBack(){
    const btn = $('#logoutBtn');
    btn.textContent = 'è¿”å›ä¸»é¡µ';
    btn.title = 'è¿”å›ä¸»é¡µ';
    btn.classList.remove('primary');
    const cloned = btn.cloneNode(true);
    cloned.addEventListener('click', () => { location.href = 'main page.html'; });
    btn.parentNode.replaceChild(cloned, btn);

    $('#avatar-upload').disabled = true;
    const lab = document.querySelector('.file-label.btn');
    if (lab) lab.style.display = 'none';
    $('#upload-hint').textContent = 'è¿™æ˜¯å¯¹æ–¹çš„ä¸ªäººä¸»é¡µï¼Œå¤´åƒä¸å¯ç”±ä½ ä¿®æ”¹';
  }

  async function doLogout(){
    try{ await fetch(BASE_URL + '/api/logout', { method:'POST', credentials:'include' }); }catch{}
    // æ¸…é™¤æ‰€æœ‰æœ¬åœ°å­˜å‚¨çš„ç”¨æˆ·ä¿¡æ¯
    ['currentUser', 'user', 'USER', 'auth_user', 'tempUser', 'meUser'].forEach(key => {
      localStorage.removeItem(key);
    });
    location.href = 'login.html';
  }

  /* ====== å¸–å­å¡ç‰‡æ¸²æŸ“ ====== */
  function extractAuthor(p){
    const u = p.user || p.author || p.owner || {};
    let name   = (p.authorName || u.nickname || u.username || u.displayName || u.name || p.username || p.email || '').trim();
    let avatar = (p.authorAvatar || u.avatarPath || u.avatarUrl || u.avatar || p.avatar || '').trim();
    if(!name) name='åŒ¿åç”¨æˆ·';
    if(avatar && !/^https?:\/\//i.test(avatar)) avatar = toAbs(avatar);
    return { name, avatar };
  }

  function renderPosts(list){
    const box = $('#postList');
    box.innerHTML = '';
    (list||[]).forEach(p=>{
      const card = document.createElement('div');
      card.className = 'post-card';

      const pid = p._id || p.id;
      if (pid){
        card.addEventListener('click', ()=>{ location.href = 'post.html?id='+encodeURIComponent(pid); });
        card.style.cursor = 'pointer';
      }

      (p.images||[]).forEach(src=>{
        const img = document.createElement('img');
        img.src = toAbs(src);
        img.alt = '';
        img.onerror = ()=>{ img.remove(); };
        card.appendChild(img);
      });

      if(p.desc || p.title){
        const t = document.createElement('div');
        t.className = 'post-card-text';
        t.textContent = p.desc || p.title || '';
        card.appendChild(t);
      }

      const {name, avatar} = extractAuthor(p);
      const badge = document.createElement('div');
      badge.className = 'post-author-badge';
      const ava = document.createElement('img');
      const FALL = 'https://raw.githubusercontent.com/WH-An/hwlx-app/2df4e97b395bebb7977074fbb31741f3c35da9a0/assets-task_01k3v2vy06fra8er06x602xnpe-1756476933_img_1.webp';
      ava.onerror = ()=>{ ava.src = FALL; };
      ava.src = avatar || FALL;
      ava.alt = name;
      const nm = document.createElement('span');
      nm.className = 'name';
      nm.textContent = name;
      badge.appendChild(ava);
      badge.appendChild(nm);
      card.appendChild(badge);

      box.appendChild(card);
    });

    if(!list || list.length===0){
      const empty=document.createElement('div');
      empty.className='muted';
      empty.style.padding='8px 2px';
      empty.textContent='æš‚æ— å†…å®¹';
      box.appendChild(empty);
    }
  }

  /* ====== æ•°æ®åŠ è½½ï¼šæˆ‘çš„å¸–å­ / æˆ‘çš„æ”¶è— ====== */

  // åˆ¤æ–­å¸–å­å±äºç›®æ ‡ç”¨æˆ·
  function isOwnedByTarget(post, target){
    const targetEmails = [target?.email].map(norm).filter(Boolean);
    const targetIds = [target?.id, target?._id, target?.uid].map(norm).filter(Boolean);

    const postEmails = [
      post.authorEmail, post.email,
      post.user && post.user.email,
      post.owner && post.owner.email,
      post.author && post.author.email
    ].map(norm).filter(Boolean);

    const postIds = [
      post.authorId, post.userId, post.uid, post._userId,
      post.createdBy, post.created_by,
      post.user && (post.user.id || post.user._id),
      post.owner && (post.owner.id || post.owner._id),
      post.author && (post.author.id || post.author._id)
    ].map(norm).filter(Boolean);

    const emailHit = targetEmails.length && postEmails.some(e => targetEmails.includes(e));
    const idHit    = targetIds.length && postIds.some(i => targetIds.includes(i));
    return emailHit || idHit;
  }

  async function loadAllPosts(){
    try{
      const r = await fetch(`${BASE_URL}/api/posts`, { credentials:'include' });
      const arr = await r.json();
      return Array.isArray(arr) ? arr : [];
    }catch{ return []; }
  }

  async function loadMyPosts(targetUser){
    let posts = await loadAllPosts();
    posts = posts.filter(p => isOwnedByTarget(p, targetUser));
    renderPosts(posts);
  }

  function meKeyFromUser(u){
    return norm(u?.email || u?.username || u?.id || u?._id || 'guest');
  }

  function pickMyFavIds(meKey){
    const ids = [];
    for(let i=0;i<localStorage.length;i++){
      const k = localStorage.key(i);
      // æ”¶è—é”®çš„æ ¼å¼ä¸ post.html ä¿æŒä¸€è‡´ï¼šfaved:${meKey}:${postId}
      if(k && k.startsWith(`faved:${meKey}:`)){
        const postId = k.split(':').pop();
        if(postId) ids.push(postId);
      }
    }
    // å»é‡
    return Array.from(new Set(ids));
  }

  async function loadMyFavorites(meUser){
    const meKey = meKeyFromUser(meUser);
    const favIds = pickMyFavIds(meKey);
    if(favIds.length === 0){ renderPosts([]); return; }

    // ç®€å•åŠæ³•ï¼šæ‹‰ä¸€éå…¨é‡å¸–å­ï¼Œç„¶åæŒ‰ id è¿‡æ»¤ï¼ˆæ–¹ä¾¿ & æ¥å£æœ€å°‘ï¼‰
    const all = await loadAllPosts();
    const set = new Set(favIds.map(String));
    const list = all.filter(p => set.has(String(p._id || p.id || p.postId)));
    renderPosts(list);
  }

  // ====== é¡µé¢åˆå§‹åŒ– & tab é€»è¾‘ ======
  async function getMe(){
    const tip = $('#profile-tip');
    try{
      const res = await fetch(BASE_URL + '/api/users/me', { credentials:'include' });
      const data = await res.json().catch(()=> ({}));
      if (!res.ok) {
        tip.textContent = data.msg || `æœªç™»å½•ï¼ˆ${res.status}ï¼‰`;
        setButtonToLogin();
        return;
      }
      renderUser(data);

      // é€€å‡ºæŒ‰é’®
      const btn = $('#logoutBtn');
      const cloned = btn.cloneNode(true);
      cloned.textContent = 'é€€å‡ºç™»å½•';
      cloned.title = 'é€€å‡ºç™»å½•';
      cloned.addEventListener('click', doLogout);
      btn.parentNode.replaceChild(cloned, btn);

      // é»˜è®¤æ˜¾ç¤ºâ€œæˆ‘çš„å¸–å­â€
      activateTab('posts');
      loadMyPosts(data);

      // ç»‘å®š tab åˆ‡æ¢
      $('#tabMyPosts').onclick = () => { activateTab('posts'); loadMyPosts(data); };
      $('#tabMyFavs').onclick  = () => { activateTab('favs');  loadMyFavorites(data); };
    }catch(e){
      tip.textContent = 'æ— æ³•è¿æ¥åç«¯ï¼Œè¯·ç¡®è®¤ 3001 ç«¯å£æœåŠ¡å·²å¯åŠ¨';
      setButtonToLogin();
    }
  }

  async function viewOtherProfile(targetEmail){
    const tip = $('#profile-tip');
    try{
      const res = await fetch(`${BASE_URL}/api/users/by-email?email=${encodeURIComponent(targetEmail)}`, { credentials:'include' });
      const data = await res.json().catch(()=> ({}));
      if (!res.ok) {
        tip.textContent = data.msg || `è·å–ç”¨æˆ·å¤±è´¥ï¼ˆ${res.status}ï¼‰`;
        setButtonToBack();
        return;
      }
      renderUser(data, { isOther: true });
      setButtonToBack();

      // æµè§ˆä»–äººä¸»é¡µæ—¶ï¼Œâ€œæˆ‘çš„æ”¶è—â€æ²¡æœ‰æ„ä¹‰ â†’ éšè—æ”¶è— tab
      document.getElementById('tabMyFavs').style.display = 'none';

      activateTab('posts');
      loadMyPosts(data);
      $('#tabMyPosts').onclick = () => { activateTab('posts'); loadMyPosts(data); };
    }catch(e){
      tip.textContent = 'æ— æ³•è¿æ¥åç«¯ï¼Œè¯·ç¡®è®¤ 3001 ç«¯å£æœåŠ¡å·²å¯åŠ¨';
      setButtonToBack();
    }
  }

  async function uploadAvatar(file){
    const tip = $('#profile-tip');
    if (!file) return;
    const fd = new FormData();
    fd.append('avatar', file);
    try{
      const res = await fetch(BASE_URL + '/api/users/me/avatar', {
        method: 'POST', body: fd, credentials: 'include'
      });
      const data = await res.json().catch(()=> ({}));
      if (!res.ok) { tip.textContent = data.msg || `ä¸Šä¼ å¤±è´¥ï¼ˆ${res.status}ï¼‰`; return; }
      toast('å¤´åƒå·²æ›´æ–°');
      const meRes = await fetch(BASE_URL + '/api/users/me', { credentials:'include' });
      if (meRes.ok){
        const me = await meRes.json();
        renderUser(me);
      }
    }catch(e){
      tip.textContent = 'ä¸Šä¼ å¤±è´¥ï¼šæ¥å£ä¸å¯è¾¾';
    }
  }

  // åˆå§‹åŒ–
  window.addEventListener('DOMContentLoaded', async () => {
    await renderSidebarUser();

    $('#avatar-upload').addEventListener('change', (e) => {
      const file = e.target.files && e.target.files[0];
      uploadAvatar(file);
    });

    const targetEmail = (getParam('email') || '').trim().toLowerCase();
    if (targetEmail) {
      viewOtherProfile(targetEmail);
    } else {
      getMe();
    }
  });

  // é¡¶æ â€œæ¶ˆæ¯â€æŒ‰é’®
  (function(){
    function addMsgButton(){
      const header = document.querySelector('.panel-header');
      const logout = document.getElementById('logoutBtn');
      if(!header || !logout) return;
      if(document.getElementById('msgBtn')) return;

      const btn = document.createElement('button');
      btn.className = 'btn';
      btn.id = 'msgBtn';
      btn.textContent = 'æ¶ˆæ¯';
      header.insertBefore(btn, logout);

      const params = new URL(location.href).searchParams;
      const to = (params.get('email') || '').trim();
      btn.addEventListener('click', ()=>{
        const dest = to ? ('messages.html?to=' + encodeURIComponent(to)) : 'messages.html';
        location.href = dest;
      });
    }
    
    // å»¶è¿Ÿæ·»åŠ æ¶ˆæ¯æŒ‰é’®ï¼Œç¡®ä¿åœ¨getMeæ‰§è¡Œåå†æ·»åŠ 
    setTimeout(addMsgButton, 100);
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(addMsgButton, 100);
    });
  })();
</script>

</body>
</html>
