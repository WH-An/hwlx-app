<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æµ·å¤–ç•™å­¦ Â· ä¿é™©å…¬å¸é€‰æ‹©</title>
  <style>
    :root{--bg:#0b0f14; --panel:#ffffff; --text:#0f172a; --muted:#64748b; --accent:#16a34a; --border:#e5e7eb; --shadow:0 10px 30px rgba(0,0,0,.18); --radius:18px;}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:'Microsoft YaHei',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'PingFang SC',sans-serif;
      background:radial-gradient(1200px 600px at 10% -10%,#1f8db8 18%, transparent 60%),
                 radial-gradient(900px 500px at 110% 110%,#2bb8d6 12%, transparent 60%),var(--bg);
      color:#fff;overflow:visible;}
    .container{display:grid;grid-template-columns:220px 1fr;gap:18px;height:100vh;padding:24px}
    .sidebar{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px 16px;color:var(--text);display:flex;flex-direction:column;gap:16px}
    .account-info{display:flex;flex-direction:column;align-items:center;gap:10px;text-decoration:none;color:inherit;border:1px dashed #eef2ff;border-radius:14px;padding:14px;background:#fff}
    .avatar{width:56px;height:56px;border-radius:50%;object-fit:cover}
    .username{font-weight:700}
    .nav-list{list-style:none;margin:6px 0 0;padding:0;display:flex;flex-direction:column;gap:10px}
    .nav-list a{display:flex;align-items:center;gap:10px;text-decoration:none;color:var(--text);border:1px solid var(--border);background:#fafafa;border-radius:12px;padding:10px 14px;transition:.2s}
    .nav-list a:hover{background:#f3f4f6;transform:translateY(-1px)}
    .nav-icon{width:22px;display:inline-flex;justify-content:center}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px;color:var(--text);display:flex;flex-direction:column;gap:14px;height:100%}
    .search-box{display:flex;gap:10px;flex-shrink:0}
    .search-box input{flex:1;padding:10px 14px;border:1px solid var(--border);border-radius:12px;font-size:15px;outline:none}
    .search-box button{padding:10px 16px;border:none;border-radius:12px;background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
    .search-box button:hover{background:#15803d}
    .panel-header{display:flex;align-items:center;gap:12px;flex-shrink:0}
    .panel-title{font-size:18px;font-weight:800;margin:0}
    .panel-header .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;cursor:pointer;border:1px solid var(--border);background:#fff;color:#111827;border-radius:12px;padding:8px 12px;font-weight:700;transition:.2s}
    .btn:hover{background:#f3f4f6}
  </style>
</head>
<body>
  <div class="container">
    <div class="sidebar">
      <a class="account-info" href="profile.html">
        <img src="" alt="å¤´åƒ" class="avatar"><span class="username">æˆ‘çš„è´¦å·</span>
      </a>
      <ul class="nav-list">
        <li><a href="main page.html"><span class="nav-icon">ğŸ </span><span>ä¸»é¡µ</span></a></li>
        <li><a href="life-tips.html"><span class="nav-icon">ğŸ’¡</span><span>ç”Ÿæ´»å°è´´å£«</span></a></li>
        <li><a href="study-guide.html"><span class="nav-icon">ğŸ“š</span><span>å­¦ä¹ æŒ‡å¯¼</span></a></li>
        <li><a href="enrollment-steps.html"><span class="nav-icon">ğŸ“</span><span>å…¥å­¦æ­¥éª¤</span></a></li>
        <li><a href="share.html"><span class="nav-icon">ğŸ”—</span><span>åˆ†äº«</span></a></li>
        <li><a href="fun.html"><span class="nav-icon">ğŸ‰</span><span>å¨±ä¹</span></a></li>
        <li><a href="hospital.html"><span class="nav-icon">ğŸ¥</span><span>åŒ»é™¢</span></a></li>
      </ul>
    </div>

    <div class="panel">
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="æœç´¢ä¿é™©å…¬å¸...">
        <button onclick="alert('è¯·è¾“å…¥å…³é”®è¯åå†æœç´¢')">æœç´¢</button>
      </div>
      <div class="panel-header">
        <h2 class="panel-title">ä¿é™©å…¬å¸</h2>
        <div class="spacer"></div>
        <select id="insuranceSelect" class="btn">
          <option value="">è¯·é€‰æ‹©ä¿é™©å…¬å¸</option>
          <option value="etiqa">Etiqa Family Takaful Berhad</option>
          <option value="great-eastern">Great Eastern Takaful Berhad</option>
          <option value="pacific">The Pacific Insurance Berhad</option>
        </select>
      </div>
    </div>
  </div>

  <script>
    // ç®€å•é€‰æ‹©é€»è¾‘
    document.getElementById('insuranceSelect').addEventListener('change', function() {
      if (this.value) {
        alert("æ‚¨é€‰æ‹©äº†: " + this.options[this.selectedIndex].text);
      }
    });
    // å’Œä½ ä¹‹å‰é¡µé¢ä¸€è‡´çš„æœ€å°ä¾èµ–
  // è‡ªåŠ¨æ£€æµ‹APIåŸºç¡€URL
  const API_BASE = (() => {
    if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
      return 'http://127.0.0.1:3001';
    }
    return ''; // ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ç›¸å¯¹è·¯å¾„
  })();

  // æŠŠç›¸å¯¹è·¯å¾„å¤´åƒè¡¥æˆç»å¯¹è·¯å¾„
  function toAbs(u){
    if(!u) return '';
    if(/^https?:\/\//i.test(u)) return u;
    return u.startsWith('/') ? API_BASE + u : API_BASE + '/' + u;
  }

  // æ¢å¤ï¼šä¼˜å…ˆä»æœåŠ¡å™¨è·å–æœ€æ–°ç”¨æˆ·ä¿¡æ¯ï¼Œå›é€€åˆ° localStorage
  async function hydrateUser(){
    try{
      const avatarEl = document.querySelector('.avatar');
      const nameEl   = document.querySelector('.username');

      // å ä½å¤´åƒ
      const FALLBACK = 'https://raw.githubusercontent.com/WH-An/hwlx-app/2df4e97b395bebb7977074fbb31741f3c35da9a0/assets-task_01k3v2vy06fra8er06x602xnpe-1756476933_img_1.webp';

      // ä¼˜å…ˆä»æœåŠ¡å™¨è·å–æœ€æ–°ç”¨æˆ·ä¿¡æ¯
      try {
        const response = await fetch(API_BASE + '/api/users/me', { 
          credentials: 'include' 
        });
        
        if (response.ok) {
          const user = await response.json();
          const name = user.nickname || user.username || user.displayName || user.name || user.email || 'æˆ‘çš„è´¦å·';
          let avatar = user.avatarPath || user.avatarUrl || user.avatar || '';

          if(avatar && !/^https?:\/\//i.test(avatar)) {
            avatar = toAbs(avatar);
          }

          nameEl.textContent = name;
          nameEl.title = name;
          avatarEl.onerror = ()=>{ avatarEl.src = FALLBACK; };
          avatarEl.src = avatar || FALLBACK;
          avatarEl.alt = name;
          
          // æ›´æ–°æœ¬åœ°å­˜å‚¨
          localStorage.setItem('currentUser', JSON.stringify(user));
          return;
        }
      } catch (e) {
        console.warn('ä»æœåŠ¡å™¨è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨:', e);
      }

      // å¦‚æœæœåŠ¡å™¨è·å–å¤±è´¥ï¼Œå›é€€åˆ°æœ¬åœ°å­˜å‚¨
      const raw = localStorage.getItem('currentUser')
                || localStorage.getItem('user')
                || localStorage.getItem('USER')
                || localStorage.getItem('auth_user');

      if(!raw){
        nameEl.textContent = 'æˆ‘çš„è´¦å·';
        avatarEl.src = FALLBACK;
        return;
      }

      const u = JSON.parse(raw) || {};
      const name = u.nickname || u.username || u.displayName || u.name || u.email || 'æˆ‘çš„è´¦å·';
      let avatar = u.avatarPath || u.avatarUrl || u.avatar || '';

      if(avatar && !/^https?:\/\//i.test(avatar)) {
        avatar = toAbs(avatar);
      }

      nameEl.textContent = name;
      nameEl.title = name;
      avatarEl.onerror = ()=>{ avatarEl.src = FALLBACK; };
      avatarEl.src = avatar || FALLBACK;
      avatarEl.alt = name;
    }catch(e){
      console.error('ç”¨æˆ·ä¿¡æ¯æ¸²æŸ“å¤±è´¥:', e);
      // å‡ºé”™ä¹Ÿç»™ä¸ªå…œåº•
      const avatarEl = document.querySelector('.avatar');
      const nameEl   = document.querySelector('.username');
      nameEl.textContent = 'æˆ‘çš„è´¦å·';
      avatarEl.src = FALLBACK;
    }
  }

  // é¡µé¢å°±ç»ªåæ‰§è¡Œ
  window.addEventListener('DOMContentLoaded', () => {
    hydrateUser();
  });
  </script>
</body>
</html>
