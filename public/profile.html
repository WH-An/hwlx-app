<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>个人主页</title>
  <!-- 移动端优化CSS -->
  <link rel="stylesheet" href="mobile-optimization.css">
  <!-- 预加载关键资源 -->
  <link rel="preload" href="mobile-optimization.css" as="style">
  
  <style>
    :root{ 
      --bg:#0b0f14; 
      --panel:#ffffff; 
      --text:#0f172a; 
      --muted:#64748b; 
      --accent:#16a34a; 
      --border:#e5e7eb; 
      --shadow:0 10px 30px rgba(0,0,0,.18); 
      --radius:18px;
      --mobile-nav-height: 70px;
      --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0;font-family:'Microsoft YaHei',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'PingFang SC',sans-serif;
      background:radial-gradient(1200px 600px at 10% -10%,#1f8db8 18%, transparent 60%), radial-gradient(900px 500px at 110% 110%,#2bb8d6 12%, transparent 60%), var(--bg);
      color:#fff; overflow:visible;
    }
    .container{display:grid; grid-template-columns:220px 1fr; gap:18px; height:100vh; padding:24px;}
    .sidebar{background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:20px 16px; color:var(--text); display:flex; flex-direction:column; gap:16px}
    .account-info{display:flex; flex-direction:column; align-items:center; gap:10px; text-decoration:none; color:inherit; border:1px dashed #eef2ff; border-radius:14px; padding:14px; background:#fff}
    .avatar{width:56px;height:56px;border-radius:50%;object-fit:cover}
    .username{font-weight:700}
    .nav-list{list-style:none;margin:6px 0 0;padding:0;display:flex;flex-direction:column;gap:10px}
    .nav-list a{display:flex;align-items:center;gap:10px;text-decoration:none;color:var(--text);border:1px solid var(--border);background:#fafafa;border-radius:12px;padding:10px 14px;transition:.2s}
    .nav-list a:hover{background:#f3f4f6;transform:translateY(-1px)}
    .nav-icon{width:22px;display:inline-flex;justify-content:center}

    .panel{background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:18px; color:var(--text); display:flex; flex-direction:column; gap:14px; height:100%; overflow-y:auto}
    .panel-header{display:flex;align-items:center;gap:12px;flex-shrink:0}
    .panel-title{font-size:18px;font-weight:800;margin:0}
    .panel-header .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;cursor:pointer;border:1px solid var(--border);background:#fff;color:#111827;border-radius:12px;padding:8px 12px;font-weight:700;transition:.2s}
    .btn:hover{background:#f3f4f6}
    
    .btn.primary{background:var(--accent); color:#fff; border-color:var(--accent)}

    .card{
      display:grid;
      grid-template-columns:140px 1fr;
      gap:24px;
      align-items:center;
      background:#fff;
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:24px;
      box-shadow:var(--shadow);
    }
    
    .big-avatar{
      width:140px;
      height:140px;
      border-radius:50%;
      object-fit:cover;
      border: 4px solid #fff;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      transition: var(--transition);
    }
    
    .big-avatar:hover {
      transform: scale(1.05);
      box-shadow: 0 12px 32px rgba(0,0,0,0.2);
    }
    
    .row{
      display:flex;
      gap:16px;
      align-items:center;
      flex-wrap:wrap;
      margin-top: 16px;
    }
    
    .muted{
      color:#64748b;
      font-size:14px;
    }
    
    .tip{
      min-height:20px;
      color:#d33;
      font-size: 14px;
      margin-top: 12px;
      padding: 8px 12px;
      background: #fef2f2;
      border-radius: 8px;
    }
    
    .file-label.btn{
      display:inline-flex;
      background:var(--accent);
      color:#fff;
      border:none;
      padding:10px 18px;
      border-radius:12px;
      font-weight:600;
    }

    .headline{
      display:flex;
      align-items:baseline;
      gap:16px;
      flex-wrap:wrap;
      margin-bottom: 16px;
    }
    
    .headline .name{
      font-size:28px;
      font-weight:800;
      color:var(--text);
    }
    
    .headline .email{
      font-size:14px;
      color:var(--muted);
      padding:8px 16px;
      border:1px solid var(--border);
      border-radius:999px;
      background:var(--panel);
    }

    .info-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:16px;
      margin-top:16px
    }
    
    @media (max-width:680px){ 
      .container{grid-template-columns:1fr} 
      .info-grid{grid-template-columns:1fr} 
    }

    /* 移动端底部导航 */
    .mobile-nav {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--panel);
      border-top: 1px solid var(--border);
      z-index: 1000;
      padding: 8px 0;
    }

    .mobile-nav-list {
      display: flex;
      justify-content: space-around;
      list-style: none;
      margin: 0;
      padding: 0;
    }

    .mobile-nav-item {
      flex: 1;
      text-align: center;
    }

    .mobile-nav-link {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      text-decoration: none;
      color: var(--text);
      padding: 8px 4px;
      font-size: 12px;
      transition: 0.2s color;
    }

    .mobile-nav-link:hover,
    .mobile-nav-link.active {
      color: var(--accent);
    }

    .mobile-nav-icon {
      font-size: 20px;
      margin-bottom: 2px;
    }

    /* 消息按键样式 */
    #chatFab{ 
      position:fixed; 
      left:16px; 
      bottom:calc(var(--mobile-nav-height) + 16px); 
      width:48px; 
      height:48px; 
      border-radius:9999px; 
      display:flex; 
      align-items:center; 
      justify-content:center; 
      background:#0f172a; 
      color:#fff; 
      border:1px solid rgba(255,255,255,.15); 
      box-shadow:0 10px 24px rgba(0,0,0,.28); 
      cursor:pointer; 
      user-select:none; 
      z-index:9999; 
      transition: transform .15s, box-shadow .15s, opacity .2s 
    }
    
    #chatFab:hover{ 
      transform: translateY(-1px); 
      box-shadow: 0 14px 28px rgba(0,0,0,.32) 
    }
    
    #chatFab:active{ 
      transform: translateY(0); 
      box-shadow: 0 8px 18px rgba(0,0,0,.26) 
    }
    
    #chatFab .badge{ 
      position:absolute; 
      right:-2px; 
      top:-2px; 
      min-width:18px; 
      height:18px; 
      padding:0 5px; 
      display:none; 
      align-items:center; 
      justify-content:center; 
      background:var(--accent); 
      color:#fff; 
      border-radius:9999px; 
      font-size:11px; 
      line-height:18px; 
      box-shadow:0 2px 6px rgba(0,0,0,.18); 
      font-weight: bold; 
      z-index: 10000 
    }
    
    @media (max-width:480px){ 
      #chatFab{ 
        left:12px; 
        bottom:calc(var(--mobile-nav-height) + 12px); 
        width:44px; 
        height:44px 
      } 
    }

    /* 移动端响应式优化 */
    @media (max-width: 960px) {
      .container {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
        padding: 16px;
        padding-bottom: calc(var(--mobile-nav-height) + 20px);
      }
      
      .sidebar {
        display: none;
      }
      
      .panel {
        padding: 16px;
        border-radius: 16px;
      }
      
      .panel-title {
        font-size: 20px;
      }
      
      .mobile-nav {
        display: block;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: 12px;
        padding-bottom: calc(var(--mobile-nav-height) + 16px);
      }
      
      .panel {
        padding: 12px;
        border-radius: 12px;
      }
      
      .card {
        grid-template-columns: 1fr;
        text-align: center;
        gap: 16px;
      }
      
      .big-avatar {
        width: 100px;
        height: 100px;
        margin: 0 auto;
      }
      
      .info-grid {
        grid-template-columns: 1fr;
      }
      
      .mobile-nav {
        height: var(--mobile-nav-height);
      }
      
      .mobile-nav-link {
        font-size: 11px;
      }
      
      .mobile-nav-icon {
        font-size: 18px;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: 12px;
        padding-bottom: calc(var(--mobile-nav-height) + 16px);
      }
      
      .panel {
        padding: 12px;
        border-radius: 12px;
      }
      
      .card {
        grid-template-columns: 1fr;
        text-align: center;
        gap: 16px;
      }
      
      .big-avatar {
        width: 100px;
        height: 100px;
        margin: 0 auto;
      }
      
      .info-grid {
        grid-template-columns: 1fr;
      }
    }

    .info-item{
      display:flex;
      align-items:center;
      gap:12px;
      border:1px solid var(--border);
      padding:16px;
      border-radius:16px;
      background:#f8fafc;
    }
    
    .info-item .icon{
      width:28px;
      text-align:center;
      font-size:20px;
      color:var(--accent);
    }
    
    .info-item .label{
      color:#6b7280;
      font-size:13px;
      font-weight:500;
    }
    
    .info-item .value{
      color:#111827;
      font-weight:700;
      font-size: 15px;
    }

    .id-row{
      display:flex;
      gap:12px;
      align-items:center;
    }
    
    .mini-btn{
      border:1px solid var(--border);
      background: var(--gradient-accent);
      color: #fff;
      border-radius:999px;
      padding:6px 12px;
      cursor:pointer;
      font-size:12px;
      font-weight: 600;
      transition: var(--transition);
      border: none;
    }
    
    .mini-btn:hover{
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(79, 172, 254, 0.4);
    }

    /* 顶部行：我的帖子 / 我的收藏 切换 */
    .section-bar{
      display:flex;
      align-items:center;
      gap:16px;
      margin-top:20px;
      padding: 20px;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-radius: 16px;
      border: 1px solid var(--border);
    }
    
    .section-title{
      font-size:20px;
      font-weight:800;
      margin:0;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    @media (max-width: 960px) {
      .section-bar {
        margin-top: 16px;
        padding: 16px;
        border-radius: 14px;
        gap: 12px;
      }
      
      .section-title {
        font-size: 18px;
      }
    }
    
    @media (max-width: 640px) {
      .section-bar {
        margin-top: 12px;
        padding: 12px;
        border-radius: 12px;
        gap: 10px;
        flex-direction: column;
        align-items: flex-start;
      }
      
      .section-title {
        font-size: 16px;
      }
    }
    
    .tabs{
      display:flex;
      gap:8px;
      align-items:center;
      margin-bottom: 20px;
    }
    
    .tab{
      border:1px solid var(--border);
      background:#fff;
      border-radius:8px;
      padding:10px 20px;
      cursor:pointer;
      font-size:14px;
      font-weight: 600;
      transition: 0.2s;
      color: var(--muted);
    }
    
    .tab:hover {
      background: #f8fafc;
      color: var(--text);
    }
    
    .tab.active{
      background: var(--accent);
      color:#fff;
      border-color: var(--accent);
    }
    
    @media (max-width: 960px) {
      .tabs {
        gap: 6px;
        margin-bottom: 16px;
      }
      
      .tab {
        padding: 8px 16px;
        font-size: 13px;
      }
    }
    
    @media (max-width: 640px) {
      .tabs {
        gap: 4px;
        margin-bottom: 12px;
      }
      
      .tab {
        padding: 6px 12px;
        font-size: 12px;
        border-radius: 6px;
      }
    }

    /* Masonry 布局与卡片 */
    .posts-masonry{
      column-count:3; 
      column-gap:20px;
      margin-top: 20px;
    }
    
    @media (max-width:1200px){ 
      .posts-masonry{ column-count:2 } 
    }
    
    @media (max-width:960px){ 
      .posts-masonry{ 
        column-count:1;
        column-gap: 16px;
        margin-top: 16px;
      } 
    }
    
    @media (max-width:640px){  
      .posts-masonry{ 
        column-count:1;
        column-gap: 12px;
        margin-top: 12px;
      } 
    }

    .post-card{
      position:relative; 
      display:inline-block; 
      width:100%;
      margin:0 0 20px; 
      border:1px solid var(--border); 
      background:#fff;
      border-radius:20px; 
      overflow:hidden; 
      box-shadow: var(--shadow-card);
      padding-bottom:60px; 
      break-inside:avoid; 
      -webkit-column-break-inside:avoid; 
      page-break-inside:avoid;
      cursor:pointer;
      transition: var(--transition);
    }
    
    @media (max-width: 960px) {
      .post-card {
        margin: 0 0 16px;
        border-radius: 16px;
        padding-bottom: 50px;
      }
    }
    
    @media (max-width: 640px) {
      .post-card {
        margin: 0 0 12px;
        border-radius: 12px;
        padding-bottom: 45px;
      }
    }
    
    .post-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-hover);
      border-color: var(--accent);
    }
    
    .post-card img{ 
      width:100%; 
      display:block; 
      aspect-ratio:4/5; 
      object-fit:cover;
      transition: var(--transition);
    }
    
    @media (max-width: 960px) {
      .post-card img {
        aspect-ratio: 3/4;
      }
    }
    
    @media (max-width: 640px) {
      .post-card img {
        aspect-ratio: 1/1;
      }
    }
    
    .post-card:hover img {
      transform: scale(1.05);
    }
    
    /* 移动端触摸优化 */
    @media (hover: none) and (pointer: coarse) {
      .post-card:hover {
        transform: none;
        box-shadow: var(--shadow-card);
        border-color: var(--border);
      }
      
      .post-card:hover img {
        transform: none;
      }
      
      .post-card:active {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border-color: var(--accent);
      }
      
      .post-card:active img {
        transform: scale(1.02);
      }
    }
    
    /* 空状态移动端优化 */
    .empty-state-mobile {
      transition: all 0.3s ease;
    }
    
    @media (max-width: 960px) {
      .empty-state-mobile {
        padding: 32px 16px !important;
        margin: 16px 0 !important;
        border-radius: 10px !important;
      }
      
      .empty-state-mobile > div:first-child {
        font-size: 40px !important;
        margin-bottom: 12px !important;
      }
      
      .empty-state-mobile > div:nth-child(2) {
        font-size: 15px !important;
        margin-bottom: 6px !important;
      }
      
      .empty-state-mobile > div:nth-child(3) {
        font-size: 12px !important;
      }
    }
    
    @media (max-width: 640px) {
      .empty-state-mobile {
        padding: 24px 12px !important;
        margin: 12px 0 !important;
        border-radius: 8px !important;
      }
      
      .empty-state-mobile > div:first-child {
        font-size: 36px !important;
        margin-bottom: 10px !important;
      }
      
      .empty-state-mobile > div:nth-child(2) {
        font-size: 14px !important;
        margin-bottom: 5px !important;
      }
      
      .empty-state-mobile > div:nth-child(3) {
        font-size: 11px !important;
      }
    }
    
    .post-card-text{ 
      padding:16px 20px; 
      color:#374151; 
      line-height:1.6;
      font-size: 15px;
      font-weight: 500;
    }
    
    @media (max-width: 960px) {
      .post-card-text {
        padding: 14px 16px;
        font-size: 14px;
        line-height: 1.5;
      }
    }
    
    @media (max-width: 640px) {
      .post-card-text {
        padding: 12px 14px;
        font-size: 13px;
        line-height: 1.4;
      }
    }

    .post-author-badge{
      position:absolute; 
      right:16px; 
      bottom:16px; 
      display:flex; 
      align-items:center; 
      gap:10px;
      background:rgba(255,255,255,.95); 
      border:1px solid var(--border);
      padding:10px 12px; 
      border-radius:999px; 
      box-shadow:0 8px 24px rgba(0,0,0,.15); 
      max-width:80%;
      backdrop-filter: blur(10px);
    }
    
    @media (max-width: 960px) {
      .post-author-badge {
        right: 12px;
        bottom: 12px;
        padding: 8px 10px;
        gap: 8px;
        max-width: 85%;
      }
    }
    
    @media (max-width: 640px) {
      .post-author-badge {
        right: 10px;
        bottom: 10px;
        padding: 6px 8px;
        gap: 6px;
        max-width: 90%;
      }
    }
    
    .post-author-badge img{ 
      width:24px; 
      height:24px; 
      border-radius:50%; 
      object-fit:cover;
      border: 2px solid #fff;
    }
    
    .post-author-badge .name{ 
      font-size:13px; 
      color:#111827; 
      white-space:nowrap; 
      overflow:hidden; 
      text-overflow:ellipsis; 
      max-width:150px;
      font-weight: 600;
    }
    
    @media (max-width: 960px) {
      .post-author-badge img {
        width: 22px;
        height: 22px;
        border-width: 1.5px;
      }
      
      .post-author-badge .name {
        font-size: 12px;
        max-width: 120px;
      }
    }
    
    @media (max-width: 640px) {
      .post-author-badge img {
        width: 20px;
        height: 20px;
        border-width: 1px;
      }
      
      .post-author-badge .name {
        font-size: 11px;
        max-width: 100px;
      }
    }

    /* 左上角导航按键 */
    .top-nav-button{
      display:none;
      position:fixed;
      top:24px;
      left:24px;
      z-index:1001;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:16px;
      padding:16px;
      cursor:pointer;
      box-shadow:var(--shadow);
      width:56px;
      height:56px;
      display:flex;
      align-items:center;
      justify-content:center;
      transition: var(--transition);
      backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, 0.95);
    }
    
    .top-nav-button:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }

    .top-nav-button .nav-icon{
      font-size:24px;
      color:var(--text);
    }
    
    .top-nav-button:active{transform:translateY(0); box-shadow:0 8px 18px rgba(0,0,0,.26)}
    
    /* 消息按键样式 - 与其他功能页面保持一致 */
    #chatFab{ 
      position:fixed; 
      left:16px; 
      bottom:calc(var(--mobile-nav-height) + 16px); 
      width:48px; 
      height:48px; 
      border-radius:9999px; 
      display:flex; 
      align-items:center; 
      justify-content:center; 
      background:#0f172a; 
      color:#fff; 
      border:1px solid rgba(255,255,255,.15); 
      box-shadow:0 10px 24px rgba(0,0,0,.28); 
      cursor:pointer; 
      user-select:none; 
      z-index:9999; 
      transition: transform .15s, box-shadow .15s, opacity .2s 
    }
    
    #chatFab:hover{ 
      transform: translateY(-1px); 
      box-shadow: 0 14px 28px rgba(0,0,0,.32) 
    }
    
    #chatFab:active{ 
      transform: translateY(0); 
      box-shadow: 0 8px 18px rgba(0,0,0,.26) 
    }
    
    /* 顶部导航菜单 */
    .top-nav-menu{
      position:fixed;
      top:0;
      left:-320px;
      width:320px;
      height:100vh;
      background:var(--panel);
      border-right:1px solid var(--border);
      z-index:1000;
      transition:.3s ease;
      overflow-y:auto;
      backdrop-filter: blur(20px);
      background: rgba(255, 255, 255, 0.95);
    }

    .top-nav-menu.active{left:0}
    .top-nav-overlay{
      position:fixed;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:rgba(0,0,0,.5);
      z-index:999;
      opacity:0;
      visibility:hidden;
      transition:.3s ease;
      backdrop-filter: blur(5px);
    }

    .top-nav-overlay.active{opacity:1;visibility:visible}
    
    .nav-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:24px;
      border-bottom:2px solid var(--border);
      background: var(--gradient-primary);
      color: #fff;
    }

    .nav-title{
      font-size:20px;
      font-weight:700;
      color:#fff;
    }
    
    .close-btn{
      background:none;
      border:none;
      font-size:28px;
      color:#fff;
      cursor:pointer;
      padding:0;
      width:40px;
      height:40px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:8px;
      transition:.2s;
      background: rgba(255, 255, 255, 0.2);
    }

    .close-btn:hover{
      background:rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }
    
    .top-nav-menu .nav-list{
      list-style:none;
      margin:0;
      padding:24px
    }
    
    .top-nav-menu .nav-list li{
      margin-bottom:12px
    }
    
    .top-nav-menu .nav-list a{
      display:flex;
      align-items:center;
      gap:16px;
      text-decoration:none;
      color:var(--text);
      padding:16px;
      border-radius:12px;
      transition:.2s;
      border: 1px solid transparent;
    }

    .top-nav-menu .nav-list a:hover{
      background:var(--border);
      border-color: var(--accent);
      transform: translateX(8px);
    }
    
    .top-nav-menu .nav-list .nav-icon{
      font-size:20px;
      width:28px;
      text-align:center
    }

    /* 移动端响应式优化 */
    @media (max-width: 960px) {
      .container {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
        padding: 16px;
        padding-bottom: calc(var(--mobile-nav-height) + 20px);
      }
      
      .sidebar {
        display: none;
      }
      
      .panel {
        padding: 20px;
        border-radius: 20px;
      }
      
      .panel-title {
        font-size: 22px;
      }
      
      .card {
        grid-template-columns: 1fr;
        text-align: center;
        gap: 20px;
      }
      
      .big-avatar {
        margin: 0 auto;
        width: 120px;
        height: 120px;
      }
      
      .headline {
        justify-content: center;
      }
      
      .section-bar {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
      }
      
      .tabs {
        width: 100%;
        justify-content: space-between;
      }
      
      .tab {
        flex: 1;
        text-align: center;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: 12px;
        padding-bottom: calc(var(--mobile-nav-height) + 16px);
      }
      
      .panel {
        padding: 16px;
        border-radius: 16px;
      }
      
      .panel-title {
        font-size: 20px;
      }
      
      .card {
        padding: 20px;
        border-radius: 16px;
        margin-bottom: 16px;
      }
      
      .card-text {
        padding: 16px;
        font-size: 14px;
      }
      
      .info-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .info-item {
        padding: 14px;
        border-radius: 14px;
      }
      
      .headline .name {
        font-size: 24px;
      }
      
      .headline .email {
        font-size: 12px;
        padding: 6px 12px;
      }
    }
    
    /* 加载动画 */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* 空状态样式 */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }
    
    .empty-state .icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    .empty-state .title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text);
    }
    
    .empty-state .description {
      font-size: 14px;
      line-height: 1.5;
    }
    
    /* 滚动条美化 */
    ::-webkit-scrollbar {
      width: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--gradient-primary);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--gradient-secondary);
    }
    
    /* 焦点状态优化 */
    .btn:focus,
    .tab:focus,
    .nav-list a:focus {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }
    
    /* 选择文本样式 */
    ::selection {
      background: var(--gradient-accent);
      color: #fff;
    }
    
    /* 打印样式 */
    @media print {
      .sidebar,
      .top-nav-button,
      .mobile-nav {
        display: none !important;
      }
      
      .container {
        grid-template-columns: 1fr;
        padding: 0;
      }
      
      .panel {
        box-shadow: none;
        border: none;
      }
    }
  </style>
</head>
<body>
  


  <div class="container">
    <div class="sidebar">
      <a class="account-info" href="profile.html">
        <img src="https://raw.githubusercontent.com/WH-An/hwlx-app/2df4e97b395bebb7977074fbb31741f3c35da9a0/assets-task_01k3v2vy06fra8er06x602xnpe-1756476933_img_1.webp" alt="头像" class="avatar">
        <span class="username">我的账号</span>
      </a>
      <ul class="nav-list">
        <li><a href="main page.html"><span class="nav-icon">🏠</span><span>主页</span></a></li>
        <li><a href="life-tips.html"><span class="nav-icon">💡</span><span>生活小贴士</span></a></li>
        <li><a href="study-guide.html"><span class="nav-icon">📚</span><span>学习指导</span></a></li>
        <li><a href="enrollment-steps.html"><span class="nav-icon">📝</span><span>入学步骤</span></a></li>
        <li><a href="share.html"><span class="nav-icon">🔗</span><span>分享</span></a></li>
        <li><a href="fun.html"><span class="nav-icon">🎉</span><span>娱乐</span></a></li>
        <li><a href="hospital.html"><span class="nav-icon">🏥</span><span>医院</span></a></li>
      </ul>
    </div>

    <!-- 移动端底部导航 -->
    <nav class="mobile-nav">
      <ul class="mobile-nav-list">
        <li class="mobile-nav-item">
          <a href="main page.html" class="mobile-nav-link">
            <span class="mobile-nav-icon">🏠</span>
            <span>主页</span>
          </a>
        </li>
        <li class="mobile-nav-item">
          <a href="life-tips.html" class="mobile-nav-link">
            <span class="mobile-nav-icon">💡</span>
            <span>生活</span>
          </a>
        </li>
        <li class="mobile-nav-item">
          <a href="study-guide.html" class="mobile-nav-link">
            <span class="mobile-nav-icon">📚</span>
            <span>学习</span>
          </a>
        </li>
        <li class="mobile-nav-item">
          <a href="profile.html" class="mobile-nav-link active">
            <span class="mobile-nav-icon">👤</span>
            <span>个人</span>
          </a>
        </li>
        <li class="mobile-nav-item">
          <a href="enrollment-steps.html" class="mobile-nav-link">
            <span class="mobile-nav-icon">📝</span>
            <span>入学</span>
          </a>
        </li>
        <li class="mobile-nav-item">
          <a href="share.html" class="mobile-nav-link">
            <span class="mobile-nav-icon">🔗</span>
            <span>分享</span>
          </a>
        </li>
        <li class="mobile-nav-item">
          <a href="fun.html" class="mobile-nav-link">
            <span class="mobile-nav-icon">🎉</span>
            <span>娱乐</span>
          </a>
        </li>
        <li class="mobile-nav-item">
          <a href="hospital.html" class="mobile-nav-link">
            <span class="mobile-nav-icon">🏥</span>
            <span>医院</span>
          </a>
        </li>
      </ul>
    </nav>

    <!-- 消息按键 -->
    <div id="chatFab" onclick="window.location.href='messages.html'">
      <span class="chat-icon">💬</span>
      <div class="badge" id="unreadBadge">0</div>
    </div>

    <div class="panel">
      <div class="panel-header">
        <h2 class="panel-title">👤 个人主页</h2>
        <div class="spacer"></div>
        <button id="logoutBtn" class="btn primary">退出登录</button>
      </div>
      
      <!-- 资料卡 -->
      <div class="card">
        <img id="profileAvatar" class="big-avatar" src="" alt="头像">
        <div>
          <div class="headline">
            <span id="profileName" class="name">——</span>
            <span id="profileEmail" class="email">——</span>
          </div>

          <div class="info-grid" style="margin-top:8px">
            <div class="info-item">
              <span class="icon">📍</span>
              <div>
                <div class="label">区域</div>
                <div id="profileArea" class="value">未填写</div>
              </div>
            </div>
            <div class="info-item">
              <span class="icon">🆔</span>
              <div>
                <div class="label">唯一 ID</div>
                <div class="id-row">
                  <span id="profileId" class="value">—</span>
                  <button id="copyIdBtn" class="mini-btn" title="复制ID">复制</button>
                </div>
              </div>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <label class="file-label btn" for="avatar-upload">更换头像</label>
            <input id="avatar-upload" type="file" accept="image/*" style="display:none">
            <span id="upload-hint" class="muted">支持 JPG/PNG</span>
          </div>

          <div id="profile-tip" class="tip"></div>
        </div>
      </div>

      <!-- 标签页切换：我的帖子 / 我的收藏 -->
      <div class="tabs">
        <button id="tabMyPosts" class="tab active">我的帖子</button>
        <button id="tabMyFavs" class="tab">我的收藏</button>
      </div>

      <!-- 列表容器（共用） -->
      <div id="postList" class="posts-masonry">
        <!-- 内容将在这里动态加载 -->
      </div>
    </div>
  </div>

  <!-- 移动端底部导航 -->
  <nav class="mobile-nav">
    <ul class="mobile-nav-list">
      <li class="mobile-nav-item">
        <a href="main page.html" class="mobile-nav-link">
          <span class="mobile-nav-icon">🏠</span>
          <span>主页</span>
        </a>
      </li>
      <li class="mobile-nav-item">
        <a href="life-tips.html" class="mobile-nav-link">
          <span class="mobile-nav-icon">💡</span>
          <span>生活</span>
        </a>
      </li>
      <li class="mobile-nav-item">
        <a href="study-guide.html" class="mobile-nav-link">
          <span class="mobile-nav-icon">📚</span>
          <span>学习</span>
        </a>
      </li>
      <li class="mobile-nav-item">
        <a href="profile.html" class="mobile-nav-link active">
          <span class="mobile-nav-icon">👤</span>
          <span>个人</span>
        </a>
      </li>
      <li class="mobile-nav-item">
        <a href="enrollment-steps.html" class="mobile-nav-link">
          <span class="mobile-nav-icon">📝</span>
          <span>入学</span>
        </a>
      </li>
      <li class="mobile-nav-item">
        <a href="share.html" class="mobile-nav-link">
          <span class="mobile-nav-icon">🔗</span>
          <span>分享</span>
        </a>
      </li>
      <li class="mobile-nav-item">
        <a href="fun.html" class="mobile-nav-link">
          <span class="mobile-nav-icon">🎉</span>
          <span>娱乐</span>
        </a>
      </li>
      <li class="mobile-nav-item">
        <a href="hospital.html" class="mobile-nav-link">
          <span class="mobile-nav-icon">🏥</span>
          <span>医院</span>
        </a>
      </li>
    </ul>
  </nav>

  <!-- 黑色消息按钮 -->
  <div id="chatFab" onclick="window.location.href='messages.html'">
    <span>💬</span>
    <div class="badge">0</div>
  </div>

  <script>
    // 自动检测API基础URL
    const BASE_URL = (() => {
      if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
        return 'http://127.0.0.1:3001';
      }
      return ''; // 生产环境使用相对路径
    })();
    const FALLBACK = 'https://raw.githubusercontent.com/WH-An/hwlx-app/2df4e97b395bebb7977074fbb31741f3c35da9a0/assets-task_01k3v2vy06fra8er06x602xnpe-1756476933_img_1.webp';

    const $ = sel => document.querySelector(sel);
    function toAbs(u){ if(!u) return ''; if(/^https?:\/\//i.test(u)) return u; return u.startsWith('/') ? (BASE_URL + u) : (BASE_URL + '/' + u); }
    function getParam(k){ try{ return new URL(location.href).searchParams.get(k); }catch{ return null; } }
    function fmt(v, fallback='未填写'){ return (v===0 || v) ? String(v) : fallback; }
    const norm = s => String(s||'').trim().toLowerCase();

    // tabs 切换工具
    function activateTab(which){
      $('#tabMyPosts').classList.toggle('active', which==='posts');
      $('#tabMyFavs').classList.toggle('active',  which==='favs');
    }

    // 左侧账号卡片
    async function renderSidebarUser(){
      try{
        const avatarEl = document.querySelector('.avatar');
        const nameEl = document.querySelector('.username');
        
        // 优先从服务器获取最新用户信息
        try {
          const response = await fetch(BASE_URL + '/api/users/me', { 
            credentials: 'include' 
          });
          
          if (response.ok) {
            const user = await response.json();
            const name = user.nickname || user.username || user.displayName || user.name || user.email || '我的账号';
            let avatar = user.avatarPath || user.avatarUrl || user.avatar || '';
            if(avatar && !/^https?:\/\//i.test(avatar)) avatar = toAbs(avatar);
            
            nameEl.textContent = name;
            nameEl.title = name;
            avatarEl.onerror = () => { avatarEl.src = FALLBACK; };
            avatarEl.src = avatar || FALLBACK;
            avatarEl.alt = name;
            
            // 更新本地存储
            localStorage.setItem('currentUser', JSON.stringify(user));
            return;
          }
        } catch (e) {
          console.warn('从服务器获取用户信息失败，使用本地存储:', e);
        }

        // 如果服务器获取失败，回退到本地存储
        const raw = localStorage.getItem('currentUser')
              || localStorage.getItem('user')
              || localStorage.getItem('USER')
              || localStorage.getItem('auth_user');
        if(!raw){ nameEl.textContent='我的账号'; avatarEl.src=FALLBACK; return; }
        const u = JSON.parse(raw)||{};
        const name = u.nickname || u.username || u.displayName || u.name || u.email || '我的账号';
        let avatar = u.avatarPath || u.avatarUrl || u.avatar || '';
        if(avatar && !/^https?:\/\//i.test(avatar)) avatar = toAbs(avatar);
        nameEl.textContent = name;
        nameEl.title = name;
        avatarEl.onerror = () => { avatarEl.src = FALLBACK; };
        avatarEl.src = avatar || FALLBACK;
        avatarEl.alt = name;
      }catch(e){
        console.error('渲染侧边栏用户信息失败:', e);
        const avatarEl = document.querySelector('.avatar');
        const nameEl = document.querySelector('.username');
        if(nameEl) {
          nameEl.textContent = '我的账号';
          nameEl.title = '我的账号';
        }
        if(avatarEl) {
          avatarEl.src = FALLBACK;
          avatarEl.alt = '我的头像';
        }
      }
    }

    // 渲染主卡片
    function renderUser(u, opts = {}){
    const isOther = !!opts.isOther;

    const name  = u.nickname || u.username || u.displayName || u.name || u.email || '——';
    const email = u.email || '——';
    const area  = u.area;
    const uid   = u.id || u._id || '';
    let avatar  = u.avatarPath || u.avatarUrl || u.avatar || '';
    if(avatar && !/^https?:\/\//i.test(avatar)) avatar = toAbs(avatar);

    $('#profileName').textContent = name;
    const emailChip = $('#profileEmail');
    emailChip.textContent = email;
    emailChip.title = email;

    const img = $('#profileAvatar');
    img.onerror = () => { img.src = FALLBACK; };
    img.src = avatar || FALLBACK;
    img.alt = name;

    $('#profileArea').textContent = fmt(area);
    $('#profileId').textContent   = fmt(uid,'—');

    const copyBtn = $('#copyIdBtn');
    copyBtn.onclick = async () => {
      try{ await navigator.clipboard.writeText(String(uid||'')); toast('ID 已复制'); }
      catch{ toast('复制失败'); }
    };

    // ✅ 关键：只有“看自己”时才更新 currentUser / meUser；看别人放到 lastViewedUser
    try{
      if (isOther) {
        localStorage.setItem('lastViewedUser', JSON.stringify(u));
      } else {
        localStorage.setItem('meUser', JSON.stringify(u));
        localStorage.setItem('currentUser', JSON.stringify(u));
      }
    }catch{}
  }

  function toast(text){
    const tip = $('#profile-tip');
    tip.style.color = '#16a34a';
    tip.textContent = text;
    setTimeout(()=>{ tip.textContent=''; tip.style.color='#d33'; }, 1500);
  }

  function setButtonToLogin(){
    const btn = $('#logoutBtn');
    btn.textContent = '登录';
    btn.title = '点击登录';
    btn.classList.add('primary');
    const cloned = btn.cloneNode(true);
    cloned.addEventListener('click', () => { location.href = 'login.html'; });
    btn.parentNode.replaceChild(cloned, btn);

    $('#avatar-upload').disabled = true;
    const lab = document.querySelector('.file-label.btn');
    if (lab) lab.style.display = 'none';
    $('#upload-hint').textContent = '请登录后可更换头像';
  }

  function setButtonToBack(){
    const btn = $('#logoutBtn');
    btn.textContent = '返回主页';
    btn.title = '返回主页';
    btn.classList.remove('primary');
    const cloned = btn.cloneNode(true);
    cloned.addEventListener('click', () => { location.href = 'main page.html'; });
    btn.parentNode.replaceChild(cloned, btn);

    $('#avatar-upload').disabled = true;
    const lab = document.querySelector('.file-label.btn');
    if (lab) lab.style.display = 'none';
    $('#upload-hint').textContent = '这是对方的个人主页，头像不可由你修改';
  }

  async function doLogout(){
    try{ await fetch(BASE_URL + '/api/logout', { method:'POST', credentials:'include' }); }catch{}
    // 清除所有本地存储的用户信息
    ['currentUser', 'user', 'USER', 'auth_user', 'tempUser', 'meUser'].forEach(key => {
      localStorage.removeItem(key);
    });
    location.href = 'login.html';
  }

  /* ====== 帖子卡片渲染 ====== */
  function extractAuthor(p){
    const u = p.user || p.author || p.owner || {};
    let name   = (p.authorName || u.nickname || u.username || u.displayName || u.name || p.username || p.email || '').trim();
    let avatar = (p.authorAvatar || u.avatarPath || u.avatarUrl || u.avatar || p.avatar || '').trim();
    if(!name) name='匿名用户';
    if(avatar && !/^https?:\/\//i.test(avatar)) avatar = toAbs(avatar);
    return { name, avatar };
  }

  function renderPosts(list){
    const box = $('#postList');
    box.innerHTML = '';
    (list||[]).forEach(p=>{
      const card = document.createElement('div');
      card.className = 'post-card';

      const pid = p._id || p.id;
      if (pid){
        card.addEventListener('click', ()=>{ location.href = 'post.html?id='+encodeURIComponent(pid); });
        card.style.cursor = 'pointer';
      }

      // 图片 - 只显示第一张
      if(p.images && p.images.length > 0){
        const img = document.createElement('img');
        img.src = toAbs(p.images[0]);
        img.alt = '';
        img.onerror = ()=>{ img.remove(); };
        card.appendChild(img);
      }

      if(p.desc || p.title){
        const t = document.createElement('div');
        t.className = 'post-card-text';
        t.textContent = p.desc || p.title || '';
        card.appendChild(t);
      }

      const {name, avatar} = extractAuthor(p);
      const badge = document.createElement('div');
      badge.className = 'post-author-badge';
      const ava = document.createElement('img');
      const FALL = 'data:image/svg+xml;utf8,'+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="100%" height="100%" fill="#e5e7eb"/><circle cx="32" cy="26" r="12" fill="#cbd5e1"/><rect x="12" y="44" width="40" height="14" rx="7" fill="#cbd5e1"/></svg>');
      ava.onerror = ()=>{ ava.src = FALL; };
      ava.src = avatar || FALL;
      ava.alt = name;
      const nm = document.createElement('span');
      nm.className = 'name';
      nm.textContent = name;
      badge.appendChild(ava);
      badge.appendChild(nm);
      card.appendChild(badge);

      box.appendChild(card);
    });

    if(!list || list.length===0){
      const empty=document.createElement('div');
      empty.className='empty-state-mobile';
      empty.style.cssText=`
        padding: 40px 20px;
        text-align: center;
        color: var(--muted);
        font-size: 14px;
        background: #f8fafc;
        border-radius: 12px;
        margin: 20px 0;
        border: 1px dashed var(--border);
      `;
      empty.innerHTML=`
        <div style="font-size: 48px; margin-bottom: 16px;">📝</div>
        <div style="font-weight: 600; margin-bottom: 8px; color: var(--text);">暂无内容</div>
        <div style="font-size: 13px;">您还没有发布任何帖子或收藏任何内容</div>
      `;
      box.appendChild(empty);
    }
  }

  /* ====== 数据加载：我的帖子 / 我的收藏 ====== */

  // 判断帖子属于目标用户
  function isOwnedByTarget(post, target){
    const targetEmails = [target?.email].map(norm).filter(Boolean);
    const targetIds = [target?.id, target?._id, target?.uid].map(norm).filter(Boolean);

    const postEmails = [
      post.authorEmail, post.email,
      post.user && post.user.email,
      post.owner && post.owner.email,
      post.author && post.author.email
    ].map(norm).filter(Boolean);

    const postIds = [
      post.authorId, post.userId, post.uid, post._userId,
      post.createdBy, post.created_by,
      post.user && (post.user.id || post.user._id),
      post.owner && (post.owner.id || post.owner._id),
      post.author && (post.author.id || post.author._id)
    ].map(norm).filter(Boolean);

    const emailHit = targetEmails.length && postEmails.some(e => targetEmails.includes(e));
    const idHit    = targetIds.length && postIds.some(i => targetIds.includes(i));
    return emailHit || idHit;
  }

  async function loadAllPosts(){
    try{
      const r = await fetch(`${BASE_URL}/api/posts`, { credentials:'include' });
      const arr = await r.json();
      return Array.isArray(arr) ? arr : [];
    }catch{ return []; }
  }

  async function loadMyPosts(targetUser){
    let posts = await loadAllPosts();
    posts = posts.filter(p => isOwnedByTarget(p, targetUser));
    renderPosts(posts);
  }

  function meKeyFromUser(u){
    return norm(u?.email || u?.username || u?.id || u?._id || 'guest');
  }

  function pickMyFavIds(meKey){
    console.log('开始查找收藏的帖子，用户标识:', meKey);
    const ids = [];
    for(let i=0;i<localStorage.length;i++){
      const k = localStorage.key(i);
      // 收藏键的格式与 post.html 保持一致：faved:${meKey}:${postId}
      if(k && k.startsWith(`faved:${meKey}:`)){
        const postId = k.split(':').pop();
        if(postId) ids.push(postId);
      }
    }
    console.log('在localStorage中找到的收藏键:', ids);
    // 去重
    const uniqueIds = Array.from(new Set(ids));
    console.log('去重后的收藏ID:', uniqueIds);
    return uniqueIds;
  }

  async function loadMyFavorites(meUser){
    console.log('开始加载我的收藏，用户:', meUser);
    try {
      const meKey = meKeyFromUser(meUser);
      console.log('用户标识:', meKey);
      const favIds = pickMyFavIds(meKey);
      console.log('收藏的帖子ID:', favIds);
      
      if(favIds.length === 0){ 
        console.log('没有收藏的帖子，显示空列表');
        renderPosts([]); 
        return; 
      }

      // 简单办法：拉一遍全量帖子，然后按 id 过滤（方便 & 接口最少）
      console.log('开始加载所有帖子...');
      const all = await loadAllPosts();
      console.log('获取到所有帖子数量:', all.length);
      
      const set = new Set(favIds.map(String));
      const list = all.filter(p => set.has(String(p._id || p.id || p.postId)));
      console.log('过滤后的收藏帖子数量:', list.length);
      
      renderPosts(list);
    } catch (error) {
      console.error('加载我的收藏时出错:', error);
      renderPosts([]);
    }
  }

  // ====== 页面初始化 & tab 逻辑 ======
  async function getMe(){
    const tip = $('#profile-tip');
    try{
      const res = await fetch(BASE_URL + '/api/users/me', { credentials:'include' });
      const data = await res.json().catch(()=> ({}));
      if (!res.ok) {
        tip.textContent = data.msg || `未登录（${res.status}）`;
        setButtonToLogin();
        return;
      }
      renderUser(data);

      // 退出按钮
      const btn = $('#logoutBtn');
      const cloned = btn.cloneNode(true);
      cloned.textContent = '退出登录';
      cloned.title = '退出登录';
      cloned.addEventListener('click', doLogout);
      btn.parentNode.replaceChild(cloned, btn);

      // 默认显示“我的帖子”
      activateTab('posts');
      loadMyPosts(data);

      // 绑定 tab 切换
      $('#tabMyPosts').onclick = () => { activateTab('posts'); loadMyPosts(data); };
      $('#tabMyFavs').onclick  = () => { activateTab('favs');  loadMyFavorites(data); };
    }catch(e){
      tip.textContent = '无法连接后端，请确认 3001 端口服务已启动';
      setButtonToLogin();
    }
  }

  async function viewOtherProfile(targetEmail){
    const tip = $('#profile-tip');
    try{
      const res = await fetch(`${BASE_URL}/api/users/by-email?email=${encodeURIComponent(targetEmail)}`, { credentials:'include' });
      const data = await res.json().catch(()=> ({}));
      if (!res.ok) {
        tip.textContent = data.msg || `获取用户失败（${res.status}）`;
        setButtonToBack();
        return;
      }
      renderUser(data, { isOther: true });
      setButtonToBack();

      // 浏览他人主页时，“我的收藏”没有意义 → 隐藏收藏 tab
      document.getElementById('tabMyFavs').style.display = 'none';

      activateTab('posts');
      loadMyPosts(data);
      $('#tabMyPosts').onclick = () => { activateTab('posts'); loadMyPosts(data); };
    }catch(e){
      tip.textContent = '无法连接后端，请确认 3001 端口服务已启动';
      setButtonToBack();
    }
  }

  async function uploadAvatar(file){
    const tip = $('#profile-tip');
    if (!file) return;
    const fd = new FormData();
    fd.append('avatar', file);
    try{
      const res = await fetch(BASE_URL + '/api/upload/avatar', {
        method: 'POST', body: fd, credentials: 'include'
      });
      const data = await res.json().catch(()=> ({}));
      if (!res.ok) { tip.textContent = data.msg || `上传失败（${res.status}）`; return; }
      toast('头像已更新');
      const meRes = await fetch(BASE_URL + '/api/users/me', { credentials:'include' });
      if (meRes.ok){
        const me = await meRes.json();
        renderUser(me);
      }
    }catch(e){
      tip.textContent = '上传失败：接口不可达';
    }
  }

  // 初始化
  window.addEventListener('DOMContentLoaded', async () => {
    await renderSidebarUser();

    $('#avatar-upload').addEventListener('change', (e) => {
      const file = e.target.files && e.target.files[0];
      uploadAvatar(file);
    });

    const targetEmail = (getParam('email') || '').trim().toLowerCase();
    if (targetEmail) {
      viewOtherProfile(targetEmail);
    } else {
      getMe();
    }
  });

  // 顶栏“消息”按钮
  (function(){
    function addMsgButton(){
      const header = document.querySelector('.panel-header');
      const logout = document.getElementById('logoutBtn');
      if(!header || !logout) return;
      if(document.getElementById('msgBtn')) return;

      const btn = document.createElement('button');
      btn.className = 'btn';
      btn.id = 'msgBtn';
      btn.textContent = '消息';
      header.insertBefore(btn, logout);

      const params = new URL(location.href).searchParams;
      const to = (params.get('email') || '').trim();
      btn.addEventListener('click', ()=>{
        const dest = to ? ('messages.html?to=' + encodeURIComponent(to)) : 'messages.html';
        location.href = dest;
      });
    }
    
    // 延迟添加消息按钮，确保在getMe执行后再添加
    setTimeout(addMsgButton, 100);
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(addMsgButton, 100);
    });
  })();

    // 未读消息功能
    async function getUnreadCount() {
      try {
        const res = await fetch(`${BASE_URL}/api/messages/unread-count`, { 
          credentials: 'include',
          cache: 'no-cache'
        });
        
        if (res.ok) {
          const data = await res.json();
          return data.count || 0;
        }
      } catch (e) {
        console.warn('获取未读消息数量失败:', e);
      }
      
      // 回退到本地存储的未读数量
      try {
        const cached = localStorage.getItem('unreadCount');
        return cached ? parseInt(cached) : 0;
      } catch (e) {
        return 0;
      }
    }

    // 更新未读消息徽章
    async function updateUnreadBadge() {
      const chatFab = document.getElementById('chatFab');
      if (!chatFab) return;
      
      const badge = chatFab.querySelector('.badge');
      if (!badge) return;
      
      try {
        const unreadCount = await getUnreadCount();
        console.log('获取到未读消息数量:', unreadCount);
        
        if (unreadCount > 0) {
          badge.textContent = unreadCount > 99 ? '99+' : unreadCount.toString();
          badge.style.display = 'flex';
          console.log('徽章显示:', badge.textContent);
        } else {
          badge.style.display = 'none';
          console.log('徽章隐藏');
        }
        
        // 缓存未读数量
        try {
          localStorage.setItem('unreadCount', unreadCount.toString());
        } catch (e) {
          console.warn('缓存未读数量失败:', e);
        }
      } catch (error) {
        console.error('更新徽章时出错:', error);
        // 出错时隐藏徽章
        badge.style.display = 'none';
      }
    }

    // 页面加载完成后更新徽章
    document.addEventListener('DOMContentLoaded', () => {
      updateUnreadBadge();
      
      // 每30秒更新一次未读数量
      setInterval(updateUnreadBadge, 30000);
    });

    // 页面获得焦点时更新徽章
    document.addEventListener('focus', updateUnreadBadge);
    window.addEventListener('focus', updateUnreadBadge);
    
    // 添加测试功能 - 在控制台调用 testBadge(number) 来测试徽章
    window.testBadge = function(count) {
      const badge = document.querySelector('#chatFab .badge');
      if (!badge) {
        console.log('未找到徽章元素');
        return;
      }
      
      if (count > 0) {
        badge.textContent = count > 99 ? '99+' : count.toString();
        badge.style.display = 'flex';
        console.log(`测试徽章显示: ${badge.textContent}`);
      } else {
        badge.style.display = 'none';
        console.log('测试徽章隐藏');
      }
    };
    
    console.log('徽章测试功能已加载，使用 testBadge(number) 来测试');
  </script>
</body>
</html>
