<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ä¸ªäººä¸»é¡µ</title>
  <!-- ç§»åŠ¨ç«¯ä¼˜åŒ–CSS -->
  <link rel="stylesheet" href="mobile-optimization.css">
  <!-- é¢„åŠ è½½å…³é”®èµ„æº -->
  <link rel="preload" href="mobile-optimization.css" as="style">
  
  <style>
    :root{ 
      --bg:#0b0f14; 
      --panel:#ffffff; 
      --text:#0f172a; 
      --muted:#64748b; 
      --accent:#16a34a; 
      --border:#e5e7eb; 
      --shadow:0 10px 30px rgba(0,0,0,.18); 
      --radius:18px;
      --mobile-nav-height: 70px;
      --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0;font-family:'Microsoft YaHei',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'PingFang SC',sans-serif;
      background:radial-gradient(1200px 600px at 10% -10%,#1f8db8 18%, transparent 60%), radial-gradient(900px 500px at 110% 110%,#2bb8d6 12%, transparent 60%), var(--bg);
      color:#fff; overflow:visible;
    }
    .container{display:grid; grid-template-columns:220px 1fr; gap:18px; height:100vh; padding:24px;}
    .sidebar{background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:20px 16px; color:var(--text); display:flex; flex-direction:column; gap:16px}
    .account-info{display:flex; flex-direction:column; align-items:center; gap:10px; text-decoration:none; color:inherit; border:1px dashed #eef2ff; border-radius:14px; padding:14px; background:#fff}
    .avatar{width:56px;height:56px;border-radius:50%;object-fit:cover}
    .username{font-weight:700}
    .nav-list{list-style:none;margin:6px 0 0;padding:0;display:flex;flex-direction:column;gap:10px}
    .nav-list a{display:flex;align-items:center;gap:10px;text-decoration:none;color:var(--text);border:1px solid var(--border);background:#fafafa;border-radius:12px;padding:10px 14px;transition:.2s}
    .nav-list a:hover{background:#f3f4f6;transform:translateY(-1px)}
    .nav-icon{width:22px;display:inline-flex;justify-content:center}

    .panel{background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:18px; color:var(--text); display:flex; flex-direction:column; gap:14px; height:100%; overflow-y:auto}
    .panel-header{display:flex;align-items:center;gap:12px;flex-shrink:0}
    .panel-title{font-size:18px;font-weight:800;margin:0}
    .panel-header .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;cursor:pointer;border:1px solid var(--border);background:#fff;color:#111827;border-radius:12px;padding:8px 12px;font-weight:700;transition:.2s}
    .btn:hover{background:#f3f4f6}
    
    .btn.primary{background:var(--accent); color:#fff; border-color:var(--accent)}

    .card{
      display:grid;
      grid-template-columns:140px 1fr;
      gap:24px;
      align-items:center;
      background:#fff;
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:24px;
      box-shadow:var(--shadow);
    }
    
    .big-avatar{
      width:140px;
      height:140px;
      border-radius:50%;
      object-fit:cover;
      border: 4px solid #fff;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      transition: var(--transition);
    }
    
    .big-avatar:hover {
      transform: scale(1.05);
      box-shadow: 0 12px 32px rgba(0,0,0,0.2);
    }
    
    .row{
      display:flex;
      gap:16px;
      align-items:center;
      flex-wrap:wrap;
      margin-top: 16px;
    }
    
    .muted{
      color:#64748b;
      font-size:14px;
    }
    
    .tip{
      min-height:20px;
      color:#d33;
      font-size: 14px;
      margin-top: 12px;
      padding: 8px 12px;
      background: #fef2f2;
      border-radius: 8px;
    }
    
    .file-label.btn{
      display:inline-flex;
      background:var(--accent);
      color:#fff;
      border:none;
      padding:10px 18px;
      border-radius:12px;
      font-weight:600;
    }

    .headline{
      display:flex;
      align-items:baseline;
      gap:16px;
      flex-wrap:wrap;
      margin-bottom: 16px;
    }
    
    .headline .name{
      font-size:28px;
      font-weight:800;
      color:var(--text);
    }
    
    .headline .email{
      font-size:14px;
      color:var(--muted);
      padding:8px 16px;
      border:1px solid var(--border);
      border-radius:999px;
      background:var(--panel);
    }

    .info-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:16px;
      margin-top:16px
    }
    
    @media (max-width:680px){ 
      .container{grid-template-columns:1fr} 
      .info-grid{grid-template-columns:1fr} 
    }

    /* ç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆª */
    .mobile-nav {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--panel);
      border-top: 1px solid var(--border);
      z-index: 1000;
      padding: 8px 0;
    }

    .mobile-nav-list {
      display: flex;
      justify-content: space-around;
      list-style: none;
      margin: 0;
      padding: 0;
    }

    .mobile-nav-item {
      flex: 1;
      text-align: center;
    }

    .mobile-nav-link {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      text-decoration: none;
      color: var(--text);
      padding: 8px 4px;
      font-size: 12px;
      transition: 0.2s color;
    }

    .mobile-nav-link:hover,
    .mobile-nav-link.active {
      color: var(--accent);
    }

    .mobile-nav-icon {
      font-size: 20px;
      margin-bottom: 2px;
    }

    /* æ¶ˆæ¯æŒ‰é”®æ ·å¼ */
    #chatFab{ 
      position:fixed; 
      left:16px; 
      bottom:calc(var(--mobile-nav-height) + 16px); 
      width:48px; 
      height:48px; 
      border-radius:9999px; 
      display:flex; 
      align-items:center; 
      justify-content:center; 
      background:#0f172a; 
      color:#fff; 
      border:1px solid rgba(255,255,255,.15); 
      box-shadow:0 10px 24px rgba(0,0,0,.28); 
      cursor:pointer; 
      user-select:none; 
      z-index:9999; 
      transition: transform .15s, box-shadow .15s, opacity .2s 
    }
    
    #chatFab:hover{ 
      transform: translateY(-1px); 
      box-shadow: 0 14px 28px rgba(0,0,0,.32) 
    }
    
    #chatFab:active{ 
      transform: translateY(0); 
      box-shadow: 0 8px 18px rgba(0,0,0,.26) 
    }
    
    #chatFab .badge{ 
      position:absolute; 
      right:-2px; 
      top:-2px; 
      min-width:18px; 
      height:18px; 
      padding:0 5px; 
      display:none; 
      align-items:center; 
      justify-content:center; 
      background:var(--accent); 
      color:#fff; 
      border-radius:9999px; 
      font-size:11px; 
      line-height:18px; 
      box-shadow:0 2px 6px rgba(0,0,0,.18); 
      font-weight: bold; 
      z-index: 10000 
    }
    
    @media (max-width:480px){ 
      #chatFab{ 
        left:12px; 
        bottom:calc(var(--mobile-nav-height) + 12px); 
        width:44px; 
        height:44px 
      } 
    }

    /* ç§»åŠ¨ç«¯å“åº”å¼ä¼˜åŒ– */
    @media (max-width: 960px) {
      .container {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
        padding: 16px;
        padding-bottom: calc(var(--mobile-nav-height) + 20px);
      }
      
      .sidebar {
        display: none;
      }
      
      .panel {
        padding: 16px;
        border-radius: 16px;
      }
      
      .panel-title {
        font-size: 20px;
      }
      
      .mobile-nav {
        display: block;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: 12px;
        padding-bottom: calc(var(--mobile-nav-height) + 16px);
      }
      
      .panel {
        padding: 12px;
        border-radius: 12px;
      }
      
      .card {
        grid-template-columns: 1fr;
        text-align: center;
        gap: 16px;
      }
      
      .big-avatar {
        width: 100px;
        height: 100px;
        margin: 0 auto;
      }
      
      .info-grid {
        grid-template-columns: 1fr;
      }
      
      .mobile-nav {
        height: var(--mobile-nav-height);
      }
      
      .mobile-nav-link {
        font-size: 11px;
      }
      
      .mobile-nav-icon {
        font-size: 18px;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: 12px;
        padding-bottom: calc(var(--mobile-nav-height) + 16px);
      }
      
      .panel {
        padding: 12px;
        border-radius: 12px;
      }
      
      .card {
        grid-template-columns: 1fr;
        text-align: center;
        gap: 16px;
      }
      
      .big-avatar {
        width: 100px;
        height: 100px;
        margin: 0 auto;
      }
      
      .info-grid {
        grid-template-columns: 1fr;
      }
    }

    .info-item{
      display:flex;
      align-items:center;
      gap:12px;
      border:1px solid var(--border);
      padding:16px;
      border-radius:16px;
      background:#f8fafc;
    }
    
    .info-item .icon{
      width:28px;
      text-align:center;
      font-size:20px;
      color:var(--accent);
    }
    
    .info-item .label{
      color:#6b7280;
      font-size:13px;
      font-weight:500;
    }
    
    .info-item .value{
      color:#111827;
      font-weight:700;
      font-size: 15px;
    }

    .id-row{
      display:flex;
      gap:12px;
      align-items:center;
    }
    
    .mini-btn{
      border:1px solid var(--border);
      background: var(--gradient-accent);
      color: #fff;
      border-radius:999px;
      padding:6px 12px;
      cursor:pointer;
      font-size:12px;
      font-weight: 600;
      transition: var(--transition);
      border: none;
    }
    
    .mini-btn:hover{
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(79, 172, 254, 0.4);
    }

    /* é¡¶éƒ¨è¡Œï¼šæˆ‘çš„å¸–å­ / æˆ‘çš„æ”¶è— åˆ‡æ¢ */
    .section-bar{
      display:flex;
      align-items:center;
      gap:16px;
      margin-top:20px;
      padding: 20px;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-radius: 16px;
      border: 1px solid var(--border);
    }
    
    .section-title{
      font-size:20px;
      font-weight:800;
      margin:0;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    @media (max-width: 960px) {
      .section-bar {
        margin-top: 16px;
        padding: 16px;
        border-radius: 14px;
        gap: 12px;
      }
      
      .section-title {
        font-size: 18px;
      }
    }
    
    @media (max-width: 640px) {
      .section-bar {
        margin-top: 12px;
        padding: 12px;
        border-radius: 12px;
        gap: 10px;
        flex-direction: column;
        align-items: flex-start;
      }
      
      .section-title {
        font-size: 16px;
      }
    }
    
    .tabs{
      display:flex;
      gap:8px;
      align-items:center;
      margin-bottom: 20px;
    }
    
    .tab{
      border:1px solid var(--border);
      background:#fff;
      border-radius:8px;
      padding:10px 20px;
      cursor:pointer;
      font-size:14px;
      font-weight: 600;
      transition: 0.2s;
      color: var(--muted);
    }
    
    .tab:hover {
      background: #f8fafc;
      color: var(--text);
    }
    
    .tab.active{
      background: var(--accent);
      color:#fff;
      border-color: var(--accent);
    }
    
    @media (max-width: 960px) {
      .tabs {
        gap: 6px;
        margin-bottom: 16px;
      }
      
      .tab {
        padding: 8px 16px;
        font-size: 13px;
      }
    }
    
    @media (max-width: 640px) {
      .tabs {
        gap: 4px;
        margin-bottom: 12px;
      }
      
      .tab {
        padding: 6px 12px;
        font-size: 12px;
        border-radius: 6px;
      }
    }

    /* Masonry å¸ƒå±€ä¸å¡ç‰‡ */
    .posts-masonry{
      column-count:3; 
      column-gap:20px;
      margin-top: 20px;
    }
    
    @media (max-width:1200px){ 
      .posts-masonry{ column-count:2 } 
    }
    
    @media (max-width:960px){ 
      .posts-masonry{ 
        column-count:1;
        column-gap: 16px;
        margin-top: 16px;
      } 
    }
    
    @media (max-width:640px){  
      .posts-masonry{ 
        column-count:1;
        column-gap: 12px;
        margin-top: 12px;
      } 
    }

    .post-card{
      position:relative; 
      display:inline-block; 
      width:100%;
      margin:0 0 20px; 
      border:1px solid var(--border); 
      background:#fff;
      border-radius:20px; 
      overflow:hidden; 
      box-shadow: var(--shadow-card);
      padding-bottom:60px; 
      break-inside:avoid; 
      -webkit-column-break-inside:avoid; 
      page-break-inside:avoid;
      cursor:pointer;
      transition: var(--transition);
    }
    
    @media (max-width: 960px) {
      .post-card {
        margin: 0 0 16px;
        border-radius: 16px;
        padding-bottom: 50px;
      }
    }
    
    @media (max-width: 640px) {
      .post-card {
        margin: 0 0 12px;
        border-radius: 12px;
        padding-bottom: 45px;
      }
    }
    
    .post-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-hover);
      border-color: var(--accent);
    }
    
    .post-card img{ 
      width:100%; 
      display:block; 
      aspect-ratio:4/5; 
      object-fit:cover;
      transition: var(--transition);
    }
    
    @media (max-width: 960px) {
      .post-card img {
        aspect-ratio: 3/4;
      }
    }
    
    @media (max-width: 640px) {
      .post-card img {
        aspect-ratio: 1/1;
      }
    }
    
    .post-card:hover img {
      transform: scale(1.05);
    }
    
    /* ç§»åŠ¨ç«¯è§¦æ‘¸ä¼˜åŒ– */
    @media (hover: none) and (pointer: coarse) {
      .post-card:hover {
        transform: none;
        box-shadow: var(--shadow-card);
        border-color: var(--border);
      }
      
      .post-card:hover img {
        transform: none;
      }
      
      .post-card:active {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border-color: var(--accent);
      }
      
      .post-card:active img {
        transform: scale(1.02);
      }
    }
    
    /* ç©ºçŠ¶æ€ç§»åŠ¨ç«¯ä¼˜åŒ– */
    .empty-state-mobile {
      transition: all 0.3s ease;
    }
    
    @media (max-width: 960px) {
      .empty-state-mobile {
        padding: 32px 16px !important;
        margin: 16px 0 !important;
        border-radius: 10px !important;
      }
      
      .empty-state-mobile > div:first-child {
        font-size: 40px !important;
        margin-bottom: 12px !important;
      }
      
      .empty-state-mobile > div:nth-child(2) {
        font-size: 15px !important;
        margin-bottom: 6px !important;
      }
      
      .empty-state-mobile > div:nth-child(3) {
        font-size: 12px !important;
      }
    }
    
    @media (max-width: 640px) {
      .empty-state-mobile {
        padding: 24px 12px !important;
        margin: 12px 0 !important;
        border-radius: 8px !important;
      }
      
      .empty-state-mobile > div:first-child {
        font-size: 36px !important;
        margin-bottom: 10px !important;
      }
      
      .empty-state-mobile > div:nth-child(2) {
        font-size: 14px !important;
        margin-bottom: 5px !important;
      }
      
      .empty-state-mobile > div:nth-child(3) {
        font-size: 11px !important;
      }
    }
    
    .post-card-text{ 
      padding:16px 20px; 
      color:#374151; 
      line-height:1.6;
      font-size: 15px;
      font-weight: 500;
    }
    
    @media (max-width: 960px) {
      .post-card-text {
        padding: 14px 16px;
        font-size: 14px;
        line-height: 1.5;
      }
    }
    
    @media (max-width: 640px) {
      .post-card-text {
        padding: 12px 14px;
        font-size: 13px;
        line-height: 1.4;
      }
    }

    .post-author-badge{
      position:absolute; 
      right:16px; 
      bottom:16px; 
      display:flex; 
      align-items:center; 
      gap:10px;
      background:rgba(255,255,255,.95); 
      border:1px solid var(--border);
      padding:10px 12px; 
      border-radius:999px; 
      box-shadow:0 8px 24px rgba(0,0,0,.15); 
      max-width:80%;
      backdrop-filter: blur(10px);
    }
    
    @media (max-width: 960px) {
      .post-author-badge {
        right: 12px;
        bottom: 12px;
        padding: 8px 10px;
        gap: 8px;
        max-width: 85%;
      }
    }
    
    @media (max-width: 640px) {
      .post-author-badge {
        right: 10px;
        bottom: 10px;
        padding: 6px 8px;
        gap: 6px;
        max-width: 90%;
      }
    }
    
    .post-author-badge img{ 
      width:24px; 
      height:24px; 
      border-radius:50%; 
      object-fit:cover;
      border: 2px solid #fff;
    }
    
    .post-author-badge .name{ 
      font-size:13px; 
      color:#111827; 
      white-space:nowrap; 
      overflow:hidden; 
      text-overflow:ellipsis; 
      max-width:150px;
      font-weight: 600;
    }
    
    @media (max-width: 960px) {
      .post-author-badge img {
        width: 22px;
        height: 22px;
        border-width: 1.5px;
      }
      
      .post-author-badge .name {
        font-size: 12px;
        max-width: 120px;
      }
    }
    
    @media (max-width: 640px) {
      .post-author-badge img {
        width: 20px;
        height: 20px;
        border-width: 1px;
      }
      
      .post-author-badge .name {
        font-size: 11px;
        max-width: 100px;
      }
    }

    /* å·¦ä¸Šè§’å¯¼èˆªæŒ‰é”® */
    .top-nav-button{
      display:none;
      position:fixed;
      top:24px;
      left:24px;
      z-index:1001;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:16px;
      padding:16px;
      cursor:pointer;
      box-shadow:var(--shadow);
      width:56px;
      height:56px;
      display:flex;
      align-items:center;
      justify-content:center;
      transition: var(--transition);
      backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, 0.95);
    }
    
    .top-nav-button:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }

    .top-nav-button .nav-icon{
      font-size:24px;
      color:var(--text);
    }
    
    .top-nav-button:active{transform:translateY(0); box-shadow:0 8px 18px rgba(0,0,0,.26)}
    
    /* æ¶ˆæ¯æŒ‰é”®æ ·å¼ - ä¸å…¶ä»–åŠŸèƒ½é¡µé¢ä¿æŒä¸€è‡´ */
    #chatFab{ 
      position:fixed; 
      left:16px; 
      bottom:calc(var(--mobile-nav-height) + 16px); 
      width:48px; 
      height:48px; 
      border-radius:9999px; 
      display:flex; 
      align-items:center; 
      justify-content:center; 
      background:#0f172a; 
      color:#fff; 
      border:1px solid rgba(255,255,255,.15); 
      box-shadow:0 10px 24px rgba(0,0,0,.28); 
      cursor:pointer; 
      user-select:none; 
      z-index:9999; 
      transition: transform .15s, box-shadow .15s, opacity .2s 
    }
    
    #chatFab:hover{ 
      transform: translateY(-1px); 
      box-shadow: 0 14px 28px rgba(0,0,0,.32) 
    }
    
    #chatFab:active{ 
      transform: translateY(0); 
      box-shadow: 0 8px 18px rgba(0,0,0,.26) 
    }
    
    /* é¡¶éƒ¨å¯¼èˆªèœå• */
    .top-nav-menu{
      position:fixed;
      top:0;
      left:-320px;
      width:320px;
      height:100vh;
      background:var(--panel);
      border-right:1px solid var(--border);
      z-index:1000;
      transition:.3s ease;
      overflow-y:auto;
      backdrop-filter: blur(20px);
      background: rgba(255, 255, 255, 0.95);
    }

    .top-nav-menu.active{left:0}
    .top-nav-overlay{
      position:fixed;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:rgba(0,0,0,.5);
      z-index:999;
      opacity:0;
      visibility:hidden;
      transition:.3s ease;
      backdrop-filter: blur(5px);
    }

    .top-nav-overlay.active{opacity:1;visibility:visible}
    
    .nav-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:24px;
      border-bottom:2px solid var(--border);
      background: var(--gradient-primary);
      color: #fff;
    }

    .nav-title{
      font-size:20px;
      font-weight:700;
      color:#fff;
    }
    
    .close-btn{
      background:none;
      border:none;
      font-size:28px;
      color:#fff;
      cursor:pointer;
      padding:0;
      width:40px;
      height:40px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:8px;
      transition:.2s;
      background: rgba(255, 255, 255, 0.2);
    }

    .close-btn:hover{
      background:rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }
    
    .top-nav-menu .nav-list{
      list-style:none;
      margin:0;
      padding:24px
    }
    
    .top-nav-menu .nav-list li{
      margin-bottom:12px
    }
    
    .top-nav-menu .nav-list a{
      display:flex;
      align-items:center;
      gap:16px;
      text-decoration:none;
      color:var(--text);
      padding:16px;
      border-radius:12px;
      transition:.2s;
      border: 1px solid transparent;
    }

    .top-nav-menu .nav-list a:hover{
      background:var(--border);
      border-color: var(--accent);
      transform: translateX(8px);
    }
    
    .top-nav-menu .nav-list .nav-icon{
      font-size:20px;
      width:28px;
      text-align:center
    }

    /* ç§»åŠ¨ç«¯å“åº”å¼ä¼˜åŒ– */
    @media (max-width: 960px) {
      .container {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
        padding: 16px;
        padding-bottom: calc(var(--mobile-nav-height) + 20px);
      }
      
      .sidebar {
        display: none;
      }
      
      .panel {
        padding: 20px;
        border-radius: 20px;
      }
      
      .panel-title {
        font-size: 22px;
      }
      
      .card {
        grid-template-columns: 1fr;
        text-align: center;
        gap: 20px;
      }
      
      .big-avatar {
        margin: 0 auto;
        width: 120px;
        height: 120px;
      }
      
      .headline {
        justify-content: center;
      }
      
      .section-bar {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
      }
      
      .tabs {
        width: 100%;
        justify-content: space-between;
      }
      
      .tab {
        flex: 1;
        text-align: center;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: 12px;
        padding-bottom: calc(var(--mobile-nav-height) + 16px);
      }
      
      .panel {
        padding: 16px;
        border-radius: 16px;
      }
      
      .panel-title {
        font-size: 20px;
      }
      
      .card {
        padding: 20px;
        border-radius: 16px;
        margin-bottom: 16px;
      }
      
      .card-text {
        padding: 16px;
        font-size: 14px;
      }
      
      .info-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .info-item {
        padding: 14px;
        border-radius: 14px;
      }
      
      .headline .name {
        font-size: 24px;
      }
      
      .headline .email {
        font-size: 12px;
        padding: 6px 12px;
      }
    }
    
    /* åŠ è½½åŠ¨ç”» */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* ç©ºçŠ¶æ€æ ·å¼ */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }
    
    .empty-state .icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    .empty-state .title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text);
    }
    
    .empty-state .description {
      font-size: 14px;
      line-height: 1.5;
    }
    
    /* æ»šåŠ¨æ¡ç¾åŒ– */
    ::-webkit-scrollbar {
      width: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--gradient-primary);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--gradient-secondary);
    }
    
    /* ç„¦ç‚¹çŠ¶æ€ä¼˜åŒ– */
    .btn:focus,
    .tab:focus,
    .nav-list a:focus {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }
    
    /* é€‰æ‹©æ–‡æœ¬æ ·å¼ */
    ::selection {
      background: var(--gradient-accent);
      color: #fff;
    }
    
    /* æ‰“å°æ ·å¼ */
    @media print {
      .sidebar,
      .top-nav-button,
      .mobile-nav {
        display: none !important;
      }
      
      .container {
        grid-template-columns: 1fr;
        padding: 0;
      }
      
      .panel {
        box-shadow: none;
        border: none;
      }
    }
  </style>
</head>
<body>
  


  <div class="container">
    <div class="sidebar">
      <a class="account-info" href="profile.html">
        <img src="https://raw.githubusercontent.com/WH-An/hwlx-app/2df4e97b395bebb7977074fbb31741f3c35da9a0/assets-task_01k3v2vy06fra8er06x602xnpe-1756476933_img_1.webp" alt="å¤´åƒ" class="avatar">
        <span class="username">æˆ‘çš„è´¦å·</span>
      </a>
      <ul class="nav-list">
        <li><a href="main page.html"><span class="nav-icon">ğŸ </span><span>ä¸»é¡µ</span></a></li>
        <li><a href="life-tips.html"><span class="nav-icon">ğŸ’¡</span><span>ç”Ÿæ´»å°è´´å£«</span></a></li>
        <li><a href="study-guide.html"><span class="nav-icon">ğŸ“š</span><span>å­¦ä¹ æŒ‡å¯¼</span></a></li>
        <li><a href="enrollment-steps.html"><span class="nav-icon">ğŸ“</span><span>å…¥å­¦æ­¥éª¤</span></a></li>
        <li><a href="share.html"><span class="nav-icon">ğŸ”—</span><span>åˆ†äº«</span></a></li>
        <li><a href="fun.html"><span class="nav-icon">ğŸ‰</span><span>å¨±ä¹</span></a></li>
        <li><a href="hospital.html"><span class="nav-icon">ğŸ¥</span><span>åŒ»é™¢</span></a></li>
      </ul>
    </div>

    <!-- ç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆª -->
    <nav class="mobile-nav">
      <ul class="mobile-nav-list">
        <li class="mobile-nav-item">
          <a href="main page.html" class="mobile-nav-link">
            <span class="mobile-nav-icon">ğŸ </span>
            <span>ä¸»é¡µ</span>
          </a>
        </li>
        <li class="mobile-nav-item">
          <a href="life-tips.html" class="mobile-nav-link">
            <span class="mobile-nav-icon">ğŸ’¡</span>
            <span>ç”Ÿæ´»</span>
          </a>
        </li>
        <li class="mobile-nav-item">
          <a href="study-guide.html" class="mobile-nav-link">
            <span class="mobile-nav-icon">ğŸ“š</span>
            <span>å­¦ä¹ </span>
          </a>
        </li>
        <li class="mobile-nav-item">
          <a href="profile.html" class="mobile-nav-link active">
            <span class="mobile-nav-icon">ğŸ‘¤</span>
            <span>ä¸ªäºº</span>
          </a>
        </li>
        <li class="mobile-nav-item">
          <a href="enrollment-steps.html" class="mobile-nav-link">
            <span class="mobile-nav-icon">ğŸ“</span>
            <span>å…¥å­¦</span>
          </a>
        </li>
        <li class="mobile-nav-item">
          <a href="share.html" class="mobile-nav-link">
            <span class="mobile-nav-icon">ğŸ”—</span>
            <span>åˆ†äº«</span>
          </a>
        </li>
        <li class="mobile-nav-item">
          <a href="fun.html" class="mobile-nav-link">
            <span class="mobile-nav-icon">ğŸ‰</span>
            <span>å¨±ä¹</span>
          </a>
        </li>
        <li class="mobile-nav-item">
          <a href="hospital.html" class="mobile-nav-link">
            <span class="mobile-nav-icon">ğŸ¥</span>
            <span>åŒ»é™¢</span>
          </a>
        </li>
      </ul>
    </nav>

    <!-- æ¶ˆæ¯æŒ‰é”® -->
    <div id="chatFab" onclick="window.location.href='messages.html'">
      <span class="chat-icon">ğŸ’¬</span>
      <div class="badge" id="unreadBadge">0</div>
    </div>

    <div class="panel">
      <div class="panel-header">
        <h2 class="panel-title">ğŸ‘¤ ä¸ªäººä¸»é¡µ</h2>
        <div class="spacer"></div>
        <button id="logoutBtn" class="btn primary">é€€å‡ºç™»å½•</button>
      </div>
      
      <!-- èµ„æ–™å¡ -->
      <div class="card">
        <img id="profileAvatar" class="big-avatar" src="" alt="å¤´åƒ">
        <div>
          <div class="headline">
            <span id="profileName" class="name">â€”â€”</span>
            <span id="profileEmail" class="email">â€”â€”</span>
          </div>

          <div class="info-grid" style="margin-top:8px">
            <div class="info-item">
              <span class="icon">ğŸ“</span>
              <div>
                <div class="label">åŒºåŸŸ</div>
                <div id="profileArea" class="value">æœªå¡«å†™</div>
              </div>
            </div>
            <div class="info-item">
              <span class="icon">ğŸ†”</span>
              <div>
                <div class="label">å”¯ä¸€ ID</div>
                <div class="id-row">
                  <span id="profileId" class="value">â€”</span>
                  <button id="copyIdBtn" class="mini-btn" title="å¤åˆ¶ID">å¤åˆ¶</button>
                </div>
              </div>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <label class="file-label btn" for="avatar-upload">æ›´æ¢å¤´åƒ</label>
            <input id="avatar-upload" type="file" accept="image/*" style="display:none">
            <span id="upload-hint" class="muted">æ”¯æŒ JPG/PNG</span>
          </div>

          <div id="profile-tip" class="tip"></div>
        </div>
      </div>

      <!-- æ ‡ç­¾é¡µåˆ‡æ¢ï¼šæˆ‘çš„å¸–å­ / æˆ‘çš„æ”¶è— -->
      <div class="tabs">
        <button id="tabMyPosts" class="tab active">æˆ‘çš„å¸–å­</button>
        <button id="tabMyFavs" class="tab">æˆ‘çš„æ”¶è—</button>
      </div>

      <!-- åˆ—è¡¨å®¹å™¨ï¼ˆå…±ç”¨ï¼‰ -->
      <div id="postList" class="posts-masonry">
        <!-- å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
      </div>
    </div>
  </div>

  <!-- ç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆª -->
  <nav class="mobile-nav">
    <ul class="mobile-nav-list">
      <li class="mobile-nav-item">
        <a href="main page.html" class="mobile-nav-link">
          <span class="mobile-nav-icon">ğŸ </span>
          <span>ä¸»é¡µ</span>
        </a>
      </li>
      <li class="mobile-nav-item">
        <a href="life-tips.html" class="mobile-nav-link">
          <span class="mobile-nav-icon">ğŸ’¡</span>
          <span>ç”Ÿæ´»</span>
        </a>
      </li>
      <li class="mobile-nav-item">
        <a href="study-guide.html" class="mobile-nav-link">
          <span class="mobile-nav-icon">ğŸ“š</span>
          <span>å­¦ä¹ </span>
        </a>
      </li>
      <li class="mobile-nav-item">
        <a href="profile.html" class="mobile-nav-link active">
          <span class="mobile-nav-icon">ğŸ‘¤</span>
          <span>ä¸ªäºº</span>
        </a>
      </li>
      <li class="mobile-nav-item">
        <a href="enrollment-steps.html" class="mobile-nav-link">
          <span class="mobile-nav-icon">ğŸ“</span>
          <span>å…¥å­¦</span>
        </a>
      </li>
      <li class="mobile-nav-item">
        <a href="share.html" class="mobile-nav-link">
          <span class="mobile-nav-icon">ğŸ”—</span>
          <span>åˆ†äº«</span>
        </a>
      </li>
      <li class="mobile-nav-item">
        <a href="fun.html" class="mobile-nav-link">
          <span class="mobile-nav-icon">ğŸ‰</span>
          <span>å¨±ä¹</span>
        </a>
      </li>
      <li class="mobile-nav-item">
        <a href="hospital.html" class="mobile-nav-link">
          <span class="mobile-nav-icon">ğŸ¥</span>
          <span>åŒ»é™¢</span>
        </a>
      </li>
    </ul>
  </nav>

  <!-- é»‘è‰²æ¶ˆæ¯æŒ‰é’® -->
  <div id="chatFab" onclick="window.location.href='messages.html'">
    <span>ğŸ’¬</span>
    <div class="badge">0</div>
  </div>

  <script>
    // è‡ªåŠ¨æ£€æµ‹APIåŸºç¡€URL
    const BASE_URL = (() => {
      if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
        return 'http://127.0.0.1:3001';
      }
      return ''; // ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ç›¸å¯¹è·¯å¾„
    })();
    const FALLBACK = 'https://raw.githubusercontent.com/WH-An/hwlx-app/2df4e97b395bebb7977074fbb31741f3c35da9a0/assets-task_01k3v2vy06fra8er06x602xnpe-1756476933_img_1.webp';

    const $ = sel => document.querySelector(sel);
    function toAbs(u){ if(!u) return ''; if(/^https?:\/\//i.test(u)) return u; return u.startsWith('/') ? (BASE_URL + u) : (BASE_URL + '/' + u); }
    function getParam(k){ try{ return new URL(location.href).searchParams.get(k); }catch{ return null; } }
    function fmt(v, fallback='æœªå¡«å†™'){ return (v===0 || v) ? String(v) : fallback; }
    const norm = s => String(s||'').trim().toLowerCase();

    // tabs åˆ‡æ¢å·¥å…·
    function activateTab(which){
      $('#tabMyPosts').classList.toggle('active', which==='posts');
      $('#tabMyFavs').classList.toggle('active',  which==='favs');
    }

    // å·¦ä¾§è´¦å·å¡ç‰‡
    async function renderSidebarUser(){
      try{
        const avatarEl = document.querySelector('.avatar');
        const nameEl = document.querySelector('.username');
        
        // ä¼˜å…ˆä»æœåŠ¡å™¨è·å–æœ€æ–°ç”¨æˆ·ä¿¡æ¯
        try {
          const response = await fetch(BASE_URL + '/api/users/me', { 
            credentials: 'include' 
          });
          
          if (response.ok) {
            const user = await response.json();
            const name = user.nickname || user.username || user.displayName || user.name || user.email || 'æˆ‘çš„è´¦å·';
            let avatar = user.avatarPath || user.avatarUrl || user.avatar || '';
            if(avatar && !/^https?:\/\//i.test(avatar)) avatar = toAbs(avatar);
            
            nameEl.textContent = name;
            nameEl.title = name;
            avatarEl.onerror = () => { avatarEl.src = FALLBACK; };
            avatarEl.src = avatar || FALLBACK;
            avatarEl.alt = name;
            
            // æ›´æ–°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('currentUser', JSON.stringify(user));
            return;
          }
        } catch (e) {
          console.warn('ä»æœåŠ¡å™¨è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨:', e);
        }

        // å¦‚æœæœåŠ¡å™¨è·å–å¤±è´¥ï¼Œå›é€€åˆ°æœ¬åœ°å­˜å‚¨
        const raw = localStorage.getItem('currentUser')
              || localStorage.getItem('user')
              || localStorage.getItem('USER')
              || localStorage.getItem('auth_user');
        if(!raw){ nameEl.textContent='æˆ‘çš„è´¦å·'; avatarEl.src=FALLBACK; return; }
        const u = JSON.parse(raw)||{};
        const name = u.nickname || u.username || u.displayName || u.name || u.email || 'æˆ‘çš„è´¦å·';
        let avatar = u.avatarPath || u.avatarUrl || u.avatar || '';
        if(avatar && !/^https?:\/\//i.test(avatar)) avatar = toAbs(avatar);
        nameEl.textContent = name;
        nameEl.title = name;
        avatarEl.onerror = () => { avatarEl.src = FALLBACK; };
        avatarEl.src = avatar || FALLBACK;
        avatarEl.alt = name;
      }catch(e){
        console.error('æ¸²æŸ“ä¾§è¾¹æ ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', e);
        const avatarEl = document.querySelector('.avatar');
        const nameEl = document.querySelector('.username');
        if(nameEl) {
          nameEl.textContent = 'æˆ‘çš„è´¦å·';
          nameEl.title = 'æˆ‘çš„è´¦å·';
        }
        if(avatarEl) {
          avatarEl.src = FALLBACK;
          avatarEl.alt = 'æˆ‘çš„å¤´åƒ';
        }
      }
    }

    // æ¸²æŸ“ä¸»å¡ç‰‡
    function renderUser(u, opts = {}){
    const isOther = !!opts.isOther;

    const name  = u.nickname || u.username || u.displayName || u.name || u.email || 'â€”â€”';
    const email = u.email || 'â€”â€”';
    const area  = u.area;
    const uid   = u.id || u._id || '';
    let avatar  = u.avatarPath || u.avatarUrl || u.avatar || '';
    if(avatar && !/^https?:\/\//i.test(avatar)) avatar = toAbs(avatar);

    $('#profileName').textContent = name;
    const emailChip = $('#profileEmail');
    emailChip.textContent = email;
    emailChip.title = email;

    const img = $('#profileAvatar');
    img.onerror = () => { img.src = FALLBACK; };
    img.src = avatar || FALLBACK;
    img.alt = name;

    $('#profileArea').textContent = fmt(area);
    $('#profileId').textContent   = fmt(uid,'â€”');

    const copyBtn = $('#copyIdBtn');
    copyBtn.onclick = async () => {
      try{ await navigator.clipboard.writeText(String(uid||'')); toast('ID å·²å¤åˆ¶'); }
      catch{ toast('å¤åˆ¶å¤±è´¥'); }
    };

    // âœ… å…³é”®ï¼šåªæœ‰â€œçœ‹è‡ªå·±â€æ—¶æ‰æ›´æ–° currentUser / meUserï¼›çœ‹åˆ«äººæ”¾åˆ° lastViewedUser
    try{
      if (isOther) {
        localStorage.setItem('lastViewedUser', JSON.stringify(u));
      } else {
        localStorage.setItem('meUser', JSON.stringify(u));
        localStorage.setItem('currentUser', JSON.stringify(u));
      }
    }catch{}
  }

  function toast(text){
    const tip = $('#profile-tip');
    tip.style.color = '#16a34a';
    tip.textContent = text;
    setTimeout(()=>{ tip.textContent=''; tip.style.color='#d33'; }, 1500);
  }

  function setButtonToLogin(){
    const btn = $('#logoutBtn');
    btn.textContent = 'ç™»å½•';
    btn.title = 'ç‚¹å‡»ç™»å½•';
    btn.classList.add('primary');
    const cloned = btn.cloneNode(true);
    cloned.addEventListener('click', () => { location.href = 'login.html'; });
    btn.parentNode.replaceChild(cloned, btn);

    $('#avatar-upload').disabled = true;
    const lab = document.querySelector('.file-label.btn');
    if (lab) lab.style.display = 'none';
    $('#upload-hint').textContent = 'è¯·ç™»å½•åå¯æ›´æ¢å¤´åƒ';
  }

  function setButtonToBack(){
    const btn = $('#logoutBtn');
    btn.textContent = 'è¿”å›ä¸»é¡µ';
    btn.title = 'è¿”å›ä¸»é¡µ';
    btn.classList.remove('primary');
    const cloned = btn.cloneNode(true);
    cloned.addEventListener('click', () => { location.href = 'main page.html'; });
    btn.parentNode.replaceChild(cloned, btn);

    $('#avatar-upload').disabled = true;
    const lab = document.querySelector('.file-label.btn');
    if (lab) lab.style.display = 'none';
    $('#upload-hint').textContent = 'è¿™æ˜¯å¯¹æ–¹çš„ä¸ªäººä¸»é¡µï¼Œå¤´åƒä¸å¯ç”±ä½ ä¿®æ”¹';
  }

  async function doLogout(){
    try{ await fetch(BASE_URL + '/api/logout', { method:'POST', credentials:'include' }); }catch{}
    // æ¸…é™¤æ‰€æœ‰æœ¬åœ°å­˜å‚¨çš„ç”¨æˆ·ä¿¡æ¯
    ['currentUser', 'user', 'USER', 'auth_user', 'tempUser', 'meUser'].forEach(key => {
      localStorage.removeItem(key);
    });
    location.href = 'login.html';
  }

  /* ====== å¸–å­å¡ç‰‡æ¸²æŸ“ ====== */
  function extractAuthor(p){
    const u = p.user || p.author || p.owner || {};
    let name   = (p.authorName || u.nickname || u.username || u.displayName || u.name || p.username || p.email || '').trim();
    let avatar = (p.authorAvatar || u.avatarPath || u.avatarUrl || u.avatar || p.avatar || '').trim();
    if(!name) name='åŒ¿åç”¨æˆ·';
    if(avatar && !/^https?:\/\//i.test(avatar)) avatar = toAbs(avatar);
    return { name, avatar };
  }

  function renderPosts(list){
    const box = $('#postList');
    box.innerHTML = '';
    (list||[]).forEach(p=>{
      const card = document.createElement('div');
      card.className = 'post-card';

      const pid = p._id || p.id;
      if (pid){
        card.addEventListener('click', ()=>{ location.href = 'post.html?id='+encodeURIComponent(pid); });
        card.style.cursor = 'pointer';
      }

      // å›¾ç‰‡ - åªæ˜¾ç¤ºç¬¬ä¸€å¼ 
      if(p.images && p.images.length > 0){
        const img = document.createElement('img');
        img.src = toAbs(p.images[0]);
        img.alt = '';
        img.onerror = ()=>{ img.remove(); };
        card.appendChild(img);
      }

      if(p.desc || p.title){
        const t = document.createElement('div');
        t.className = 'post-card-text';
        t.textContent = p.desc || p.title || '';
        card.appendChild(t);
      }

      const {name, avatar} = extractAuthor(p);
      const badge = document.createElement('div');
      badge.className = 'post-author-badge';
      const ava = document.createElement('img');
      const FALL = 'data:image/svg+xml;utf8,'+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="100%" height="100%" fill="#e5e7eb"/><circle cx="32" cy="26" r="12" fill="#cbd5e1"/><rect x="12" y="44" width="40" height="14" rx="7" fill="#cbd5e1"/></svg>');
      ava.onerror = ()=>{ ava.src = FALL; };
      ava.src = avatar || FALL;
      ava.alt = name;
      const nm = document.createElement('span');
      nm.className = 'name';
      nm.textContent = name;
      badge.appendChild(ava);
      badge.appendChild(nm);
      card.appendChild(badge);

      box.appendChild(card);
    });

    if(!list || list.length===0){
      const empty=document.createElement('div');
      empty.className='empty-state-mobile';
      empty.style.cssText=`
        padding: 40px 20px;
        text-align: center;
        color: var(--muted);
        font-size: 14px;
        background: #f8fafc;
        border-radius: 12px;
        margin: 20px 0;
        border: 1px dashed var(--border);
      `;
      empty.innerHTML=`
        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“</div>
        <div style="font-weight: 600; margin-bottom: 8px; color: var(--text);">æš‚æ— å†…å®¹</div>
        <div style="font-size: 13px;">æ‚¨è¿˜æ²¡æœ‰å‘å¸ƒä»»ä½•å¸–å­æˆ–æ”¶è—ä»»ä½•å†…å®¹</div>
      `;
      box.appendChild(empty);
    }
  }

  /* ====== æ•°æ®åŠ è½½ï¼šæˆ‘çš„å¸–å­ / æˆ‘çš„æ”¶è— ====== */

  // åˆ¤æ–­å¸–å­å±äºç›®æ ‡ç”¨æˆ·
  function isOwnedByTarget(post, target){
    const targetEmails = [target?.email].map(norm).filter(Boolean);
    const targetIds = [target?.id, target?._id, target?.uid].map(norm).filter(Boolean);

    const postEmails = [
      post.authorEmail, post.email,
      post.user && post.user.email,
      post.owner && post.owner.email,
      post.author && post.author.email
    ].map(norm).filter(Boolean);

    const postIds = [
      post.authorId, post.userId, post.uid, post._userId,
      post.createdBy, post.created_by,
      post.user && (post.user.id || post.user._id),
      post.owner && (post.owner.id || post.owner._id),
      post.author && (post.author.id || post.author._id)
    ].map(norm).filter(Boolean);

    const emailHit = targetEmails.length && postEmails.some(e => targetEmails.includes(e));
    const idHit    = targetIds.length && postIds.some(i => targetIds.includes(i));
    return emailHit || idHit;
  }

  async function loadAllPosts(){
    try{
      const r = await fetch(`${BASE_URL}/api/posts`, { credentials:'include' });
      const arr = await r.json();
      return Array.isArray(arr) ? arr : [];
    }catch{ return []; }
  }

  async function loadMyPosts(targetUser){
    let posts = await loadAllPosts();
    posts = posts.filter(p => isOwnedByTarget(p, targetUser));
    renderPosts(posts);
  }

  function meKeyFromUser(u){
    return norm(u?.email || u?.username || u?.id || u?._id || 'guest');
  }

  function pickMyFavIds(meKey){
    console.log('å¼€å§‹æŸ¥æ‰¾æ”¶è—çš„å¸–å­ï¼Œç”¨æˆ·æ ‡è¯†:', meKey);
    const ids = [];
    for(let i=0;i<localStorage.length;i++){
      const k = localStorage.key(i);
      // æ”¶è—é”®çš„æ ¼å¼ä¸ post.html ä¿æŒä¸€è‡´ï¼šfaved:${meKey}:${postId}
      if(k && k.startsWith(`faved:${meKey}:`)){
        const postId = k.split(':').pop();
        if(postId) ids.push(postId);
      }
    }
    console.log('åœ¨localStorageä¸­æ‰¾åˆ°çš„æ”¶è—é”®:', ids);
    // å»é‡
    const uniqueIds = Array.from(new Set(ids));
    console.log('å»é‡åçš„æ”¶è—ID:', uniqueIds);
    return uniqueIds;
  }

  async function loadMyFavorites(meUser){
    console.log('å¼€å§‹åŠ è½½æˆ‘çš„æ”¶è—ï¼Œç”¨æˆ·:', meUser);
    try {
      const meKey = meKeyFromUser(meUser);
      console.log('ç”¨æˆ·æ ‡è¯†:', meKey);
      const favIds = pickMyFavIds(meKey);
      console.log('æ”¶è—çš„å¸–å­ID:', favIds);
      
      if(favIds.length === 0){ 
        console.log('æ²¡æœ‰æ”¶è—çš„å¸–å­ï¼Œæ˜¾ç¤ºç©ºåˆ—è¡¨');
        renderPosts([]); 
        return; 
      }

      // ç®€å•åŠæ³•ï¼šæ‹‰ä¸€éå…¨é‡å¸–å­ï¼Œç„¶åæŒ‰ id è¿‡æ»¤ï¼ˆæ–¹ä¾¿ & æ¥å£æœ€å°‘ï¼‰
      console.log('å¼€å§‹åŠ è½½æ‰€æœ‰å¸–å­...');
      const all = await loadAllPosts();
      console.log('è·å–åˆ°æ‰€æœ‰å¸–å­æ•°é‡:', all.length);
      
      const set = new Set(favIds.map(String));
      const list = all.filter(p => set.has(String(p._id || p.id || p.postId)));
      console.log('è¿‡æ»¤åçš„æ”¶è—å¸–å­æ•°é‡:', list.length);
      
      renderPosts(list);
    } catch (error) {
      console.error('åŠ è½½æˆ‘çš„æ”¶è—æ—¶å‡ºé”™:', error);
      renderPosts([]);
    }
  }

  // ====== é¡µé¢åˆå§‹åŒ– & tab é€»è¾‘ ======
  async function getMe(){
    const tip = $('#profile-tip');
    try{
      const res = await fetch(BASE_URL + '/api/users/me', { credentials:'include' });
      const data = await res.json().catch(()=> ({}));
      if (!res.ok) {
        tip.textContent = data.msg || `æœªç™»å½•ï¼ˆ${res.status}ï¼‰`;
        setButtonToLogin();
        return;
      }
      renderUser(data);

      // é€€å‡ºæŒ‰é’®
      const btn = $('#logoutBtn');
      const cloned = btn.cloneNode(true);
      cloned.textContent = 'é€€å‡ºç™»å½•';
      cloned.title = 'é€€å‡ºç™»å½•';
      cloned.addEventListener('click', doLogout);
      btn.parentNode.replaceChild(cloned, btn);

      // é»˜è®¤æ˜¾ç¤ºâ€œæˆ‘çš„å¸–å­â€
      activateTab('posts');
      loadMyPosts(data);

      // ç»‘å®š tab åˆ‡æ¢
      $('#tabMyPosts').onclick = () => { activateTab('posts'); loadMyPosts(data); };
      $('#tabMyFavs').onclick  = () => { activateTab('favs');  loadMyFavorites(data); };
    }catch(e){
      tip.textContent = 'æ— æ³•è¿æ¥åç«¯ï¼Œè¯·ç¡®è®¤ 3001 ç«¯å£æœåŠ¡å·²å¯åŠ¨';
      setButtonToLogin();
    }
  }

  async function viewOtherProfile(targetEmail){
    const tip = $('#profile-tip');
    try{
      const res = await fetch(`${BASE_URL}/api/users/by-email?email=${encodeURIComponent(targetEmail)}`, { credentials:'include' });
      const data = await res.json().catch(()=> ({}));
      if (!res.ok) {
        tip.textContent = data.msg || `è·å–ç”¨æˆ·å¤±è´¥ï¼ˆ${res.status}ï¼‰`;
        setButtonToBack();
        return;
      }
      renderUser(data, { isOther: true });
      setButtonToBack();

      // æµè§ˆä»–äººä¸»é¡µæ—¶ï¼Œâ€œæˆ‘çš„æ”¶è—â€æ²¡æœ‰æ„ä¹‰ â†’ éšè—æ”¶è— tab
      document.getElementById('tabMyFavs').style.display = 'none';

      activateTab('posts');
      loadMyPosts(data);
      $('#tabMyPosts').onclick = () => { activateTab('posts'); loadMyPosts(data); };
    }catch(e){
      tip.textContent = 'æ— æ³•è¿æ¥åç«¯ï¼Œè¯·ç¡®è®¤ 3001 ç«¯å£æœåŠ¡å·²å¯åŠ¨';
      setButtonToBack();
    }
  }

  async function uploadAvatar(file){
    const tip = $('#profile-tip');
    if (!file) return;
    const fd = new FormData();
    fd.append('avatar', file);
    try{
      const res = await fetch(BASE_URL + '/api/upload/avatar', {
        method: 'POST', body: fd, credentials: 'include'
      });
      const data = await res.json().catch(()=> ({}));
      if (!res.ok) { tip.textContent = data.msg || `ä¸Šä¼ å¤±è´¥ï¼ˆ${res.status}ï¼‰`; return; }
      toast('å¤´åƒå·²æ›´æ–°');
      const meRes = await fetch(BASE_URL + '/api/users/me', { credentials:'include' });
      if (meRes.ok){
        const me = await meRes.json();
        renderUser(me);
      }
    }catch(e){
      tip.textContent = 'ä¸Šä¼ å¤±è´¥ï¼šæ¥å£ä¸å¯è¾¾';
    }
  }

  // åˆå§‹åŒ–
  window.addEventListener('DOMContentLoaded', async () => {
    await renderSidebarUser();

    $('#avatar-upload').addEventListener('change', (e) => {
      const file = e.target.files && e.target.files[0];
      uploadAvatar(file);
    });

    const targetEmail = (getParam('email') || '').trim().toLowerCase();
    if (targetEmail) {
      viewOtherProfile(targetEmail);
    } else {
      getMe();
    }
  });

  // é¡¶æ â€œæ¶ˆæ¯â€æŒ‰é’®
  (function(){
    function addMsgButton(){
      const header = document.querySelector('.panel-header');
      const logout = document.getElementById('logoutBtn');
      if(!header || !logout) return;
      if(document.getElementById('msgBtn')) return;

      const btn = document.createElement('button');
      btn.className = 'btn';
      btn.id = 'msgBtn';
      btn.textContent = 'æ¶ˆæ¯';
      header.insertBefore(btn, logout);

      const params = new URL(location.href).searchParams;
      const to = (params.get('email') || '').trim();
      btn.addEventListener('click', ()=>{
        const dest = to ? ('messages.html?to=' + encodeURIComponent(to)) : 'messages.html';
        location.href = dest;
      });
    }
    
    // å»¶è¿Ÿæ·»åŠ æ¶ˆæ¯æŒ‰é’®ï¼Œç¡®ä¿åœ¨getMeæ‰§è¡Œåå†æ·»åŠ 
    setTimeout(addMsgButton, 100);
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(addMsgButton, 100);
    });
  })();

    // æœªè¯»æ¶ˆæ¯åŠŸèƒ½
    async function getUnreadCount() {
      try {
        const res = await fetch(`${BASE_URL}/api/messages/unread-count`, { 
          credentials: 'include',
          cache: 'no-cache'
        });
        
        if (res.ok) {
          const data = await res.json();
          return data.count || 0;
        }
      } catch (e) {
        console.warn('è·å–æœªè¯»æ¶ˆæ¯æ•°é‡å¤±è´¥:', e);
      }
      
      // å›é€€åˆ°æœ¬åœ°å­˜å‚¨çš„æœªè¯»æ•°é‡
      try {
        const cached = localStorage.getItem('unreadCount');
        return cached ? parseInt(cached) : 0;
      } catch (e) {
        return 0;
      }
    }

    // æ›´æ–°æœªè¯»æ¶ˆæ¯å¾½ç« 
    async function updateUnreadBadge() {
      const chatFab = document.getElementById('chatFab');
      if (!chatFab) return;
      
      const badge = chatFab.querySelector('.badge');
      if (!badge) return;
      
      try {
        const unreadCount = await getUnreadCount();
        console.log('è·å–åˆ°æœªè¯»æ¶ˆæ¯æ•°é‡:', unreadCount);
        
        if (unreadCount > 0) {
          badge.textContent = unreadCount > 99 ? '99+' : unreadCount.toString();
          badge.style.display = 'flex';
          console.log('å¾½ç« æ˜¾ç¤º:', badge.textContent);
        } else {
          badge.style.display = 'none';
          console.log('å¾½ç« éšè—');
        }
        
        // ç¼“å­˜æœªè¯»æ•°é‡
        try {
          localStorage.setItem('unreadCount', unreadCount.toString());
        } catch (e) {
          console.warn('ç¼“å­˜æœªè¯»æ•°é‡å¤±è´¥:', e);
        }
      } catch (error) {
        console.error('æ›´æ–°å¾½ç« æ—¶å‡ºé”™:', error);
        // å‡ºé”™æ—¶éšè—å¾½ç« 
        badge.style.display = 'none';
      }
    }

    // é¡µé¢åŠ è½½å®Œæˆåæ›´æ–°å¾½ç« 
    document.addEventListener('DOMContentLoaded', () => {
      updateUnreadBadge();
      
      // æ¯30ç§’æ›´æ–°ä¸€æ¬¡æœªè¯»æ•°é‡
      setInterval(updateUnreadBadge, 30000);
    });

    // é¡µé¢è·å¾—ç„¦ç‚¹æ—¶æ›´æ–°å¾½ç« 
    document.addEventListener('focus', updateUnreadBadge);
    window.addEventListener('focus', updateUnreadBadge);
    
    // æ·»åŠ æµ‹è¯•åŠŸèƒ½ - åœ¨æ§åˆ¶å°è°ƒç”¨ testBadge(number) æ¥æµ‹è¯•å¾½ç« 
    window.testBadge = function(count) {
      const badge = document.querySelector('#chatFab .badge');
      if (!badge) {
        console.log('æœªæ‰¾åˆ°å¾½ç« å…ƒç´ ');
        return;
      }
      
      if (count > 0) {
        badge.textContent = count > 99 ? '99+' : count.toString();
        badge.style.display = 'flex';
        console.log(`æµ‹è¯•å¾½ç« æ˜¾ç¤º: ${badge.textContent}`);
      } else {
        badge.style.display = 'none';
        console.log('æµ‹è¯•å¾½ç« éšè—');
      }
    };
    
    console.log('å¾½ç« æµ‹è¯•åŠŸèƒ½å·²åŠ è½½ï¼Œä½¿ç”¨ testBadge(number) æ¥æµ‹è¯•');
  </script>
</body>
</html>
