<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ç®¡ç†å‘˜æ¡£æ¡ˆ Â· ç¼–è¾‘</title>
  <style>
    :root{--bg:#0b0f14;--panel:#ffffff;--text:#0f172a;--muted:#64748b;--accent:#16a34a;--danger:#ef4444;--border:#e5e7eb;--shadow:0 10px 30px rgba(0,0,0,.18);--radius:18px}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:'Microsoft YaHei',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'PingFang SC',sans-serif;background:radial-gradient(1200px 600px at 10% -10%,#1f8db8 18%, transparent 60%),radial-gradient(900px 500px at 110% 110%,#2bb8d6 12%, transparent 60%),var(--bg);color:#fff}
    .layout{display:grid;grid-template-columns:220px 1fr;gap:18px;height:100vh;padding:24px;overflow:hidden}
    .sidebar{background:var(--panel);color:var(--text);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px 16px;display:flex;flex-direction:column;gap:16px}
    .account-info{display:flex;flex-direction:column;align-items:center;gap:10px;text-decoration:none;color:inherit;border:1px dashed #eef2ff;border-radius:14px;padding:14px;background:#fff}
    .avatar{width:72px;height:72px;border-radius:50%;object-fit:cover}
    .username{font-weight:700}
    .nav-list{list-style:none;margin:6px 0 0;padding:0;display:flex;flex-direction:column;gap:10px}
    .nav-list a{display:flex;align-items:center;gap:10px;text-decoration:none;color:var(--text);border:1px solid var(--border);background:#fafafa;border-radius:12px;padding:10px 14px;transition:.2s}
    .nav-list a:hover{background:#f3f4f6;transform:translateY(-1px)}
    .nav-icon{width:22px;display:inline-flex;justify-content:center}

    .main{background:var(--panel);color:var(--text);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px;display:flex;flex-direction:column;gap:14px;height:100%;overflow:auto}
    h1{font-size:18px;margin:0;display:flex;align-items:center;gap:10px}
    .badge{display:inline-flex;align-items:center;gap:6px;font-size:12px;border:1px solid var(--border);border-radius:999px;padding:4px 8px;background:#fff}
    .badge.admin{border-color:#bbf7d0;background:#f0fdf4;color:#166534}

    .profile-card{display:grid;grid-template-columns:160px 1fr;gap:18px;border:1px solid var(--border);border-radius:16px;background:#fff;box-shadow:0 6px 18px rgba(0,0,0,.06);padding:16px}
    .profile-card .big-avatar{width:140px;height:140px;border-radius:16px;object-fit:cover;border:1px solid var(--border)}
    .field{display:flex;gap:10px;align-items:center;margin:10px 0}
    .field .label{width:100px;color:#64748b;font-size:12px}
    .field .value{font-size:14px;color:#111827}
    .input{border:1px solid var(--border);border-radius:12px;padding:8px 10px;font-size:14px;width:100%}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btn{display:inline-flex;align-items:center;gap:8px;cursor:pointer;border:1px solid var(--border);background:#fff;color:#111827;border-radius:12px;padding:8px 12px;font-weight:700;transition:.15s;text-decoration:none}
    .btn:hover{background:#f3f4f6}
    .btn.primary{border-color:#a7f3d0;background:#ecfdf5;color:#065f46}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:900px){ .profile-card{grid-template-columns:1fr} .grid2{grid-template-columns:1fr} }
    .panel{border:1px solid var(--border);border-radius:16px;background:#fff;box-shadow:0 6px 18px rgba(0,0,0,.06);padding:16px}
    .panel h2{font-size:16px;margin:0 0 10px 0}
    .small{font-size:12px;color:#64748b}
    .divider{height:1px;background:#e5e7eb;margin:8px 0}
    .toast{position:fixed;right:16px;bottom:16px;background:#0f172a;color:#fff;border:1px solid rgba(255,255,255,.18);border-radius:12px;padding:10px 14px;box-shadow:0 10px 24px rgba(0,0,0,.3);opacity:0;transform:translateY(6px);transition:.2s;z-index:9999}
    .toast.show{opacity:1;transform:translateY(0)}
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <a class="account-info" href="admin-profile.edit.html">
        <img src="" alt="å¤´åƒ" class="avatar" id="sidebarAvatar">
        <span class="username" id="sidebarName">æˆ‘çš„è´¦å·</span>
      </a>
      <ul class="nav-list">
        <li><a href="admin-all.html"><span class="nav-icon">âš™ï¸</span><span>åå°ç®¡ç†</span></a></li>
        <li><a href="admin-publish.html"><span class="nav-icon">ğŸ“</span><span>å‘å¸ƒå†…å®¹</span></a></li>
        <li><a href="admin-posts.html"><span class="nav-icon">ğŸ“‹</span><span>å¸–å­ç®¡ç†</span></a></li>
      </ul>
    </aside>

    <main class="main">
      <h1>ç®¡ç†å‘˜æ¡£æ¡ˆ <span class="badge admin">ç®¡ç†å‘˜</span></h1>

      <section class="profile-card">
        <img id="avatar" class="big-avatar" src="" alt="ç®¡ç†å‘˜å¤´åƒ">
        <div>
          <div class="field"><div class="label">æ˜¾ç¤ºåç§°</div><input id="displayName" class="input" placeholder="è¯·è¾“å…¥ç”¨æˆ·å"/></div>
          <div class="field"><div class="label">é‚®ç®±</div><div class="value" id="emailText">â€”</div></div>
          <div class="field"><div class="label">è§’è‰²</div><div class="value" id="role">â€”</div></div>
          <div class="field"><div class="label">åˆ›å»ºæ—¶é—´</div><div class="value" id="createdAt">â€”</div></div>
          <div class="field"><div class="label">å¤´åƒ URL</div><input id="avatarUrl" class="input" placeholder="https://.../avatar.jpg"/></div>
          <div class="field"><div class="label">ä¸Šä¼ å¤´åƒ</div><input id="avatarFile" type="file" accept="image/*"/></div>
          <div class="actions">
            <button class="btn primary" id="saveBtn">ä¿å­˜ä¿®æ”¹</button>
            <span class="small" id="saveHint">å¯ç›´æ¥ç²˜è´´å¤´åƒ URLï¼Œæˆ–ä¸Šä¼ å›¾ç‰‡å°è¯•è‡ªåŠ¨ä¸Šä¼ ã€‚</span>
          </div>
        </div>
      </section>

      <div class="grid2">
        <section class="panel">
          <h2>è¯´æ˜</h2>
          <div class="small">æ­¤é¡µæ”¯æŒä¿®æ”¹ <strong>å¤´åƒ</strong> ä¸ <strong>ç”¨æˆ·å</strong>ã€‚ä¿å­˜æ—¶å°†å°è¯•è°ƒç”¨ï¼š<code>PATCH /api/users/me</code>ï¼ˆè‹¥ä¸å¯ç”¨ä¼šå°è¯• PUT/POSTï¼‰ã€‚ä¸Šä¼ å¤´åƒå°†å°è¯•å¸¸è§ä¸Šä¼ ç«¯ç‚¹ï¼ˆå¦‚ <code>/api/upload</code>ï¼‰ã€‚</div>
        </section>

        <section class="panel">
          <h2>å®‰å…¨æé†’</h2>
          <div class="small">å½“å‰é¡¹ç›®è°ƒè¯•ä½¿ç”¨å›ºå®šç®¡ç†å‘˜ï¼ˆ<code>hwlx@hwlx.com / hwlx</code>ï¼‰ã€‚ä¸Šçº¿å‰è¯·æ”¹ä¸ºæ•°æ®åº“ç”¨æˆ·ä½“ç³»å¹¶å¯ç”¨æƒé™æ ¡éªŒã€‚</div>
        </section>
      </div>
    </main>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // è‡ªåŠ¨æ£€æµ‹APIåŸºç¡€URL
  const API_BASE = (() => {
    if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
      return 'http://127.0.0.1:3001';
    }
    return ''; // ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ç›¸å¯¹è·¯å¾„
  })();
    const $ = sel => document.querySelector(sel);
    function toast(msg, ms=2000){ const el=$('#toast'); el.textContent=msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'), ms); }
    async function api(path, opt={}){
      const url = path.startsWith('http')? path : API_BASE + path;
      const res = await fetch(url, { credentials:'include', headers:{'Content-Type':'application/json', ...(opt.headers||{})}, ...opt });
      if(!res.ok){ let t=''; try{t=await res.text()}catch{} throw new Error(res.status+': '+t); }
      const ct = res.headers.get('content-type')||'';
      return ct.includes('application/json')? res.json(): res.text();
    }
    async function uploadFile(file){
      const endpoints = ['/api/upload','/api/uploads','/api/files','/api/images','/upload','/uploads'];
      for(const ep of endpoints){
        try{
          const fd = new FormData(); fd.append('file', file);
          const res = await fetch(API_BASE+ep, { method:'POST', body: fd, credentials:'include' });
          if(!res.ok) throw new Error('HTTP '+res.status);
          const ct = res.headers.get('content-type')||'';
          if(ct.includes('application/json')){
            const data = await res.json();
            const url = data.url || data.path || data.location || data.file || data.avatar || '';
            if(url) return url;
          }else{
            const text = await res.text();
            // å°è¯•ä»çº¯æ–‡æœ¬è¿”å›ä¸­æå– URL
            const m = text.match(/https?:[^\s'"]+/);
            if(m) return m[0];
          }
        }catch(e){ /* try next */ }
      }
      throw new Error('æ²¡æœ‰å¯ç”¨çš„ä¸Šä¼ ç«¯ç‚¹');
    }
    function toAbs(url){ if(!url) return ''; if(/^https?:\/\//i.test(url)) return url; return url.startsWith('/') ? (API_BASE + url) : (API_BASE + '/' + url); }

    async function hydrate(){
      try{
        // ç®¡ç†å‘˜é¡µé¢ä»localStorageè·å–ç®¡ç†å‘˜ä¿¡æ¯
        const adminUser = JSON.parse(localStorage.getItem('adminUser') || localStorage.getItem('tempAdminUser') || '{}');
        const name   = adminUser.name || adminUser.nickname || 'æµ·å¤–ç•™å­¦';
        const email  = adminUser.email || 'hwlx@hwlx.com';
        const role   = 'admin';
        const avatar = adminUser.avatarPath || adminUser.avatar || ''; // ä»localStorageè·å–å¤´åƒ
        const created= 'â€”';

        $('#displayName').value = name;
        $('#sidebarName').textContent = name;
        $('#sidebarName').title = name;
        $('#role').textContent = role === 'admin' ? 'ç®¡ç†å‘˜' : role;
        $('#createdAt').textContent = created;
        $('#emailText').textContent = email;
        const FALLBACK_AVATAR = 'data:image/svg+xml;utf8,'+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="128" height="128"><rect width="100%" height="100%" fill="#e5e7eb"/><circle cx="64" cy="54" r="26" fill="#cbd5e1"/><rect x="24" y="86" width="80" height="28" rx="14" fill="#cbd5e1"/></svg>');
        $('#avatar').src = avatar? toAbs(avatar): FALLBACK_AVATAR;
        $('#avatar').alt = name;
        $('#avatar').onerror = () => { $('#avatar').src = FALLBACK_AVATAR; };
        $('#sidebarAvatar').src = avatar? toAbs(avatar): FALLBACK_AVATAR;
        $('#sidebarAvatar').alt = name;
        $('#sidebarAvatar').onerror = () => { $('#sidebarAvatar').src = FALLBACK_AVATAR; };
        $('#avatarUrl').value = avatar || '';
      }catch(e){
        console.error('è¯»å–ç”¨æˆ·èµ„æ–™å¤±è´¥:', e);
        toast('è¯»å–èµ„æ–™å¤±è´¥ï¼š'+e.message);
        
        // è®¾ç½®é»˜è®¤å€¼
        const FALLBACK_AVATAR = 'data:image/svg+xml;utf8,'+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="128" height="128"><rect width="100%" height="100%" fill="#e5e7eb"/><circle cx="64" cy="54" r="26" fill="#cbd5e1"/><rect x="24" y="86" width="80" height="28" rx="14" fill="#cbd5e1"/></svg>');
        $('#displayName').value = 'æµ·å¤–ç•™å­¦';
        $('#sidebarName').textContent = 'æµ·å¤–ç•™å­¦';
        $('#sidebarName').title = 'æµ·å¤–ç•™å­¦';
        $('#role').textContent = 'ç®¡ç†å‘˜';
        $('#createdAt').textContent = 'â€”';
        $('#emailText').textContent = 'hwlx@hwlx.com';
        $('#avatar').src = FALLBACK_AVATAR;
        $('#avatar').alt = 'æµ·å¤–ç•™å­¦';
        $('#sidebarAvatar').src = FALLBACK_AVATAR;
        $('#sidebarAvatar').alt = 'æµ·å¤–ç•™å­¦';
        $('#avatarUrl').value = '';
      }
    }

    document.addEventListener('DOMContentLoaded', async ()=>{
      await hydrate();

      // é¢„è§ˆæœ¬åœ°é€‰æ‹©çš„å¤´åƒ
      $('#avatarFile').addEventListener('change', (e)=>{
        const f = e.target.files && e.target.files[0];
        if(!f) return;
        const reader = new FileReader();
        reader.onload = ev => { $('#avatar').src = ev.target.result; };
        reader.readAsDataURL(f);
      });

      $('#saveBtn').addEventListener('click', async ()=>{
        try{
          $('#saveHint').textContent = 'ä¿å­˜ä¸­â€¦';
          let avatarUrl = ($('#avatarUrl').value||'').trim();
          const file = ($('#avatarFile').files||[])[0];
          
          // å¦‚æœæœ‰æ–‡ä»¶ï¼Œå…ˆä¸Šä¼ 
          if(file){ 
            try{
              const uploaded = await uploadFile(file);
              avatarUrl = uploaded || avatarUrl;
              toast('å¤´åƒä¸Šä¼ æˆåŠŸ');
            }catch(e){
              toast('ä¸Šä¼ å¤´åƒå¤±è´¥ï¼š'+e.message+'ï¼›å°†å°è¯•ä½¿ç”¨å¤´åƒURLå­—æ®µä¿å­˜');
            }
          }
          
          // å‡†å¤‡ä¿å­˜æ•°æ®
          const payload = {
            name: ($('#displayName').value||'').trim() || undefined,
            avatar: avatarUrl || undefined,
            avatarUrl: avatarUrl || undefined
          };
          
          // ç®¡ç†å‘˜å¤´åƒä¿å­˜ï¼šåªæ›´æ–°localStorageï¼Œä¸è°ƒç”¨æœåŠ¡å™¨API
          // è¿™æ ·å¯ä»¥é¿å…å½±å“æ™®é€šç”¨æˆ·ä¿¡æ¯
          console.log('ç®¡ç†å‘˜å¤´åƒä¿å­˜ï¼šåªæ›´æ–°localStorage');
          ok = true; // ç›´æ¥æ ‡è®°ä¸ºæˆåŠŸ
          toast('å·²ä¿å­˜');
          $('#saveHint').textContent = 'å·²ä¿å­˜';
          
          // ç«‹å³æ›´æ–°æ˜¾ç¤º
          const newName = ($('#displayName').value||'').trim();
          if(newName) {
            $('#sidebarName').textContent = newName;
            $('#sidebarName').title = newName;
          }
          
          if(avatarUrl) {
            const absUrl = toAbs(avatarUrl);
            $('#avatar').src = absUrl;
            $('#sidebarAvatar').src = absUrl;
            $('#avatarUrl').value = avatarUrl;
          }
          
          // æ›´æ–°localStorageä¸­çš„ç®¡ç†å‘˜ä¿¡æ¯
          const adminUser = JSON.parse(localStorage.getItem('adminUser') || localStorage.getItem('tempAdminUser') || '{}');
          adminUser.name = newName || adminUser.name;
          adminUser.avatarPath = avatarUrl || adminUser.avatarPath;
          localStorage.setItem('adminUser', JSON.stringify(adminUser));
          
          // ç®¡ç†å‘˜é¡µé¢ä¸éœ€è¦é‡æ–°è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œé¿å…å½±å“æ™®é€šç”¨æˆ·
          // await hydrate();
        }catch(e){
          toast('ä¿å­˜å¤±è´¥ï¼š'+e.message);
          $('#saveHint').textContent = 'ä¿å­˜å¤±è´¥';
        }
      });
    });
  </script>
</body>
</html>
