<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ¶ˆæ¯</title>
  <!-- ç§»åŠ¨ç«¯ä¼˜åŒ–CSS -->
  <link rel="stylesheet" href="mobile-optimization.css">
  

  <style>
    :root{
      --bg:#0b0f14; --panel:#ffffff; --text:#0f172a; --muted:#64748b;
      --accent:#16a34a; --border:#e5e7eb; --shadow:0 10px 30px rgba(0,0,0,.18); --radius:18px;
      --danger:#ef4444;
    }
    *{box-sizing:border-box}
    /* å…³é”®ï¼šæ•´é¡µç¦ç”¨æ»šåŠ¨ï¼Œåªè®©å†…éƒ¨å®¹å™¨æ»šåŠ¨ */
    html,body{
      height:100%;
      overflow:visible;
      overscroll-behavior:none;
    }
    body{
      margin:0; font-family:'Microsoft YaHei',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'PingFang SC',sans-serif;
      background:radial-gradient(1200px 600px at 10% -10%,#1f8db8 18%, transparent 60%),
                 radial-gradient(900px 500px at 110% 110%,#2bb8d6 12%, transparent 60%),var(--bg);
      color:#fff;
    }

    /* å æ»¡è§†å£ä¸”è‡ªèº«ä¸æ»šåŠ¨ */
    .shell{
      display:grid; grid-template-columns:280px 1fr; gap:18px;
      height:100dvh; height:100vh; padding:24px; overflow:visible;
    }
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);color:var(--text);display:flex;flex-direction:column;min-height:0}
    .header{display:flex;align-items:center;gap:10px;padding:12px 14px;border-bottom:1px solid var(--border);position:sticky;top:0;background:#fff;z-index:2}
    .title{font-size:18px;font-weight:800}
    .spacer{flex:1}
    .btn{border:1px solid var(--border);background:#fff;border-radius:12px;padding:8px 12px;font-weight:700;cursor:pointer}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn.ghost{background:#fff;border-color:#e5e7eb}

    /* å·¦ä¾§ï¼šå†…éƒ¨æ»šåŠ¨çš„æ˜¯ .list */
    .threads{display:flex;flex-direction:column;min-height:0; overscroll-behavior:contain;}
    .threads .search{padding:10px 12px;border-bottom:1px solid var(--border)}
    .threads input{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;outline:none}
    .list{flex:1; overflow:auto} /* å…³é”®ï¼šåªåˆ—è¡¨æ»šåŠ¨ */
    .item{display:flex;flex-direction:column;gap:4px;padding:12px;border-bottom:1px solid #f1f5f9;cursor:pointer; position:relative;}
    .item:hover{background:#fafafa}
    .peerRow{ display:flex; align-items:center; gap:8px; }
    .item .peer{font-weight:700;color:#0f172a}
    .item .last{font-size:12px;color:#6b7280;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .badge{
      position:absolute; top:10px; right:12px;
      background:var(--danger); color:#fff;
      border-radius:9999px; font-size:11px; line-height:1;
      padding:3px 6px; min-width:18px; text-align:center;
      box-shadow:0 2px 6px rgba(0,0,0,.15);
      display:none;
    }
    .avatar{width:28px; height:28px; border-radius:50%; object-fit:cover; border:1px solid var(--border); background:#f8fafc;}

    /* å³ä¾§ï¼šå†…éƒ¨æ»šåŠ¨çš„æ˜¯ .chat-boxï¼ˆå¾®ä¿¡å¼ï¼‰ */
    .chat{display:flex;flex-direction:column;min-height:0; overscroll-behavior:contain;}
    .chat-box{ flex:1; overflow:auto; padding:14px } /* å…³é”®ï¼šåªæ¶ˆæ¯åŒºæ»šåŠ¨ */
    .msg{max-width:72%;margin:6px 0;padding:10px 12px;border-radius:14px;border:1px solid var(--border);background:#fff;box-shadow:0 4px 12px rgba(0,0,0,.06)}
    /* åªç»™â€œæ°”æ³¡â€ä¸Šæ ·å¼ï¼Œä¸å½±å“æ•´è¡Œå®¹å™¨ */
.msg.me{ margin-left:auto; background:#eafff1; border-color:#bbf7d0; }
.msg.peer{ margin-right:auto; }

/* æ˜ç¡®è¡Œå®¹å™¨èƒŒæ™¯é€æ˜ï¼Œé¿å…è¯¯ä¸Šè‰² */
.msgrow.me, .msgrow.peer{ background: transparent; }

    .meta{font-size:11px;color:#6b7280;margin-top:4px}
    .empty{padding:18px;color:#6b7280}
    .msgrow{ display:flex; gap:8px; margin:6px 0; align-items:flex-end; }
    .msgrow.me{ justify-content:flex-end; }
    .msgrow .msg{ margin:0; }
    .msgrow .avatar{ width:28px; height:28px; }

    /* å‘é€åŒºå›ºå®šåœ¨å³ä¾§é¢æ¿åº•éƒ¨ */
    .composer{display:flex;gap:10px;padding:12px;border-top:1px solid var(--border);position:sticky;bottom:0;background:#fff;z-index:2}
    .composer input[type="text"]{flex:1;padding:10px 12px;border:1px solid var(--border);border-radius:10px;outline:none}

    /* é™„ä»¶é¢„è§ˆæ¡ â€”â€” å›ºå®šåœ¨è¾“å…¥åŒºä¸Šæ–¹ */
    .attach-preview{display:none; gap:8px; padding:8px 12px; border-top:1px dashed #e5e7eb; background:#fff; position:sticky; bottom:56px; z-index:2}
    .thumb{position:relative; width:64px; height:64px; border-radius:10px; overflow:hidden; border:1px solid #e5e7eb; background:#f8fafc}
    .thumb img{width:100%; height:100%; object-fit:cover}
    .thumb .x{position:absolute; right:4px; top:4px; width:18px; height:18px; border-radius:999px; background:rgba(0,0,0,.6); color:#fff; font-size:12px; line-height:18px; text-align:center; cursor:pointer}

    /* å›¾ç‰‡æ¶ˆæ¯ï¼šä¹å®«æ ¼ */
    .img-grid{display:grid; grid-template-columns: repeat(3, minmax(0, 180px)); gap:6px; margin-top:6px}
    .img-grid img{width:100%; height:180px; object-fit:cover; border-radius:10px; border:1px solid #e5e7eb; cursor:pointer}

    /* å‘é€ä¸­/å¤±è´¥ æ ·å¼ */
    .msg.sending{ opacity:.9; }
    .prog{ height:6px; border-radius:6px; background:#eef2f7; overflow:hidden; margin-top:6px; }
    .prog .bar{ height:100%; width:0%; background:linear-gradient(90deg, #22c55e, #16a34a); transition: width .1s linear; }
    .msg.failed{ background:#fff1f2; border-color:#fecaca; }
    .msg .actions{ display:flex; gap:8px; margin-top:8px; }
    .msg .actions .btn{ padding:6px 10px; border-radius:8px; border:1px solid #e5e7eb; background:#fff; cursor:pointer; }
    .msg .actions .btn.retry{ border-color:#16a34a; color:#166534; }
    .msg .actions .btn.cancel{ border-color:#e5e7eb; color:#334155; }

    /* Lightbox é¢„è§ˆ */
    #lightbox{ position:fixed; inset:0; background:rgba(0,0,0,.92); display:none; align-items:center; justify-content:center; z-index:50; }
    #lightbox.open{ display:flex; }
    #lbImg{ max-width:90vw; max-height:90vh; border-radius:10px; box-shadow:0 10px 40px rgba(0,0,0,.5); }
    .lb-btn{ position:fixed; top:20px; width:40px; height:40px; border-radius:10px; background:rgba(255,255,255,.15); color:#fff; border:none; cursor:pointer; }
    #lbClose{ right:20px; }
    #lbPrev{ left:20px; top:calc(50% - 20px); }
    #lbNext{ right:20px; top:calc(50% - 20px); }
    .lb-btn:hover{ background:rgba(255,255,255,.25); }
    @media (max-width: 900px){ .shell{grid-template-columns:1fr} .threads{display:none} }
  

    
    
    .top-nav-button .nav-icon{font-size:20px;color:var(--text)}
    .top-nav-button:hover{transform:translateY(-1px);box-shadow:0 14px 28px rgba(0,0,0,.32)}
    .top-nav-button:active{transform:translateY(0);box-shadow:0 8px 18px rgba(0,0,0,.26)}

    

    /* ç§»åŠ¨ç«¯å“åº”å¼ä¼˜åŒ– */
    @media (max-width: 960px) {
      .container {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
        padding: 16px;
        padding-bottom: calc(var(--mobile-nav-height) + 20px);
      }
      
      .sidebar {
        display: none;
      }
      
      .panel {
        padding: 16px;
        border-radius: 16px;
      }
      
      .search-box {
        flex-direction: column;
        gap: 12px;
      }
      
      .search-box input {
        padding: 14px 16px;
        font-size: 16px;
      }
      
      .search-box button {
        padding: 14px 16px;
        font-size: 16px;
      }
      
      .panel-title {
        font-size: 20px;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: 12px;
        padding-bottom: calc(var(--mobile-nav-height) + 16px);
      }
      
      .panel {
        padding: 12px;
        border-radius: 12px;
      }
      
      .search-box input {
        padding: 16px;
        font-size: 16px;
      }
      
      .search-box button {
        padding: 16px;
        font-size: 16px;
      }
      
      .panel-title {
        font-size: 18px;
      }
      
      .card {
        border-radius: 12px;
        margin-bottom: 12px;
      }
      
      .card-text {
        padding: 12px;
        font-size: 14px;
      }
    }

    #chatFab{ position:fixed; left:16px; bottom:calc(var(--mobile-nav-height) + 16px); width:48px; height:48px; border-radius:9999px; display:flex; align-items:center; justify-content:center; background:#0f172a; color:#fff; border:1px solid rgba(255,255,255,.15); box-shadow:0 10px 24px rgba(0,0,0,.28); cursor:pointer; user-select:none; z-index:9999; transition: transform .15s, box-shadow .15s, opacity .2s }
    #chatFab:hover{ transform: translateY(-1px); box-shadow: 0 14px 28px rgba(0,0,0,.32) }
    #chatFab:active{ transform: translateY(0); box-shadow: 0 8px 18px rgba(0,0,0,.26) }
    #chatFab .badge{ position:absolute; right:-2px; top:-2px; min-width:18px; height:18px; padding:0 5px; display:none; align-items:center; justify-content:center; background:#ef4444; color:#fff; border-radius:9999px; font-size:11px; line-height:18px; box-shadow:0 2px 6px rgba(0,0,0,.18) }
    @media (max-width:480px){ #chatFab{ left:12px; bottom:calc(var(--mobile-nav-height) + 12px); width:44px; height:44px } }
  </style>
</head>
<body>
  <!-- é»‘è‰²æ¶ˆæ¯æŒ‰é’® -->
  <div id="chatFab">
    <span>ğŸ’¬</span>
    <div class="badge">0</div>
  </div>
  
  

  
  <div class="mobile-sidebar-overlay" id="mobileSidebarOverlay"></div>


  <div class="shell">
    <!-- å·¦ä¾§ï¼šä¼šè¯åˆ—è¡¨ï¼ˆå†…éƒ¨æ»šåŠ¨ .listï¼‰ -->
    <div class="panel threads">
      <div class="header">
        <div class="title">æ¶ˆæ¯</div>
        <div class="spacer"></div>
        <button class="btn" id="goHomeBtnLeft">è¿”å›ä¸»é¡µ</button>
      </div>
      <div class="search"><input id="searchEmail" type="email" placeholder="è¾“å…¥å¯¹æ–¹é‚®ç®±ï¼Œå›è½¦å‘èµ·ç§èŠ"/></div>
      <div id="threadList" class="list"></div>
    </div>

    <!-- å³ä¾§ï¼šèŠå¤©çª—å£ï¼ˆå†…éƒ¨æ»šåŠ¨ .chat-boxï¼‰ -->
    <div class="panel chat">
      <div class="header">
        <div class="title" id="chatTitle">é€‰æ‹©ä¸€ä¸ªä¼šè¯</div>
        <div class="spacer"></div>
        <button class="btn" id="goHomeBtnRight">è¿”å›ä¸»é¡µ</button>
        <button class="btn" id="newChatBtn">æ–°å»ºä¼šè¯</button>
      </div>

      <div id="attachPreview" class="attach-preview"></div>

      <div id="chatBox" class="chat-box">
        <div class="empty">å·¦ä¾§é€‰æ‹©è”ç³»äººï¼Œæˆ–ç‚¹å‡»â€œæ–°å»ºä¼šè¯â€ã€‚å¯ğŸ“é€‰æ‹©å›¾ç‰‡ã€ç²˜è´´å›¾ç‰‡æˆ–æŠŠå›¾ç‰‡æ‹–è¿›æ¥ã€‚</div>
      </div>

      <div class="composer">
        <button id="attachBtn" class="btn ghost" title="æ·»åŠ å›¾ç‰‡">ğŸ“</button>
        <input id="msgInput" type="text" placeholder="è¾“å…¥æ¶ˆæ¯ï¼Œå›è½¦å‘é€" disabled/>
        <button id="sendBtn" class="btn primary" disabled>å‘é€</button>
        <input id="fileInput" type="file" accept="image/*" multiple style="display:none"/>
      </div>
    </div>
  </div>

  <!-- Lightbox -->
  <div id="lightbox">
    <button id="lbClose" class="lb-btn">âœ•</button>
    <button id="lbPrev" class="lb-btn">â€¹</button>
    <img id="lbImg" src="" alt="preview"/>
    <button id="lbNext" class="lb-btn">â€º</button>
  </div>

  <script>
    // è‡ªåŠ¨æ£€æµ‹APIåŸºç¡€URL
    const BASE_URL = (() => {
      if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
        return 'http://127.0.0.1:3001';
      }
      return ''; // ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ç›¸å¯¹è·¯å¾„
    })();
    const SELF_URL = location.pathname;
    const $ = s => document.querySelector(s);
    const esc = s => String(s||'').replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    const isNearBottom = (el, px=40) => (el.scrollHeight - el.scrollTop - el.clientHeight) <= px;
    const toAbs = (u)=> !u ? '' : (/^https?:\/\//i.test(u) ? u : (u.startsWith('/') ? (BASE_URL+u) : (BASE_URL+'/'+u)));
    let ME=null, PEER=null, timer=null, forceScrollBottomOnce=false;

    // é€‰ä¸­å¾…å‘å›¾ç‰‡
    let selectedFiles = [], objectURLs = [];
    // Lightbox
    let LB_OPEN=false, LB_LIST=[], LB_INDEX=0;

    /* è‡ªåŠ¨æ¢æµ‹ä¸»é¡µè·¯å¾„ */
    const HOME_CANDIDATES=['/main%20page.html','/public/main%20page.html','/index.html','/public/index.html'];
    async function goHome(){
      for(const p of HOME_CANDIDATES){ try{ const r=await fetch(p,{cache:'no-store'}); if(r.ok){ location.href=p; return; } }catch{} }
      alert('æ‰¾ä¸åˆ°ä¸»é¡µï¼Œè¯·æ£€æŸ¥ HOME_CANDIDATESã€‚');
    }

    /* ç”¨æˆ·ä¿¡æ¯ç¼“å­˜ + æœªè¯»æœ¬åœ°è®°å½• */
    const userCache=new Map();
    const READ_KEY=(me,peer)=>`read:${(me||'').toLowerCase()}::${(peer||'').toLowerCase()}`;
    async function getUser(email){
      const k=String(email||'').toLowerCase().trim();
      if(!k) return null;
      if(userCache.has(k)) return userCache.get(k);
      try{
        const r=await fetch(`${BASE_URL}/api/users/by-email?email=${encodeURIComponent(k)}`,{credentials:'include'});
        if(!r.ok) throw 0;
        const u=await r.json(); userCache.set(k,u); return u;
      }catch{ const f={email:k,nickname:k,avatarPath:''}; userCache.set(k,f); return f; }
    }
    function getLastRead(me,peer){ return localStorage.getItem(READ_KEY(me,peer)) || '1970-01-01T00:00:00.000Z'; }
    function setLastRead(me,peer,iso){ localStorage.setItem(READ_KEY(me,peer), iso||new Date().toISOString()); }
    function updateBadge(peer,count){
      const item=document.querySelector(`.item[data-peer="${CSS.escape(peer)}"]`); if(!item) return;
      let b=item.querySelector('.badge'); if(!b){ b=document.createElement('div'); b.className='badge'; item.appendChild(b); }
      if(count>0){ b.textContent=count>99?'99+':String(count); b.style.display='inline-block'; } else b.style.display='none';
    }

    /* API */
    async function apiGetMe(){ const r=await fetch(BASE_URL+'/api/users/me',{credentials:'include'}); if(!r.ok) throw 0; return r.json(); }
    async function apiListThreads(){ const r=await fetch(BASE_URL+'/api/messages/threads',{credentials:'include'}); if(!r.ok) throw 0; return r.json(); }
    async function apiListMessages(peer){ const r=await fetch(`${BASE_URL}/api/messages?peer=${encodeURIComponent(peer)}`,{credentials:'include'}); if(!r.ok) throw 0; return r.json(); }

    // XHR å¸¦ä¸Šä¼ è¿›åº¦
    function sendWithProgress(peer,text,files,onProgress){
      return new Promise((resolve,reject)=>{
        const fd=new FormData();
        fd.append('toEmail',peer);
        fd.append('content',text||'');
        (files||[]).forEach(f=>fd.append('images',f));
        const xhr=new XMLHttpRequest();
        xhr.open('POST', BASE_URL+'/api/messages', true);
        xhr.withCredentials=true;
        xhr.upload.onprogress=e=>{
          if(e.lengthComputable && typeof onProgress==='function'){
            onProgress(Math.round(e.loaded*100/e.total), e.loaded, e.total);
          }
        };
        xhr.onload=()=>{
          if(xhr.status>=200 && xhr.status<300){
            try{ resolve(JSON.parse(xhr.responseText)); }catch{ resolve({ok:true}); }
          }else reject(new Error(`å‘é€å¤±è´¥ ${xhr.status} ${xhr.responseText||''}`));
        };
        xhr.onerror=()=>reject(new Error('ç½‘ç»œé”™è¯¯'));
        xhr.send(fd);
      });
    }

    /* æ¸²æŸ“ï¼šå·¦ä¾§ä¼šè¯ */
    async function renderThreads(list){
      const box=$('#threadList'); box.innerHTML='';
      const arr=Array.isArray(list)?list:[];
      for(const t of arr){
        const peer=String(t.peer||'').trim();
        const div=document.createElement('div');
        div.className='item'; div.dataset.peer=peer;
        div.innerHTML=`<div class="peerRow">
            <img class="avatar" src="" alt=""/><span class="peer">${esc(peer)}</span>
          </div>
          <div class="last">${esc(t.lastMessage||'ï¼ˆæ— æ¶ˆæ¯ï¼‰')}</div>
          <div class="badge" style="display:none"></div>`;
        div.onclick=()=>openChat(peer);
        box.appendChild(div);
        getUser(peer).then(u=>{
          const img=div.querySelector('.avatar'); const nm=div.querySelector('.peerRow .peer');
          if(img) img.src=u?.avatarPath||''; if(nm) nm.textContent=u?.nickname||peer;
        });
      }
      if(ME){
        for(const t of arr){
          const peer=String(t.peer||'').trim();
          try{
            const msgs=await apiListMessages(peer);
            const lastRead=new Date(getLastRead(ME.email,peer));
            const unread=msgs.filter(m=>String(m.to||'').toLowerCase()===String(ME.email||'').toLowerCase() && new Date(m.createdAt)>lastRead).length;
            updateBadge(peer, unread);
          }catch{}
        }
      }
    }

    /* æ¸²æŸ“ï¼šæ ‡é¢˜ */
    async function renderChatTitle(peer){
      const el=$('#chatTitle'); if(!peer){ el.textContent='é€‰æ‹©ä¸€ä¸ªä¼šè¯'; return; }
      const u=await getUser(peer);
      el.innerHTML=`<span style="display:flex;align-items:center;gap:10px;">
        <img class="avatar" style="width:32px;height:32px" src="${esc(u?.avatarPath||'')}" alt=""/>
        <span>ä¸ ${esc(u?.nickname||peer)} çš„èŠå¤©</span></span>`;
    }

    /* æ¸²æŸ“ï¼šæ¶ˆæ¯ï¼ˆå†…éƒ¨æ»šåŠ¨ + æ™ºèƒ½å¸åº• + å›¾ç‰‡ + Lightbox ç»‘å®šï¼‰ */
    async function renderMessages(arr){
      const box=$('#chatBox'); const list=Array.isArray(arr)?arr:[];
      const wasAtBottom=isNearBottom(box);
      if(!list.length){ box.innerHTML='<div class="empty">æš‚æ— æ¶ˆæ¯ã€‚</div>'; return; }
      
      // æŒ‰æ—¶é—´æ­£åºæ’åˆ—ï¼Œæœ€æ–°çš„æ¶ˆæ¯åœ¨ä¸‹æ–¹
      const sortedList = list.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
      
      box.innerHTML='';
      for(const m of sortedList){
        const mine=(m.from||'').toLowerCase()===(ME?.email||'').toLowerCase();
        const row=document.createElement('div'); row.className='msgrow '+(mine?'me':'peer');
        if(!mine){
          const u=await getUser(m.from); const av=document.createElement('img');
          av.className='avatar'; av.src=u?.avatarPath||''; av.alt=u?.nickname||m.from; row.appendChild(av);
        }
        const bubble=document.createElement('div'); bubble.className='msg '+(mine?'me':'peer');
        const displayName=(await getUser(m.from))?.nickname||m.from;
        let html='';
        if(m.content && m.content.trim()) html+=`<div>${esc(m.content)}</div>`;
        if(Array.isArray(m.images)&&m.images.length){
          const abs=m.images.map(u=>toAbs(u));
          const imgs=abs.map(u=>`<img src="${esc(u)}" alt="" data-msg-images="${esc(abs.join('|'))}" onclick="return false;">`).join('');
          html+=`<div class="img-grid">${imgs}</div>`;
        }
        html+=`<div class="meta">${esc(displayName)} Â· ${new Date(m.createdAt||Date.now()).toLocaleString()}</div>`;
        bubble.innerHTML=html; row.appendChild(bubble); box.appendChild(row);
      }
      // å›¾ç‰‡ç‚¹å‡» â†’ Lightbox
      box.querySelectorAll('.img-grid img').forEach(img=>{
        img.addEventListener('click', e=>{
          const listStr=e.currentTarget.getAttribute('data-msg-images')||'';
          const list=listStr.split('|').filter(Boolean);
          const idx=list.indexOf(e.currentTarget.src);
          openLightbox(list, Math.max(0, idx));
        });
      });
      if(wasAtBottom || forceScrollBottomOnce) box.scrollTop=box.scrollHeight;
      forceScrollBottomOnce=false;
    }

    /* é™„ä»¶é¢„è§ˆ */
    function renderAttachPreview(){
      const bar=$('#attachPreview'); bar.innerHTML='';
      if(!selectedFiles.length){ bar.style.display='none'; return; }
      bar.style.display='flex';
      selectedFiles.forEach((f,idx)=>{
        const url=URL.createObjectURL(f); objectURLs.push(url);
        const div=document.createElement('div'); div.className='thumb';
        div.innerHTML=`<img src="${url}" alt=""><div class="x" title="ç§»é™¤">Ã—</div>`;
        div.querySelector('.x').onclick=()=>{ selectedFiles.splice(idx,1); clearObjectURLs(); renderAttachPreview(); };
        bar.appendChild(div);
      });
    }
    function clearObjectURLs(){ objectURLs.forEach(u=>URL.revokeObjectURL(u)); objectURLs=[]; }
    function clearAttachments(){ selectedFiles=[]; clearObjectURLs(); renderAttachPreview(); const fi=$('#fileInput'); if(fi) fi.value=''; }
    function takeImageFiles(listLike){
      const acc=[]; for(const item of listLike){ const f=item.kind==='file'?item.getAsFile?.():item; if(!f) continue; if(f.type && !/^image\//i.test(f.type)) continue; acc.push(f); }
      return acc;
    }

    /* å‘é€ä¸­çš„ä¸´æ—¶æ°”æ³¡ï¼ˆè¿›åº¦/é‡è¯•ï¼‰ */
    function createSendingBubble(text,files){
      const box=$('#chatBox');
      const row=document.createElement('div'); row.className='msgrow me';
      const bubble=document.createElement('div'); bubble.className='msg me sending';
      let html=''; if(text && text.trim()) html+=`<div>${esc(text)}</div>`;
      if(files && files.length){
        const urls=files.map(f=>URL.createObjectURL(f)); urls.forEach(u=>objectURLs.push(u));
        const imgs=urls.map(u=>`<img src="${u}" alt="" style="width:120px;height:120px;object-fit:cover;border-radius:10px;border:1px solid #e5e7eb;margin-top:6px;margin-right:6px">`).join('');
        html+=`<div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:6px">${imgs}</div>`;
      }
      html+=`<div class="prog"><div class="bar" style="width:0%"></div></div>`;
      bubble.innerHTML=html; row.appendChild(bubble); box.appendChild(row); box.scrollTop=box.scrollHeight;
      return {
        el:row,
        setProgress(p){ const bar=row.querySelector('.bar'); if(bar) bar.style.width=Math.max(0,Math.min(100,p))+'%'; },
        markFailed(onRetry){
          const b=row.querySelector('.prog'); if(b) b.remove();
          bubble.classList.remove('sending'); bubble.classList.add('failed');
          const act=document.createElement('div'); act.className='actions';
          const r=document.createElement('button'); r.className='btn retry'; r.textContent='é‡è¯•';
          const c=document.createElement('button'); c.className='btn cancel'; c.textContent='å–æ¶ˆ';
          r.onclick=onRetry; c.onclick=()=>row.remove(); act.appendChild(r); act.appendChild(c); bubble.appendChild(act);
        },
        remove(){ row.remove(); }
      }
    }

    /* Lightbox */
    function openLightbox(list,index=0){ LB_LIST=list||[]; LB_INDEX=Math.max(0,Math.min(LB_LIST.length-1,index)); if(!LB_LIST.length) return; $('#lbImg').src=LB_LIST[LB_INDEX]; $('#lightbox').classList.add('open'); LB_OPEN=true; }
    function lbClose(){ $('#lightbox').classList.remove('open'); LB_OPEN=false; }
    function lbPrev(){ if(!LB_OPEN) return; LB_INDEX=(LB_INDEX-1+LB_LIST.length)%LB_LIST.length; $('#lbImg').src=LB_LIST[LB_INDEX]; }
    function lbNext(){ if(!LB_OPEN) return; LB_INDEX=(LB_INDEX+1)%LB_LIST.length; $('#lbImg').src=LB_LIST[LB_INDEX]; }

    /* åˆ·æ–° */
    async function refreshThreads(){ const ts=await apiListThreads(); await renderThreads(ts); }
    async function refreshMessages(){ if(!PEER) return; const arr=await apiListMessages(PEER); await renderMessages(arr); }

    async function openChat(peer){
      const p=String(peer||'').trim(); if(!p){ alert('è¯·å…ˆé€‰æ‹©æˆ–è¾“å…¥å¯¹æ–¹é‚®ç®±'); return; }
      PEER=p; await renderChatTitle(PEER); enableComposer(true);
      forceScrollBottomOnce=true; await refreshMessages();
      if(ME && PEER){ setLastRead(ME.email,PEER,new Date().toISOString()); updateBadge(PEER,0); }
      clearInterval(timer); timer=setInterval(async()=>{ await refreshMessages(); if(ME && PEER) updateBadge(PEER,0); },5000);
      history.replaceState({},'',`${SELF_URL}?to=${encodeURIComponent(PEER)}`);
    }
    function enableComposer(on){ $('#msgInput').disabled=!on; $('#sendBtn').disabled=!on; $('#attachBtn').disabled=!on; if(on) $('#msgInput').focus(); }

    /* å¯åŠ¨ */
    async function boot(){
      try{ ME=await apiGetMe(); }catch{ alert('è¯·å…ˆç™»å½•'); return; }
      try{ await refreshThreads(); }catch(e){ console.warn('threads error',e); }

      const urlPeer=new URL(location.href).searchParams.get('to'); if(urlPeer){ openChat(urlPeer); }

      // å‘é€ï¼ˆå¸¦è¿›åº¦ + å¤±è´¥é‡è¯• + çŠ¶æ€æ¢å¤ï¼‰
      $('#sendBtn').addEventListener('click', async ()=>{
        const btn=$('#sendBtn'), input=$('#msgInput');
        const text=(input.value||'').trim(); const files=selectedFiles.slice();
        if(!text && files.length===0){ input.focus(); return; }
        let peer=(PEER||'').trim();
        if(!peer){ const raw=prompt('è¯·è¾“å…¥å¯¹æ–¹é‚®ç®±ï¼š'); const to=(raw||'').trim(); if(!to) return; await openChat(to); peer=to; }
        const temp=createSendingBubble(text,files);
        const old=btn.textContent; btn.disabled=true; input.disabled=true; $('#attachBtn').disabled=true; btn.textContent='å‘é€ä¸­â€¦';
        try{
          await sendWithProgress(peer,text,files,p=>temp.setProgress(p));
          input.value=''; clearAttachments(); forceScrollBottomOnce=true; await refreshMessages(); await refreshThreads(); temp.remove();
        }catch(err){
          console.error('[send error]',err);
          temp.markFailed(async ()=>{
            try{
              btn.disabled=true; input.disabled=true; $('#attachBtn').disabled=true; btn.textContent='é‡è¯•ä¸­â€¦';
              await sendWithProgress(peer,text,files,p=>temp.setProgress(p));
              forceScrollBottomOnce=true; await refreshMessages(); await refreshThreads(); temp.remove();
            }catch(e2){ console.error('[retry error]',e2); alert('é‡è¯•å¤±è´¥ï¼š'+(e2?.message||e2)); }
            finally{ btn.textContent='å‘é€'; btn.disabled=false; input.disabled=false; $('#attachBtn').disabled=false; input.focus(); }
          });
          alert('å‘é€å¤±è´¥ï¼š'+(err?.message||err));
        }finally{ btn.textContent='å‘é€'; btn.disabled=false; input.disabled=false; $('#attachBtn').disabled=false; input.focus(); }
      });

      // å›è½¦å‘é€
      $('#msgInput').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); $('#sendBtn').click(); } });

      // æ–°å»ºä¼šè¯
      $('#newChatBtn').addEventListener('click', ()=>{ const raw=prompt('è¾“å…¥å¯¹æ–¹é‚®ç®±ï¼š'); const to=(raw||'').trim(); if(to) openChat(to); });

      // å·¦ä¾§æœç´¢å›è½¦
      $('#searchEmail').addEventListener('keydown', e=>{ if(e.key==='Enter'){ const v=(e.target.value||'').trim(); if(v){ openChat(v); e.target.value=''; } } });

      // è¿”å›ä¸»é¡µ
      $('#goHomeBtnLeft')?.addEventListener('click', goHome);
      $('#goHomeBtnRight')?.addEventListener('click', goHome);

      // é€‰æ‹©/ç²˜è´´/æ‹–æ‹½å›¾ç‰‡
      $('#attachBtn').addEventListener('click', ()=>$('#fileInput').click());
      $('#fileInput').addEventListener('change', e=>{ selectedFiles=Array.from(e.target.files||[]); clearObjectURLs(); renderAttachPreview(); });
      document.addEventListener('paste', e=>{ const files=takeImageFiles(e.clipboardData?.items||[]); if(files.length){ selectedFiles=selectedFiles.concat(files).slice(0,9); clearObjectURLs(); renderAttachPreview(); } });
      [$('#chatBox'), document.body].forEach(t=>{
        t.addEventListener('dragover', e=>e.preventDefault());
        t.addEventListener('drop', e=>{ e.preventDefault(); const files=takeImageFiles(e.dataTransfer?.items||e.dataTransfer?.files||[]); if(files.length){ selectedFiles=selectedFiles.concat(files).slice(0,9); clearObjectURLs(); renderAttachPreview(); } });
      });

      // Lightbox æ§ä»¶
      $('#lbClose').addEventListener('click', lbClose);
      $('#lbPrev').addEventListener('click', lbPrev);
      $('#lbNext').addEventListener('click', lbNext);
      $('#lightbox').addEventListener('click', e=>{ if(e.target.id==='lightbox') lbClose(); });
      window.addEventListener('keydown', e=>{ if(!LB_OPEN) return; if(e.key==='Escape') lbClose(); else if(e.key==='ArrowLeft') lbPrev(); else if(e.key==='ArrowRight') lbNext(); });
    }
    window.addEventListener('DOMContentLoaded', boot);
  </script>
  <!-- é¡¶éƒ¨å¯¼èˆªäº¤äº’JavaScript -->
  <script>
  /* é¡¶éƒ¨å¯¼èˆªäº¤äº’åŠŸèƒ½ */
  (function(){
    const topNavButton = document.getElementById('topNavButton');
    const topNavMenu = document.getElementById('topNavMenu');
    const topNavOverlay = document.getElementById('topNavOverlay');
    const closeNavBtn = document.getElementById('closeNavBtn');
    const mobileNavLinks = document.querySelectorAll('.mobile-nav-link');

    // é¡¶éƒ¨å¯¼èˆªæŒ‰é”®ç‚¹å‡»äº‹ä»¶
    if(topNavButton && topNavMenu && topNavOverlay) {
      topNavButton.addEventListener('click', () => {
        console.log('é¡¶éƒ¨å¯¼èˆªæŒ‰é”®è¢«ç‚¹å‡»'); // è°ƒè¯•æ—¥å¿—
        topNavMenu.classList.add('active');
        topNavOverlay.classList.add('active');
        document.body.style.overflow = 'hidden';
      });

      // å…³é—­æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      if(closeNavBtn) {
        closeNavBtn.addEventListener('click', () => {
          topNavMenu.classList.remove('active');
          topNavOverlay.classList.remove('active');
          document.body.style.overflow = '';
        });
      }

      // ç‚¹å‡»é®ç½©å…³é—­å¯¼èˆªèœå•
      topNavOverlay.addEventListener('click', () => {
        topNavMenu.classList.remove('active');
        topNavOverlay.classList.remove('active');
        document.body.style.overflow = '';
      });

      // ESCé”®å…³é—­å¯¼èˆªèœå•
      document.addEventListener('keydown', (e) => {
        if(e.key === 'Escape' && topNavMenu.classList.contains('active')) {
          topNavMenu.classList.remove('active');
          topNavOverlay.classList.remove('active');
          document.body.style.overflow = '';
        }
      });
    } else {
      console.warn('é¡¶éƒ¨å¯¼èˆªå…ƒç´ æœªæ‰¾åˆ°:', { topNavButton, topNavMenu, topNavOverlay });
    }

    // ç§»åŠ¨ç«¯å¯¼èˆªé“¾æ¥ç‚¹å‡»äº‹ä»¶
    mobileNavLinks.forEach(link => {
      link.addEventListener('click', () => {
        // ç§»é™¤æ‰€æœ‰activeç±»
        mobileNavLinks.forEach(l => l.classList.remove('active'));
        // æ·»åŠ activeç±»åˆ°å½“å‰ç‚¹å‡»çš„é“¾æ¥
        link.classList.add('active');
      });
    });

    // è§¦æ‘¸æ‰‹åŠ¿æ”¯æŒ
    let startX = 0;
    let startY = 0;
    let currentX = 0;
    let currentY = 0;

    document.addEventListener('touchstart', (e) => {
      startX = e.touches[0].clientX;
      startY = e.touches[0].clientY;
    });

    document.addEventListener('touchmove', (e) => {
      currentX = e.touches[0].clientX;
      currentY = e.touches[0].clientY;
    });

    document.addEventListener('touchend', () => {
      const deltaX = currentX - startX;
      const deltaY = currentY - startY;
      const minSwipeDistance = 50;

      // ä»å·¦å‘å³æ»‘åŠ¨æ‰“å¼€å¯¼èˆªèœå•
      if(deltaX > minSwipeDistance && Math.abs(deltaY) < Math.abs(deltaX) && startX < 50) {
        if(topNavMenu && !topNavMenu.classList.contains('active')) {
          topNavMenu.classList.add('active');
          topNavOverlay.classList.add('active');
          document.body.style.overflow = 'hidden';
        }
      }
      // ä»å³å‘å·¦æ»‘åŠ¨å…³é—­å¯¼èˆªèœå•
      else if(deltaX < -minSwipeDistance && Math.abs(deltaY) < Math.abs(deltaX) && topNavMenu && topNavMenu.classList.contains('active')) {
        topNavMenu.classList.remove('active');
        topNavOverlay.classList.remove('active');
        document.body.style.overflow = '';
      }
    });
  })();</script>
</body>
</html>
