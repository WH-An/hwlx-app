<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æµ·å¤–ç•™å­¦ Â· åˆ†äº«</title>
  <!-- ç§»åŠ¨ç«¯ä¼˜åŒ–CSS -->
  <link rel="stylesheet" href="mobile-optimization.css">
  

  <style>
    :root{--bg:#0b0f14; --panel:#ffffff; --text:#0f172a; --muted:#64748b; --accent:#16a34a; --border:#e5e7eb; --shadow:0 10px 30px rgba(0,0,0,.18); --radius:18px;}
    *{box-sizing:border-box} html,body{height:100%;overflow:visible !important}
    body{margin:0;font-family:'Microsoft YaHei',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'PingFang SC',sans-serif;
      background:radial-gradient(1200px 600px at 10% -10%,#1f8db8 18%, transparent 60%),
                 radial-gradient(900px 500px at 110% 110%,#2bb8d6 12%, transparent 60%),var(--bg);
      color:#fff;overflow:visible;}
    .container{display:grid;grid-template-columns:220px 1fr;gap:18px;height:100vh;padding:24px}
    .sidebar{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px 16px;color:var(--text);display:flex;flex-direction:column;gap:16px}
    .account-info{display:flex;flex-direction:column;align-items:center;gap:10px;text-decoration:none;color:inherit;border:1px dashed #eef2ff;border-radius:14px;padding:14px;background:#fff}
    .avatar{width:56px;height:56px;border-radius:50%;object-fit:cover}
    .username{font-weight:700}
    .nav-list{list-style:none;margin:6px 0 0;padding:0;display:flex;flex-direction:column;gap:10px}
    .nav-list a{display:flex;align-items:center;gap:10px;text-decoration:none;color:var(--text);border:1px solid var(--border);background:#fafafa;border-radius:12px;padding:10px 14px;transition:.2s}
    .nav-list a:hover{background:#f3f4f6;transform:translateY(-1px)}
    .nav-icon{width:22px;display:inline-flex;justify-content:center}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px;color:var(--text);display:flex;flex-direction:column;gap:14px;height:100%;overflow-y:auto}
    .search-box{display:flex;gap:10px;flex-shrink:0}
    .search-box input{flex:1;padding:10px 14px;border:1px solid var(--border);border-radius:12px;font-size:15px;outline:none}
    .search-box button{padding:10px 16px;border:none;border-radius:12px;background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
    .search-box button:hover{background:#15803d}
    .panel-header{display:flex;align-items:center;gap:12px;flex-shrink:0}
    .panel-title{font-size:18px;font-weight:800;margin:0}
    .panel-header .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;cursor:pointer;border:1px solid var(--border);background:#fff;color:#111827;border-radius:12px;padding:8px 12px;font-weight:700;transition:.2s}
    .btn:hover{background:#f3f4f6}

    /* === Masonryï¼šå¤šåˆ—å¸ƒå±€ï¼Œæ˜¾è‘—å‡å°‘ç©ºç™½ === */
    .masonry{ column-count: 3; column-gap: 14px; }
    @media (max-width: 1200px){ .masonry{ column-count: 2; } }
    @media (max-width: 640px){  .masonry{ column-count: 1; } }

    /* å¡ç‰‡åœ¨åˆ—ä¸­æ’åˆ—ï¼Œå¹¶ä¸ºå¾½ç« é¢„ç•™åº•éƒ¨ç©ºé—´ */
    .card{
      position: relative;
      display: inline-block;
      width: 100%;
      margin: 0 0 14px;
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 6px 18px rgba(0,0,0,.06);
      padding-bottom: 46px;
      break-inside: avoid; -webkit-column-break-inside: avoid; page-break-inside: avoid;

      /* å¯ç‚¹å‡»åé¦ˆ */
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .card[role="link"]{ cursor:pointer; }
    .card[role="link"]:hover{ transform: translateY(-2px); box-shadow:0 10px 24px rgba(0,0,0,.12); }

    .card img{ width: 100%; display: block; aspect-ratio: 4 / 5; object-fit: cover; }
    .card-text{padding:10px 12px;color:#374151;line-height:1.6}

    /* ä½œè€…å¾½ç« ï¼šä¸‹ç§»ï¼Œä¸å†…å®¹åº•åŸºæœ¬é½å¹³ */
    .author-badge{
      position:absolute; right:10px; bottom:8px;
      display:flex; align-items:center; gap:8px;
      background:rgba(255,255,255,.92); border:1px solid var(--border);
      padding:6px 8px; border-radius:999px; box-shadow:0 4px 12px rgba(0,0,0,.10);
      max-width:80%; cursor:pointer;
    }
    .author-badge img{width:22px;height:22px;border-radius:50%;object-fit:cover}
    .author-badge .name{font-size:12px;color:#111827;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:150px}

    #chatFab { position: fixed; left: 16px; bottom: calc(var(--mobile-nav-height) + 16px);
      width: 48px; height: 48px; border-radius: 9999px;
      display: flex; align-items: center; justify-content: center;
      background: #0f172a; color: #fff; border: 1px solid rgba(255,255,255,.15);
      box-shadow: 0 10px 24px rgba(0,0,0,.28);
      cursor: pointer; user-select: none; z-index: 9999;
      transition: transform .15s ease, box-shadow .15s ease, opacity .2s ease;
    }
    #chatFab:hover{ transform: translateY(-1px); box-shadow: 0 14px 28px rgba(0,0,0,.32); }
    #chatFab:active{ transform: translateY(0); box-shadow: 0 8px 18px rgba(0,0,0,.26); }
    #chatFab .badge{
      position: absolute; right: -2px; top: -2px;
      min-width: 18px; height: 18px; padding: 0 5px;
      display: none; align-items: center; justify-content: center;
      background: #ef4444; color: #fff; border-radius: 9999px;
      font-size: 11px; line-height: 18px; box-shadow: 0 2px 6px rgba(0,0,0,.18);
    }
    @media (max-width: 480px) { #chatFab { left: 12px; bottom: calc(var(--mobile-nav-height) + 12px); width: 44px; height: 44px; }
    }
  

    /* ç§»åŠ¨ç«¯å“åº”å¼ä¼˜åŒ– */
    @media (max-width: 960px) {
      .container {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
        padding: 16px;
        padding-bottom: calc(var(--mobile-nav-height) + 20px);
      }
      
      .sidebar {
        display: none;
      }
      
      .panel {
        padding: 16px;
        border-radius: 16px;
      }
      
      .search-box {
        flex-direction: column;
        gap: 12px;
      }
      
      .search-box input {
        padding: 14px 16px;
        font-size: 16px;
      }
      
      .search-box button {
        padding: 14px 16px;
        font-size: 16px;
      }
      
      .panel-title {
        font-size: 20px;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: 12px;
        padding-bottom: calc(var(--mobile-nav-height) + 16px);
      }
      
      .panel {
        padding: 12px;
        border-radius: 12px;
      }
      
      .search-box input {
        padding: 16px;
        font-size: 16px;
      }
      
      .search-box button {
        padding: 16px;
        font-size: 16px;
      }
      
      .panel-title {
        font-size: 18px;
      }
      
      .card {
        border-radius: 12px;
        margin-bottom: 12px;
      }
      
      .card-text {
        padding: 12px;
        font-size: 14px;
      }
    }
</style>
</head>
<body>
  <!-- æ±‰å ¡èœå•æŒ‰é’® -->
  <div class="hamburger" id="hamburger">
    <span></span>
    <span></span>
    <span></span>
  </div>

  <!-- ç§»åŠ¨ç«¯ä¾§è¾¹æ  -->
  <div class="mobile-sidebar" id="mobileSidebar">
    <a class="account-info" href="profile.html">
      <img src="https://raw.githubusercontent.com/WH-An/hwlx-app/2df4e97b395bebb7977074fbb31741f3c35da9a0/assets-task_01k3v2vy06fra8er06x602xnpe-1756476933_img_1.webp" alt="å¤´åƒ" class="avatar">
      <span class="username">æˆ‘çš„è´¦å·</span>
    </a>
    <ul class="nav-list">
      <li><a href="main page.html"><span class="nav-icon">ğŸ </span><span>ä¸»é¡µ</span></a></li>
      <li><a href="life-tips.html"><span class="nav-icon">ğŸ’¡</span><span>ç”Ÿæ´»å°è´´å£«</span></a></li>
      <li><a href="study-guide.html"><span class="nav-icon">ğŸ“š</span><span>å­¦ä¹ æŒ‡å¯¼</span></a></li>
      <li><a href="enrollment-steps.html"><span class="nav-icon">ğŸ“</span><span>å…¥å­¦æ­¥éª¤</span></a></li>
      <li><a href="share.html"><span class="nav-icon">ğŸ”—</span><span>åˆ†äº«</span></a></li>
      <li><a href="fun.html"><span class="nav-icon">ğŸ‰</span><span>å¨±ä¹</span></a></li>
      <li><a href="hospital.html"><span class="nav-icon">ğŸ¥</span><span>åŒ»é™¢</span></a></li>
    </ul>
  </div>

  <!-- ç§»åŠ¨ç«¯ä¾§è¾¹æ é®ç½© -->
  <div class="mobile-sidebar-overlay" id="mobileSidebarOverlay"></div>


  <div class="container">
    <div class="sidebar">
      <a class="account-info" href="profile.html">
        <img src="" alt="å¤´åƒ" class="avatar"><span class="username">æˆ‘çš„è´¦å·</span>
      </a>
      <ul class="nav-list">
        <li><a href="main page.html"><span class="nav-icon">ğŸ </span><span>ä¸»é¡µ</span></a></li>
        <li><a href="life-tips.html"><span class="nav-icon">ğŸ’¡</span><span>ç”Ÿæ´»å°è´´å£«</span></a></li>
        <li><a href="study-guide.html"><span class="nav-icon">ğŸ“š</span><span>å­¦ä¹ æŒ‡å¯¼</span></a></li>
        <li><a href="enrollment-steps.html"><span class="nav-icon">ğŸ“</span><span>å…¥å­¦æ­¥éª¤</span></a></li>
        <li><a href="share.html"><span class="nav-icon">ğŸ”—</span><span>åˆ†äº«</span></a></li>
        <li><a href="fun.html"><span class="nav-icon">ğŸ‰</span><span>å¨±ä¹</span></a></li>
        <li><a href="hospital.html"><span class="nav-icon">ğŸ¥</span><span>åŒ»é™¢</span></a></li>
      </ul>
    </div>

    <div class="panel">
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="æœç´¢åˆ†äº«..."><button onclick="doSearch()">æœç´¢</button>
      </div>
      <div class="panel-header">
        <h2 class="panel-title">åˆ†äº«</h2>
        <div class="spacer"></div>
        <a class="btn" href="publish.html" title="å»å‘å¸ƒ">ï¼‹ å»å‘å¸ƒ</a>
      </div>
      <div class="masonry" id="masonry"></div>
    </div>
  </div>

  <script>
    // è‡ªåŠ¨æ£€æµ‹APIåŸºç¡€URL
    const API_BASE = (() => {
      if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
        return 'http://127.0.0.1:3001';
      }
      return ''; // ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ç›¸å¯¹è·¯å¾„
    })();
    const CATEGORY='share';
    let allPosts=[];

            const FALLBACK_AVA='https://raw.githubusercontent.com/WH-An/hwlx-app/2df4e97b395bebb7977074fbb31741f3c35da9a0/assets-task_01k3v2vy06fra8er06x602xnpe-1756476933_img_1.webp';

    function toAbs(u){ if(!u)return''; if(/^https?:\/\//i.test(u))return u; return u.startsWith('/')?API_BASE+u:API_BASE+'/'+u; }
    function getPostId(p){ return String(p._id || p.id || p.postId || p.slug || p.uuid || ''); }

    async function hydrateUser(){
      try{
        const avatarEl=document.querySelector('.avatar'), nameEl=document.querySelector('.username');
        const FALLBACK='https://raw.githubusercontent.com/WH-An/hwlx-app/2df4e97b395bebb7977074fbb31741f3c35da9a0/assets-task_01k3v2vy06fra8er06x602xnpe-1756476933_img_1.webp';
        
        // å¼ºåˆ¶ä»æœåŠ¡å™¨è·å–æœ€æ–°ç”¨æˆ·ä¿¡æ¯
        try{
          const res = await fetch(`${API_BASE}/api/users/me`, { 
            credentials:'include',
            cache: 'no-cache' // ç¦ç”¨ç¼“å­˜ï¼Œç¡®ä¿è·å–æœ€æ–°æ•°æ®
          });
          if(res.ok){
            const u = await res.json();
            const name = u.nickname || u.username || u.displayName || u.name || u.email || 'æˆ‘çš„è´¦å·';
            let avatar = u.avatarPath || u.avatarUrl || u.avatar || '';
            if(avatar && !/^https?:\/\//i.test(avatar)) {
              avatar = avatar.startsWith('/') ? API_BASE + avatar : API_BASE + '/' + avatar;
            }
            nameEl.textContent = name;
            nameEl.title = name;
            avatarEl.onerror = () => { avatarEl.src = FALLBACK };
            avatarEl.src = avatar || FALLBACK;
            avatarEl.alt = name;
            
            // æ›´æ–°localStorage
            localStorage.setItem('currentUser', JSON.stringify(u));
            return;
          }
        }catch(e){
          console.warn('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', e);
        }
        
        // å¦‚æœæœåŠ¡å™¨è·å–å¤±è´¥ï¼Œå›é€€åˆ°localStorage
        const raw = localStorage.getItem('currentUser');
        if(!raw){
          nameEl.textContent = 'æˆ‘çš„è´¦å·';
          avatarEl.src = FALLBACK;
          return;
        }
        const u = JSON.parse(raw) || {};
        const name = u.nickname || u.username || u.displayName || u.name || u.email || 'æˆ‘çš„è´¦å·';
        let avatar = u.avatarPath || u.avatarUrl || u.avatar || '';
        if(avatar && !/^https?:\/\//i.test(avatar)) {
          avatar = avatar.startsWith('/') ? API_BASE + avatar : API_BASE + '/' + avatar;
        }
        nameEl.textContent = name;
        nameEl.title = name;
        avatarEl.onerror = () => { avatarEl.src = FALLBACK };
        avatarEl.src = avatar || FALLBACK;
        avatarEl.alt = name;
      }catch(e){
        console.warn('hydrateUser error:', e);
      }
    }

    function extractAuthor(p){
      const u=p.user||p.author||p.owner||{};
      let name=(p.authorName||u.nickname||u.username||u.displayName||u.name||p.username||p.email||'').trim();
      let avatar=(p.authorAvatar||u.avatarPath||u.avatarUrl||u.avatar||p.avatar||'').trim();
      const email=(p.authorEmail||u.email||'').trim();
      if(!name) name='åŒ¿åç”¨æˆ·';
      if(avatar&&!/^https?:\/\//i.test(avatar)) avatar=toAbs(avatar);
      return {name,avatar,email};
    }

    function renderPosts(list){
      const box=document.getElementById('masonry'); 
      box.innerHTML='';
      (list||[]).forEach(p=>{
        const card=document.createElement('div'); 
        card.className='card';

        // ç½®é¡¶æ ‡è®°
        if(p.pinned){
          const pinBadge = document.createElement('div');
          pinBadge.style.cssText = `
            position: absolute;
            top: 8px;
            left: 8px;
            background: #16a34a;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
          `;
          pinBadge.textContent = 'ğŸ“Œ ç½®é¡¶';
          card.appendChild(pinBadge);
        }

                // å›¾ç‰‡ - åªæ˜¾ç¤ºç¬¬ä¸€å¼ 
        if(p.images && p.images.length > 0){
          const img=document.createElement('img');
          img.loading='lazy';
          img.src=toAbs(p.images[0]);
          img.alt=p.title||'å›¾ç‰‡';
          img.onerror=()=>{ img.remove(); };
          card.appendChild(img);
        }

                        // åªæ˜¾ç¤ºæ ‡é¢˜
        if(p.title){
          const title=document.createElement('div');
          title.className='card-title';
          title.style.cssText = 'font-weight: 700; font-size: 16px; margin-bottom: 8px; color: #111827; padding: 10px 12px;';
          title.textContent=p.title;
          card.appendChild(title);
        }

        // ä½œè€…å¾½ç« ï¼ˆç‚¹å‡»å¾½ç« ä¸è§¦å‘æ•´å¡è·³è½¬ï¼‰
        const {name,avatar,email}=extractAuthor(p);
        const badge=document.createElement('div'); 
        badge.className='author-badge';
        badge.addEventListener('click',e=>e.stopPropagation()); // é˜»æ­¢å†’æ³¡

        const head=document.createElement('img');
        head.alt=name;
        head.onerror=()=>{head.src=FALLBACK_AVA};
        head.src=avatar||FALLBACK_AVA;

        const span=document.createElement('span'); 
        span.className='name'; 
        span.textContent=name;

        if (email){
          const a=document.createElement('a');
          a.href=`profile.html?email=${encodeURIComponent(email)}`;
          a.title=`æŸ¥çœ‹ ${name} çš„ä¸»é¡µ`;
          a.appendChild(head);
          badge.appendChild(a);
        }else{
          badge.appendChild(head);
        }
        badge.appendChild(span);
        card.appendChild(badge);

        // === è¯¦æƒ…é¡µè·³è½¬ï¼šæ•´å¡å¯ç‚¹å‡» ===
        const pid = getPostId(p);
        if (pid){
          const go = () => location.href = `post.html?id=${encodeURIComponent(pid)}`;
          card.setAttribute('role','link');
          card.tabIndex = 0;
          card.addEventListener('click', go);
          card.addEventListener('keydown', e=>{ if(e.key==='Enter') go(); });
        }

        box.appendChild(card);
      });
    }

    async function loadPosts(){try{
      const r=await fetch(`${API_BASE}/api/posts?category=${encodeURIComponent(CATEGORY)}`,{credentials:'include'});
      allPosts=await r.json();

      // å…œåº•è¿‡æ»¤ï¼ˆåç«¯è‹¥æœªå®ç° ?categoryï¼‰
      try{
        const c=(CATEGORY||'').toLowerCase();
        if(c){
          allPosts=(allPosts||[]).filter(p=>String(p.category||p.cat||p.type||'').toLowerCase()===c);
        }
      }catch{}

      // æ’åºï¼šç½®é¡¶å¸–å­ä¼˜å…ˆï¼Œç„¶åæŒ‰æ—¶é—´å€’åº
      allPosts = (allPosts || []).sort((a, b) => {
        const aPinned = Boolean(a.pinned);
        const bPinned = Boolean(b.pinned);
        if (aPinned !== bPinned) {
          return bPinned ? 1 : -1; // ç½®é¡¶çš„æ’åœ¨å‰é¢
        }
        // åŒç½®é¡¶çŠ¶æ€ä¸‹ï¼ŒæŒ‰æ—¶é—´å€’åº
        const aTime = new Date(a.createdAt || a.time || 0);
        const bTime = new Date(b.createdAt || b.time || 0);
        return bTime - aTime;
      });

      renderPosts(allPosts);
    }catch(e){console.warn(e); renderPosts([]);}}

    function doSearch(){
      const q=document.getElementById('searchInput').value.trim().toLowerCase();
      if(!q) return renderPosts(allPosts);
      renderPosts(allPosts.filter(p=>(p.title&&p.title.toLowerCase().includes(q))||(p.desc&&p.desc.toLowerCase().includes(q))));
    }

    window.onload=async ()=>{await hydrateUser();loadPosts();document.getElementById('searchInput').addEventListener('keydown',e=>{if(e.key==='Enter')doSearch();});};

    (function(){
      // è‡ªåŠ¨æ£€æµ‹APIåŸºç¡€URL
      const BASE_URL = (() => {
        if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
          return 'http://127.0.0.1:3001';
        }
        return ''; // ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ç›¸å¯¹è·¯å¾„
      })();
      const MESSAGES_PATH = '/messages.html';

      let fab = document.getElementById('chatFab');
      if(!fab){
        fab = document.createElement('button');
        fab.id = 'chatFab';
        fab.setAttribute('aria-label','æ¶ˆæ¯');
        fab.title = 'æ¶ˆæ¯';
        fab.innerHTML = 'ğŸ’¬';
        const badge = document.createElement('span');
        badge.className = 'badge';
        fab.appendChild(badge);
        fab.addEventListener('click', ()=> location.href = MESSAGES_PATH);
        document.body.appendChild(fab);
      }
      const badgeEl = fab.querySelector('.badge');

      const READ_KEY = (me, peer) => `read:${(me||'').toLowerCase()}::${(peer||'').toLowerCase()}`;

      async function apiMe(){
        const r = await fetch(BASE_URL + '/api/users/me', { credentials:'include' });
        if(!r.ok) throw new Error('æœªç™»å½•');
        return r.json();
      }
      async function apiThreads(){
        const r = await fetch(BASE_URL + '/api/messages/threads', { credentials:'include' });
        if(!r.ok) throw new Error('threads ' + r.status);
        return r.json();
      }
      async function apiDialog(peer){
        const r = await fetch(BASE_URL + '/api/messages?peer=' + encodeURIComponent(peer), { credentials:'include' });
        if(!r.ok) throw new Error('dialog ' + r.status);
        return r.json();
      }

      async function computeUnreadTotal(){
        let me;
        try { me = await apiMe(); }
        catch { setBadge(0); return; }

        const meMail = (me.email||'').toLowerCase();
        let total = 0;

        let threads = [];
        try { threads = await apiThreads(); }
        catch { setBadge(0); return; }

        for(const t of threads){
          const peer = (t.peer||'').trim();
          try{
            const msgs = await apiDialog(peer);
            const lastReadISO = localStorage.getItem(READ_KEY(meMail, peer.toLowerCase())) || '1970-01-01T00:00:00.000Z';
            const lastRead = new Date(lastReadISO);
            const unread = msgs.filter(m =>
              String(m.to||'').toLowerCase() === meMail &&
              new Date(m.createdAt) > lastRead
            ).length;
            total += unread;
          }catch{}
        }
        setBadge(total);
      }

      function setBadge(n){
        if(!badgeEl) return;
        if(n > 0){
          badgeEl.style.display = 'flex';
          badgeEl.textContent = n > 99 ? '99+' : String(n);
        }else{
          badgeEl.style.display = 'none';
        }
      }

      computeUnreadTotal();
      let timer = setInterval(computeUnreadTotal, 15000);
      document.addEventListener('visibilitychange', ()=>{
        if(document.visibilityState === 'visible') computeUnreadTotal();
      });
      window.addEventListener('beforeunload', ()=> clearInterval(timer));
    })();
    
    /* ç”Ÿæ´»å°è´´å£«é¡µï¼šæŒ‰ä½œè€…åœ°åŒºè¿‡æ»¤ï¼ˆä»…æ˜¾éšï¼Œä¸æ”¹ç»“æ„/æ ·å¼ï¼‰
   å…³é”®ç‚¹ï¼š
   1) åŒ…è£… renderPostsï¼Œåœ¨æ¯æ¬¡æ¸²æŸ“åè®°å½• __renderedPosts__ å¹¶ç«‹å³è¿‡æ»¤
   2) é»˜è®¤â€œå…¨éƒ¨â€â†’ æ˜¾ç¤ºæ‰€æœ‰
   3) å…·ä½“åœ°åŒºâ†’ ä»¥ authorEmail æŸ¥è¯¢ /api/users/by-email è·å–ä½œè€… area æ¥åˆ¤æ–­
   4) æ²¡é‚®ç®±æˆ–æŸ¥ä¸åˆ°åœ°åŒº â†’ é»˜è®¤æ˜¾ç¤ºï¼ˆæ›´å‹å¥½ï¼‰
*/
(function(){
  // è‡ªåŠ¨æ£€æµ‹APIåŸºç¡€URL
  const API_BASE = (() => {
    if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
      return 'http://127.0.0.1:3001';
    }
    return ''; // ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ç›¸å¯¹è·¯å¾„
  })();
  const REGION_KEY = 'region';
  const DEFAULT_REGION = 'å…¨éƒ¨';
  const ITEM_SELECTOR = '.card';            // ä½ çš„å¡ç‰‡ç±»å
  const LIST = document.getElementById('masonry');

  const norm = s => String(s||'').replace(/\s+/g,'').toLowerCase();
  const getRegion = () => localStorage.getItem(REGION_KEY) || DEFAULT_REGION;

  // ç¼“å­˜ï¼šemail -> area
  const areaMap = new Map();
  async function fetchAreaByEmail(email){
    const key = (email||'').trim().toLowerCase();
    if(!key) return '';
    if(areaMap.has(key)) return areaMap.get(key);
    try{
      const r = await fetch(`${API_BASE}/api/users/by-email?email=${encodeURIComponent(key)}`, { credentials:'include' });
      if(!r.ok){ areaMap.set(key, ''); return ''; }
      const u = await r.json();
      const area = (u.area || '').trim();
      areaMap.set(key, area);
      return area;
    }catch{
      areaMap.set(key, ''); return '';
    }
  }

  async function preloadAreas(posts){
    const emails = [...new Set((posts||[]).map(p => (p.authorEmail||'').trim().toLowerCase()).filter(Boolean))];
    await Promise.all(emails.map(fetchAreaByEmail));
  }

  async function applyRegionFilter(posts){
    const region = getRegion();
    const want = norm(region);
    const cards = Array.from(document.querySelectorAll(ITEM_SELECTOR));
    // ç”¨â€œå®é™…æ¸²æŸ“çš„å¸–å­æ•°ç»„â€å¯¹é½ DOMï¼Œé¿å…ç´¢å¼•é”™ä½
    const arr = Array.isArray(posts) ? posts : [];
    const n = Math.min(cards.length, arr.length);
    if (n === 0) return;

    // é¢„å–åœ°åŒº
    await preloadAreas(arr);

    let shown = 0;
    for (let i=0; i<n; i++){
      const card = cards[i];
      const post = arr[i] || {};
      const email = (post.authorEmail || '').trim().toLowerCase();

      // â€œå…¨éƒ¨â€â†’å…¨éƒ¨æ˜¾ç¤º
      if (want === norm(DEFAULT_REGION)) {
        card.style.display = '';
        card.setAttribute('aria-hidden','false');
        shown++; continue;
      }

      // æ²¡é‚®ç®±æˆ–æŸ¥ä¸åˆ°åœ°åŒº â†’ é»˜è®¤æ˜¾ç¤º
      const area = (email && areaMap.get(email)) || '';
      if (!email || !area) {
        card.style.display = '';
        card.setAttribute('aria-hidden','false');
        shown++; continue;
      }

      const hit = norm(area).includes(want);
      card.style.display = hit ? '' : 'none';
      card.setAttribute('aria-hidden', hit ? 'false' : 'true');
      if (hit) shown++;
    }

    const counter = document.querySelector('#resultCount');
    if (counter) counter.textContent = String(shown);
  }

  // â€”â€” åŒ…è£… renderPostsï¼šæ¸²æŸ“åç«‹åˆ»è¿‡æ»¤ â€”â€” //
  const _origRenderPosts = window.renderPosts;
  if (typeof _origRenderPosts === 'function'){
    window.renderPosts = function(posts){
      _origRenderPosts(posts);
      // è®°å½•â€œå®é™…æ¸²æŸ“çš„å¸–å­â€ï¼Œæ— è®ºæ˜¯å…¨é‡è¿˜æ˜¯æœç´¢åçš„å­é›†
      window.__renderedPosts__ = posts || [];
      // ç«‹åˆ»æŒ‰åœ°åŒºè¿‡æ»¤ä¸€æ¬¡
      applyRegionFilter(window.__renderedPosts__);
    };
  }

  // åˆæ¬¡è¿›å…¥ï¼šå¦‚æœåˆ—è¡¨å·²æ¸²æŸ“ï¼Œè·‘ä¸€æ¬¡ï¼›å¦åˆ™ç­‰ MutationObserver è§¦å‘
  const firstRun = () => applyRegionFilter(window.__renderedPosts__ || []);
  if (window.MutationObserver && LIST){
    const mo = new MutationObserver(()=> firstRun());
    mo.observe(LIST, { childList:true, subtree:false });
  }
  firstRun();

  // ç›‘å¬â€œä¸»é¡µåˆ‡æ¢åœ°åŒºâ€äº‹ä»¶
  document.addEventListener('regionchange', ()=>{
    applyRegionFilter(window.__renderedPosts__ || []);
  });
  })();
  </script>

  <!-- ç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆª -->
  <nav class="mobile-nav">
    <ul class="mobile-nav-list">
      <li class="mobile-nav-item">
        <a href="main page.html" class="mobile-nav-link">
          <span class="mobile-nav-icon">ğŸ </span>
          <span>ä¸»é¡µ</span>
        </a>
      </li>
      <li class="mobile-nav-item">
        <a href="life-tips.html" class="mobile-nav-link">
          <span class="mobile-nav-icon">ğŸ’¡</span>
          <span>ç”Ÿæ´»</span>
        </a>
      </li>
      <li class="mobile-nav-item">
        <a href="study-guide.html" class="mobile-nav-link">
          <span class="mobile-nav-icon">ğŸ“š</span>
          <span>å­¦ä¹ </span>
        </a>
      </li>
      <li class="mobile-nav-item">
        <a href="enrollment-steps.html" class="mobile-nav-link">
          <span class="mobile-nav-icon">ğŸ“</span>
          <span>å…¥å­¦</span>
        </a>
      </li>
      <li class="mobile-nav-item">
        <a href="share.html" class="mobile-nav-link active">
          <span class="mobile-nav-icon">ğŸ”—</span>
          <span>åˆ†äº«</span>
        </a>
      </li>
      <li class="mobile-nav-item">
        <a href="hospital.html" class="mobile-nav-link">
          <span class="mobile-nav-icon">ğŸ¥</span>
          <span>åŒ»é™¢</span>
          </a>
      </li>
    </ul>
  </nav>

  <!-- ç§»åŠ¨ç«¯äº¤äº’JavaScript -->
  <script>
  /* ç§»åŠ¨ç«¯äº¤äº’åŠŸèƒ½ */
  (function(){
    const hamburger = document.getElementById('hamburger');
    const mobileSidebar = document.getElementById('mobileSidebar');
    const mobileSidebarOverlay = document.getElementById('mobileSidebarOverlay');
    const mobileNavLinks = document.querySelectorAll('.mobile-nav-link');

    // æ±‰å ¡èœå•ç‚¹å‡»äº‹ä»¶
    if(hamburger && mobileSidebar && mobileSidebarOverlay) {
      hamburger.addEventListener('click', () => {
        console.log('æ±‰å ¡èœå•è¢«ç‚¹å‡»'); // è°ƒè¯•æ—¥å¿—
        hamburger.classList.toggle('active');
        mobileSidebar.classList.toggle('active');
        mobileSidebarOverlay.classList.toggle('active');
        document.body.style.overflow = mobileSidebar.classList.contains('active') ? 'hidden' : '';
      });

      // ç‚¹å‡»é®ç½©å…³é—­ä¾§è¾¹æ 
      mobileSidebarOverlay.addEventListener('click', () => {
        hamburger.classList.remove('active');
        mobileSidebar.classList.remove('active');
        mobileSidebarOverlay.classList.remove('active');
        document.body.style.overflow = '';
      });

      // ESCé”®å…³é—­ä¾§è¾¹æ 
      document.addEventListener('keydown', (e) => {
        if(e.key === 'Escape' && mobileSidebar.classList.contains('active')) {
          hamburger.classList.remove('active');
          mobileSidebar.classList.remove('active');
          mobileSidebarOverlay.classList.remove('active');
          document.body.style.overflow = '';
        }
      });
    } else {
      console.warn('ç§»åŠ¨ç«¯å¯¼èˆªå…ƒç´ æœªæ‰¾åˆ°:', { hamburger, mobileSidebar, mobileSidebarOverlay });
    }

    // ç§»åŠ¨ç«¯å¯¼èˆªé“¾æ¥ç‚¹å‡»äº‹ä»¶
    mobileNavLinks.forEach(link => {
      link.addEventListener('click', () => {
        // ç§»é™¤æ‰€æœ‰activeç±»
        mobileNavLinks.forEach(l => l.classList.remove('active'));
        // æ·»åŠ activeç±»åˆ°å½“å‰ç‚¹å‡»çš„é“¾æ¥
        link.classList.add('active');
      });
    });

    // è§¦æ‘¸æ‰‹åŠ¿æ”¯æŒ
    let startX = 0;
    let startY = 0;
    let currentX = 0;
    let currentY = 0;

    document.addEventListener('touchstart', (e) => {
      startX = e.touches[0].clientX;
      startY = e.touches[0].clientY;
    });

    document.addEventListener('touchmove', (e) => {
      currentX = e.touches[0].clientX;
      currentY = e.touches[0].clientY;
    });

    document.addEventListener('touchend', () => {
      const deltaX = currentX - startX;
      const deltaY = currentY - startY;
      const minSwipeDistance = 50;

      // ä»å·¦å‘å³æ»‘åŠ¨æ‰“å¼€ä¾§è¾¹æ 
      if(deltaX > minSwipeDistance && Math.abs(deltaY) < Math.abs(deltaX) && startX < 50) {
        if(mobileSidebar && !mobileSidebar.classList.contains('active')) {
          hamburger.classList.add('active');
          mobileSidebar.classList.add('active');
          mobileSidebarOverlay.classList.add('active');
          document.body.style.overflow = 'hidden';
        }
      }
      // ä»å³å‘å·¦æ»‘åŠ¨å…³é—­ä¾§è¾¹æ 
      else if(deltaX < -minSwipeDistance && Math.abs(deltaY) < Math.abs(deltaX) && mobileSidebar && mobileSidebar.classList.contains('active')) {
        hamburger.classList.remove('active');
        mobileSidebar.classList.remove('active');
        mobileSidebarOverlay.classList.remove('active');
        document.body.style.overflow = '';
      }
    });
  })();
  </script>
</body>
</html>
