<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>å¸–å­è¯¦æƒ…</title>
  <!-- ç§»åŠ¨ç«¯ä¼˜åŒ–CSS -->
  <link rel="stylesheet" href="mobile-optimization.css">
  

<style>
:root{--bg:#0b0f14;--panel:#ffffff;--text:#0f172a;--muted:#64748b;--accent:#16a34a;--border:#e5e7eb;--shadow:0 10px 30px rgba(0,0,0,.18);--radius:18px;}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;font-family:'Microsoft YaHei',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'PingFang SC',sans-serif;
  background:radial-gradient(1200px 600px at 10% -10%,#1f8db8 18%, transparent 60%),
             radial-gradient(900px 500px at 110% 110%,#2bb8d6 12%, transparent 60%),var(--bg);
  color:#fff;overflow:auto;
}
.page{max-width:1100px;margin:28px auto;padding:0 20px}
.card{
  background:var(--panel);color:var(--text);border:1px solid var(--border);
  border-radius:20px;box-shadow:var(--shadow);padding:16px;
}
.header{display:flex;align-items:center;gap:12px;margin-bottom:12px;}
.header .avatar{width:44px;height:44px;border-radius:50%;object-fit:cover;border:1px solid #eef2ff}
.header .name{font-weight:800}
.header .meta{color:#64748b;font-size:13px}
.follow{margin-left:auto;border:1px solid var(--border);background:#fff;border-radius:999px;padding:6px 12px;cursor:pointer;font-weight:700;}
.grid{display:grid;grid-template-columns:1.1fr .9fr;gap:18px}
@media (max-width: 920px){.grid{grid-template-columns:1fr}}
/* å›¾ç‰‡è½®æ’­ */
.gallery{position:relative;border:1px solid var(--border);border-radius:16px;overflow:hidden;background:#000;}
.slide{width:100%;height:100%;display:none;align-items:center;justify-content:center;background:#000;}
.slide.active{display:flex}
.slide img{width:100%;height:auto;display:block;object-fit:contain;aspect-ratio: 4 / 3;}
.gnav{position:absolute;top:50%;left:10px;right:10px;display:flex;justify-content:space-between;transform:translateY(-50%);pointer-events:none;}
.gbtn{pointer-events:auto;width:38px;height:38px;border-radius:50%;border:1px solid rgba(255,255,255,.6);background:rgba(0,0,0,.28);color:#fff;font-size:18px;display:flex;align-items:center;justify-content:center;cursor:pointer;}
.counter{position:absolute;right:12px;top:12px;background:rgba(0,0,0,.55);color:#fff;padding:4px 10px;border-radius:999px;font-size:12px}
.dots{display:flex;gap:6px;justify-content:center;padding:10px}
.dot{width:6px;height:6px;border-radius:50%;background:#d1d5db;opacity:.7}
.dot.on{opacity:1;background:#111827}
.content{border:1px solid var(--border);border-radius:16px;padding:14px;background:#fff}
.title{font-size:20px;font-weight:900;margin:0 0 8px}
.desc{white-space:pre-wrap;line-height:1.8}
.attach{margin-top:12px;border-top:1px dashed #e5e7eb;padding-top:12px;color:#374151;font-size:14px}
.attach a{color:#2563eb;text-decoration:none;word-break:break-all}
.actions{display:flex;gap:14px;align-items:center;margin-top:14px;color:#6b7280}
.actions button{
  border:1px solid var(--border);
  background:#fff;
  border-radius:12px;
  padding:8px 14px;
  cursor:pointer;
  font-weight:700;
  transition:.2s transform,.2s box-shadow,.2s background;
}
.actions button:hover{transform:translateY(-2px);box-shadow:0 4px 10px rgba(0,0,0,.15);}
.actions button:active{transform:translateY(0);}
#likeBtn.liked{
  background:linear-gradient(135deg,#ef4444,#f87171);
  color:#fff;border:none;
}
#favBtn.faved{
  background:linear-gradient(135deg,#facc15,#fbbf24);
  color:#111;border:none;
}
.back{display:inline-flex;align-items:center;gap:8px;margin-bottom:12px;border:1px solid rgba(255,255,255,.35);color:#fff;padding:6px 10px;border-radius:12px;text-decoration:none}

/* === è¯„è®ºæ ·å¼ï¼ˆåˆ—è¡¨å†…éƒ¨æ»šåŠ¨ + åº•éƒ¨æŒ‰é’®å›ºå®šï¼‰ === */
.comments{margin-top:16px;border:1px solid var(--border);border-radius:16px;background:#fff;padding:14px}
.comments h2{margin:0 0 10px 0;font-size:18px;font-weight:900}
.cmt-form{display:flex;gap:10px;align-items:flex-start}
.cmt-input{
  flex:1;min-height:84px;padding:10px 12px;border:1px solid #e5e7eb;border-radius:12px;resize:vertical;
  font-family:inherit;font-size:14px;background:#fff;
}
.cmt-submit{
  white-space:nowrap;border:1px solid var(--border);background:#0f172a;color:#fff;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:800
}
.cmt-submit:disabled{opacity:.6;cursor:not-allowed}
.cmt-warn{color:#dc2626;font-size:13px;margin:6px 0 0}

/* é¢æ¿å®¹å™¨ï¼šå›ºå®šé«˜åº¦ï¼Œå†…éƒ¨æ»šåŠ¨ */
.cmt-panel{
  margin-top:14px;
  display:flex;
  flex-direction:column;
  gap:10px;
  max-height:360px; /* ä½ å¯ä»¥æ”¹æˆ 300/400 ç­‰ */
}
@media (max-width: 520px){
  .cmt-panel{ max-height:300px; }
}

/* åˆ—è¡¨å˜ä¸ºå¯æ»šåŠ¨åŒºåŸŸ */
.cmt-list{
  display:flex;
  flex-direction:column;
  gap:10px;
  overflow-y:auto;
  padding-right:6px; /* ç»™æ»šåŠ¨æ¡ç•™ç©ºé—´ */
  min-height:80px;   /* é¿å…æ²¡å†…å®¹æ—¶è¿‡çª„ */
  border:1px dashed #e5e7eb;
  border-radius:12px;
  background:#fafafa;
}
.cmt-list::-webkit-scrollbar{width:6px}
.cmt-list::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:6px}

/* å•æ¡è¯„è®ºå¡ç‰‡ */
.cmt-item{display:grid;grid-template-columns:44px 1fr;gap:10px;border:1px solid #eef2ff;border-radius:12px;padding:10px;background:#fff}
.cmt-item .ava{width:44px;height:44px;border-radius:50%;object-fit:cover;border:1px solid #e5e7eb}
.cmt-head{display:flex;gap:8px;align-items:center}
.cmt-name{font-weight:800}
.cmt-time{color:#6b7280;font-size:12px}
.cmt-text{white-space:pre-wrap;line-height:1.7;margin-top:6px}
.cmt-actions{margin-left:auto;display:flex;gap:8px}
.cmt-actions button{border:1px solid #e5e7eb;background:#fff;border-radius:10px;padding:4px 8px;cursor:pointer}

/* ç©ºçŠ¶æ€ä¸â€œåŠ è½½æ›´å¤šâ€ */
.cmt-empty{color:#6b7280;background:#f8fafc;border:1px dashed #e5e7eb;border-radius:12px;padding:12px;text-align:center}
.cmt-more{display:flex;justify-content:center}
.cmt-more button{border:1px solid var(--border);background:#fff;border-radius:12px;padding:8px 14px;cursor:pointer}


    
    
    .top-nav-button .nav-icon{font-size:20px;color:var(--text)}
    .top-nav-button:hover{transform:translateY(-1px);box-shadow:0 14px 28px rgba(0,0,0,.32)}
    .top-nav-button:active{transform:translateY(0);box-shadow:0 8px 18px rgba(0,0,0,.26)}

    

    /* ç§»åŠ¨ç«¯å“åº”å¼ä¼˜åŒ– */
    @media (max-width: 960px) {
      .container {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
        padding: 16px;
        padding-bottom: calc(var(--mobile-nav-height) + 20px);
      }
      
      .sidebar {
        display: none;
      }
      
      .panel {
        padding: 16px;
        border-radius: 16px;
      }
      
      .search-box {
        flex-direction: column;
        gap: 12px;
      }
      
      .search-box input {
        padding: 14px 16px;
        font-size: 16px;
      }
      
      .search-box button {
        padding: 14px 16px;
        font-size: 16px;
      }
      
      .panel-title {
        font-size: 20px;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: 12px;
        padding-bottom: calc(var(--mobile-nav-height) + 16px);
      }
      
      .panel {
        padding: 12px;
        border-radius: 12px;
      }
      
      .search-box input {
        padding: 16px;
        font-size: 16px;
      }
      
      .search-box button {
        padding: 16px;
        font-size: 16px;
      }
      
      .panel-title {
        font-size: 18px;
      }
      
      .card {
        border-radius: 12px;
        margin-bottom: 12px;
      }
      
      .card-text {
        padding: 12px;
        font-size: 14px;
      }
    }

    #chatFab{ position:fixed; left:16px; bottom:calc(var(--mobile-nav-height) + 16px); width:48px; height:48px; border-radius:9999px; display:flex; align-items:center; justify-content:center; background:#0f172a; color:#fff; border:1px solid rgba(255,255,255,.15); box-shadow:0 10px 24px rgba(0,0,0,.28); cursor:pointer; user-select:none; z-index:9999; transition: transform .15s, box-shadow .15s, opacity .2s }
    #chatFab:hover{ transform: translateY(-1px); box-shadow: 0 14px 28px rgba(0,0,0,.32) }
    #chatFab:active{ transform: translateY(0); box-shadow: 0 8px 18px rgba(0,0,0,.26) }
    #chatFab .badge{ position:absolute; right:-2px; top:-2px; min-width:18px; height:18px; padding:0 5px; display:none; align-items:center; justify-content:center; background:#ef4444; color:#fff; border-radius:9999px; font-size:11px; line-height:18px; box-shadow:0 2px 6px rgba(0,0,0,.18) }
    @media (max-width:480px){ #chatFab{ left:12px; bottom:calc(var(--mobile-nav-height) + 12px); width:44px; height:44px } }
  </style>
</head>
<body>
  <!-- é»‘è‰²æ¶ˆæ¯æŒ‰é’® -->
  <div id="chatFab"> onclick="window.location.href='messages.html'"
    <span>ğŸ’¬</span>
    <div class="badge">0</div>
  </div>
  
  

  
  <div class="mobile-sidebar-overlay" id="mobileSidebarOverlay"></div>


  <div class="page">
    <a class="back" href="javascript:history.back()">â† è¿”å›</a>

    <div class="card">
      <div class="header">
        <img class="avatar" id="authorAvatar" alt="">
        <div>
          <div class="name" id="authorName">ä½œè€…</div>
          <div class="meta" id="meta">â€”</div>
        </div>
        <button class="follow" id="followBtn">å…³æ³¨</button>
      </div>

      <div class="grid">
        <!-- å·¦ä¾§ï¼šå›¾ç‰‡è½®æ’­ï¼ˆæ— å›¾ä¼šè‡ªåŠ¨éšè—ï¼‰ -->
        <div id="leftBox">
          <div class="gallery" id="gallery"></div>
          <div class="dots" id="dots"></div>
        </div>

        <!-- å³ä¾§ï¼šæ­£æ–‡ -->
        <div class="content">
          <h1 class="title" id="title">æ ‡é¢˜</h1>
          <div class="desc" id="desc"></div>

          <div class="attach" id="attach" style="display:none">
            <div style="font-weight:700;margin-bottom:6px">é™„ä»¶</div>
            <div id="attachList"></div>
          </div>

          <div class="actions">
            <button id="likeBtn">â¤ï¸ èµ <span id="likeCount">0</span></button>
            <button id="favBtn">â­ æ”¶è—</button>
            <button id="cmtBtn">ğŸ’¬ è¯„è®º <span id="cmtCount">0</span></button>
            <button id="copyBtn">ğŸ”— å¤åˆ¶é“¾æ¥</button>
            <button id="deleteBtn" style="display:none; background:#ef4444; color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer;">ğŸ—‘ï¸ åˆ é™¤</button>
          </div>

          <!-- è¯„è®ºåŒº -->
          <section id="comments" class="comments">
            <h2>è¯„è®º</h2>
            <div class="cmt-form">
              <textarea id="cmtInput" class="cmt-input" placeholder="å†™ç‚¹ä»€ä¹ˆå§â€¦ï¼ˆæ”¯æŒæ¢è¡Œï¼‰"></textarea>
              <button id="cmtSubmit" class="cmt-submit">å‘å¸ƒ</button>
            </div>
            <div id="cmtWarn" class="cmt-warn" style="display:none"></div>

            <!-- ç©ºçŠ¶æ€ï¼ˆæ— è¯„è®ºæ—¶æ˜¾ç¤ºï¼‰ -->
            <div id="cmtEmpty" class="cmt-empty" style="display:none">è¿˜æ²¡æœ‰è¯„è®ºï¼Œæ¥å½“ç¬¬ä¸€ä¸ªå§ï½</div>

            <!-- å›ºå®šé«˜åº¦è¯„è®ºé¢æ¿ï¼šä¸Šæ–¹æ»šåŠ¨åˆ—è¡¨ + åº•éƒ¨æŒ‰é’® -->
            <div class="cmt-panel">
              <div id="cmtList" class="cmt-list"></div>
              <div class="cmt-more" id="cmtMore" style="display:none">
                <button id="cmtMoreBtn">åŠ è½½æ›´å¤š</button>
              </div>
            </div>
          </section>
        </div>
      </div>
    </div>
  </div>

<script>
  // è‡ªåŠ¨æ£€æµ‹APIåŸºç¡€URL
  const API_BASE = (() => {
    if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
      return 'http://127.0.0.1:3001';
    }
    return ''; // ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ç›¸å¯¹è·¯å¾„
  })();

function q(k){return document.querySelector(k)}
function toAbs(u){ if(!u) return ''; if(/^https?:\/\//i.test(u)) return u; return u.startsWith('/')?API_BASE+u:API_BASE+'/'+u; }
function getParam(name){ return new URL(location.href).searchParams.get(name) || ''; }
function fmtDate(iso){ try{const d=new Date(iso); if(isNaN(d)) return ''; return d.toLocaleString('zh-CN',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});}catch{return ''} }

const FALLBACK_AVA = 'https://raw.githubusercontent.com/WH-An/hwlx-app/2df4e97b395bebb7977074fbb31741f3c35da9a0/assets-task_01k3v2vy06fra8er06x602xnpe-1756476933_img_1.webp';
// é€šè¿‡ä½œè€…é‚®ç®±å–ç”¨æˆ·åœ°åŒº
async function fetchUserAreaByEmail(email){
  const key = (email || '').trim();
  if(!key) return '';
  try{
    const r = await fetch(`${API_BASE}/api/users/by-email?email=${encodeURIComponent(key)}`, { credentials:'include' });
    if(!r.ok) return '';
    const data = await r.json();
    return (data.area || '').trim();
  }catch{
    return '';
  }
}

function pickAuthor(p){
  const u=p.user||p.author||p.owner||{};
  const name=(p.authorName||u.nickname||u.username||u.displayName||u.name||p.username||p.email||'åŒ¿åç”¨æˆ·').trim();
  let ava=(p.authorAvatar||u.avatarPath||u.avatarUrl||u.avatar||p.avatar||'').trim();
  if(ava&&!/^https?:\/\//i.test(ava)) ava=toAbs(ava);
  return {name, avatar:ava||FALLBACK_AVA, email:(p.authorEmail||u.email||'').trim()};
}

function collectImages(p){
  const imgs = [];
  (p.images||[]).forEach(s=>s && imgs.push(toAbs(s)));
  (p.files||[]).forEach(f=>{
    const url = (typeof f==='string')? f : (f.url||f.path||'');
    if(!url) return;
    if(/\.(png|jpe?g|webp|gif|bmp|svg)$/i.test(url)) imgs.push(toAbs(url));
  });
  return imgs;
}

async function fetchPostById(id){
  try{
    const r = await fetch(`${API_BASE}/api/posts/${encodeURIComponent(id)}`, { credentials:'include' });
    if(r.ok) return r.json();
  }catch{}
  try{
    const r = await fetch(`${API_BASE}/api/posts`, { credentials:'include' });
    const arr = await r.json();
    return (arr||[]).find(x => String(x._id||x.id||x.postId||'') === String(id)) || null;
  }catch{}
  return null;
}

/* -------- è¯„è®ºï¼šåç«¯ä¼˜å…ˆ / æœ¬åœ°å…œåº• -------- */
function getCurrentUser(){
  try{
    return JSON.parse(localStorage.getItem('currentUser'))
        || JSON.parse(localStorage.getItem('user'))
        || JSON.parse(localStorage.getItem('USER'))
        || JSON.parse(localStorage.getItem('auth_user')) || null;
  }catch{ return null; }
}
function userKey(u){
  return (u && (u.email||u.username||u.nickname||u.id))
    ? String(u.email||u.username||u.nickname||u.id).toLowerCase()
    : 'guest';
}

async function apiListComments(postId, {offset=0, limit=10}={}){
  try{
    const r = await fetch(`${API_BASE}/api/posts/${encodeURIComponent(postId)}/comments?offset=${offset}&limit=${limit}`, { credentials:'include' });
    if(r.ok) return await r.json();
  }catch{}
  const raw = localStorage.getItem(`comments:${postId}`) || '[]';
  const all = JSON.parse(raw);
  const items = all.slice(offset, offset+limit);
  return { items, total: all.length };
}
async function apiCreateComment(postId, content){
  const me = getCurrentUser();
  try{
    const r = await fetch(`${API_BASE}/api/posts/${encodeURIComponent(postId)}/comments`, {
      method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include',
      body: JSON.stringify({ content })
    });
    if(r.ok) return await r.json();
  }catch{}
  const now = new Date().toISOString();
  const fallback = {
    id: 'local-'+Math.random().toString(36).slice(2),
    postId, content, createdAt: now,
    user: { name: (me && (me.nickname||me.username||me.displayName||me.name||me.email)) || 'æˆ‘', avatar: (me && (me.avatarPath||me.avatarUrl||me.avatar)) || '', email: me?.email }
  };
  const key = `comments:${postId}`;
  const all = JSON.parse(localStorage.getItem(key) || '[]');
  all.unshift(fallback);
  localStorage.setItem(key, JSON.stringify(all));
  return fallback;
}
async function apiDeleteComment(postId, commentId){
  try{
    const r = await fetch(`${API_BASE}/api/posts/${encodeURIComponent(postId)}/comments/${encodeURIComponent(commentId)}`, {
      method:'DELETE', credentials:'include'
    });
    if(r.ok) return true;
  }catch{}
  const key = `comments:${postId}`;
  const all = JSON.parse(localStorage.getItem(key) || '[]');
  const next = all.filter(x => (x.id||x._id) !== commentId);
  localStorage.setItem(key, JSON.stringify(next));
  return true;
}

/* -------- è½®æ’­/é™„ä»¶ -------- */
function buildGallery(imgs){
  const box = q('#gallery'); const dots = q('#dots');
  box.innerHTML=''; dots.innerHTML='';
  if(!imgs.length){
    const empty = document.createElement('div');
    empty.className='slide active';
    empty.innerHTML = `<img src="${toAbs('/public/placeholder.jpg')}" alt="">`;
    box.appendChild(empty);
    return;
  }
  let idx=0;
  imgs.forEach((src,i)=>{
    const s=document.createElement('div');
    s.className = 'slide'+(i===0?' active':'');
    const img=new Image(); img.src=src; img.alt='';
    img.onerror=()=>{ s.remove(); updateCounter(); };
    s.appendChild(img); box.appendChild(s);

    const d=document.createElement('div');
    d.className='dot'+(i===0?' on':''); d.addEventListener('click',()=>go(i));
    dots.appendChild(d);
  });

  const counter=document.createElement('div'); counter.className='counter'; box.appendChild(counter);
  const nav=document.createElement('div'); nav.className='gnav';
  nav.innerHTML=`<button class="gbtn" id="prev">â€¹</button><button class="gbtn" id="next">â€º</button>`; box.appendChild(nav);

  function updateCounter(){
    const slides=[...box.querySelectorAll('.slide')];
    if(!slides.length){ counter.textContent='0/0'; return; }
    const total=slides.length; idx = Math.max(0, Math.min(idx, total-1));
    counter.textContent = (idx+1)+'/'+total;
    slides.forEach((el,i)=> el.classList.toggle('active', i===idx));
    [...dots.children].forEach((d,i)=> d.classList.toggle('on', i===idx));
  }
  function go(i){ idx=i; updateCounter(); }
  function step(n){ idx += n; const total=box.querySelectorAll('.slide').length; idx=(idx+total)%total; updateCounter(); }

  box.querySelector('#prev').addEventListener('click',()=>step(-1));
  box.querySelector('#next').addEventListener('click',()=>step(+1));
  document.addEventListener('keydown',e=>{ if(e.key==='ArrowLeft') step(-1); if(e.key==='ArrowRight') step(+1); });

  updateCounter();
}
function fillAttach(p){
  const cont=q('#attach'); const list=q('#attachList');
  const files = (p.files||[]).map(f=>{
    if(typeof f==='string') return {name:f.split('/').pop(), url:toAbs(f)};
    return {name:f.name || (f.url||f.path||'').split('/').pop(), url:toAbs(f.url||f.path||'')};
  }).filter(x=>x.url);
  if(!files.length){ cont.style.display='none'; return; }
  cont.style.display=''; list.innerHTML='';
  files.forEach(f=>{
    const a=document.createElement('a'); a.href=f.url; a.target='_blank'; a.rel='noopener';
    a.textContent = 'ğŸ“ '+(f.name||'æ–‡ä»¶'); const div=document.createElement('div'); div.appendChild(a);
    list.appendChild(div);
  });
}

/* -------- è¯„è®ºæ¸²æŸ“ï¼ˆä½œè€…å¯åˆ å…¨ä½“ï¼Œå‘å¸ƒè€…å¯åˆ è‡ªå·±ï¼‰ -------- */
function renderCommentItem(c, meKey, authorKey, postId){
  const id = c.id || c._id || '';
  const u  = c.user || {};
  const name = (u.name || u.nickname || u.username || u.displayName || 'ç”¨æˆ·');
  let ava = (u.avatar || u.avatarUrl || u.avatarPath || '');
  if(ava && !/^https?:\/\//i.test(ava)) ava = toAbs(ava);
  const time = fmtDate(c.createdAt || c.time || Date.now());

  const canDelete = (userKey(u) === meKey) || (meKey === authorKey);

  const el = document.createElement('div');
  el.className='cmt-item';
  el.innerHTML = `
    <img class="ava" src="${ava||FALLBACK_AVA}" onerror="this.src='${FALLBACK_AVA}'" alt="">
    <div>
      <div class="cmt-head">
        <span class="cmt-name">${name}</span>
        <span class="cmt-time">${time}</span>
        <div class="cmt-actions">
          ${canDelete ? `<button data-del="${id}">åˆ é™¤</button>` : ``}
        </div>
      </div>
      <div class="cmt-text"></div>
    </div>
  `;
  el.querySelector('.cmt-text').textContent = c.content || '';
  if(canDelete){
    el.querySelector('[data-del]')?.addEventListener('click', async ()=>{
      if(!confirm('ç¡®è®¤åˆ é™¤è¿™æ¡è¯„è®ºï¼Ÿ')) return;
      const ok = await apiDeleteComment(postId, id);
      if(ok){ el.remove(); bumpCount(-1); checkEmpty(); }
    });
  }
  return el;
}

(function init(){
  (async ()=>{
    const id = getParam('id') || getParam('_id') || getParam('postId');
    if(!id){ q('#title').textContent='æœªæ‰¾åˆ°å¸–å­'; q('#desc').textContent='ç¼ºå°‘ id å‚æ•°ã€‚'; return; }

    const post = await fetchPostById(id);
    if(!post){ q('#title').textContent='æœªæ‰¾åˆ°å¸–å­'; q('#desc').textContent='è¿™ä¸ªå¸–å­ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤ã€‚'; return; }

    // ä½œè€…ä¸æ—¶é—´ï¼ˆå«åœ°åŒºï¼‰
const {name,avatar,email:authorEmail} = pickAuthor(post);
q('#authorName').textContent = name;
const avaEl = q('#authorAvatar'); avaEl.src = avatar; avaEl.onerror = ()=>{ avaEl.src = FALLBACK_AVA; };

(async ()=>{
  const parts = [];
  if (post.category) parts.push('#' + post.category);

  // æ–°å¢ï¼šä½œè€…åœ°åŒº
  const area = await fetchUserAreaByEmail(authorEmail);
  if (area) parts.push(area);          // æœ‰å°±æ˜¾ç¤ºâ€œåœ°åŒºâ€ï¼Œæ²¡æœ‰å°±ä¸å ä½

  const when = fmtDate(post.createdAt || post.time || post.date);
  if (when) parts.push(when);

  q('#meta').textContent = parts.join(' Â· ');
})();

    // æ ‡é¢˜/æ­£æ–‡
    q('#title').textContent = (post.title||'');
    q('#desc').textContent  = (post.desc||post.content||post.text||'');

    // è½®æ’­ä¸é™„ä»¶ â€”â€” æ— å›¾æ—¶éšè—å·¦æ 
    const imgs = collectImages(post);
    if (imgs.length > 0) {
      buildGallery(imgs);
    } else {
      q('#leftBox').style.display = 'none';
      q('.grid').style.gridTemplateColumns = '1fr';
    }
    fillAttach(post);

    // åˆå§‹åŒ–è®¡æ•°
    const likeCountEl = q('#likeCount');
    const cmtCountEl  = q('#cmtCount');
    likeCountEl.textContent = post.likes || post.like || 0;
    cmtCountEl.textContent  = post.commentsCount || post.commentCount || 0;

    // å¤åˆ¶é“¾æ¥
    q('#copyBtn').addEventListener('click', async ()=>{
      const url = location.href;
      try{ await navigator.clipboard.writeText(url); alert('é“¾æ¥å·²å¤åˆ¶'); }
      catch{ prompt('å¤åˆ¶ä¸‹é¢çš„é“¾æ¥', url); }
    });

    // å½“å‰ç”¨æˆ·ä¸ keyï¼ˆç”¨äºç‚¹èµ/æ”¶è—/è¯„è®ºæƒé™ï¼‰
    const me = getCurrentUser();
    const meKey = userKey(me);

    // å¸–å­ä½œè€… keyï¼ˆç”¨äºâ€œä½œè€…å¯åˆ å…¨ä½“â€ï¼‰
    const authorObj = post.user || post.author || post.owner || { email: post.authorEmail, username: post.authorName };
    const authorKey = userKey(authorObj);

    // åˆ é™¤åŠŸèƒ½ï¼šåªæœ‰ä½œè€…å¯ä»¥åˆ é™¤è‡ªå·±çš„å¸–å­
    const deleteBtn = q('#deleteBtn');
    if (meKey === authorKey) {
      deleteBtn.style.display = 'inline-block';
      deleteBtn.addEventListener('click', async () => {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¸–å­å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚')) {
          return;
        }
        
        try {
          const response = await fetch(`${API_BASE}/api/posts/${encodeURIComponent(id)}`, {
            method: 'DELETE',
            credentials: 'include'
          });
          
          if (response.ok) {
            alert('å¸–å­å·²åˆ é™¤');
            // è·³è½¬åˆ°å¯¹åº”çš„åˆ†ç±»é¡µé¢
            const category = post.category || 'life';
            const categoryPages = {
              'life': 'life-tips.html',
              'study': 'study-guide.html',
              'enroll': 'enrollment-steps.html',
              'share': 'share.html',
              'fun': 'fun.html',
              'hospital': 'hospital.html'
            };
            location.href = categoryPages[category] || 'life-tips.html';
          } else {
            const data = await response.json().catch(() => ({}));
            alert('åˆ é™¤å¤±è´¥ï¼š' + (data.msg || 'æœªçŸ¥é”™è¯¯'));
          }
        } catch (error) {
          console.error('åˆ é™¤å¸–å­å¤±è´¥:', error);
          alert('åˆ é™¤å¤±è´¥ï¼šç½‘ç»œé”™è¯¯');
        }
      });
    }

    // ç‚¹èµï¼ˆå¯å–æ¶ˆï¼‰& æ”¶è—ï¼ˆå¯åˆ‡æ¢ï¼‰
    const likeBtn = q('#likeBtn');
    const likeKey = `liked:${meKey}:${id}`;
    if(localStorage.getItem(likeKey)) likeBtn.classList.add('liked');
    likeBtn.addEventListener('click', ()=>{
      let count = +likeCountEl.textContent || 0;
      if(likeBtn.classList.contains('liked')){
        likeBtn.classList.remove('liked'); localStorage.removeItem(likeKey);
        likeCountEl.textContent = Math.max(0, count-1);
      }else{
        likeBtn.classList.add('liked'); localStorage.setItem(likeKey,'1');
        likeCountEl.textContent = count+1;
      }
    });
    const favBtn = q('#favBtn');
    const favKey = `faved:${meKey}:${id}`;
    function setFavUI(on){ if(on){ favBtn.classList.add('faved'); favBtn.textContent='â­ å·²æ”¶è—'; } else { favBtn.classList.remove('faved'); favBtn.textContent='â­ æ”¶è—'; } }
    setFavUI(!!localStorage.getItem(favKey));
    favBtn.addEventListener('click', ()=>{
      const on = favBtn.classList.contains('faved');
      if(on){ localStorage.removeItem(favKey); setFavUI(false); }
      else  { localStorage.setItem(favKey,'1'); setFavUI(true); }
    });

    /* -------- è¯„è®ºé€»è¾‘ï¼ˆåˆ—è¡¨å†…éƒ¨æ»šåŠ¨ï¼‰ -------- */
    const listEl = q('#cmtList');
    const emptyEl= q('#cmtEmpty');
    const moreWrap=q('#cmtMore');
    const moreBtn = q('#cmtMoreBtn');
    const inputEl = q('#cmtInput');
    const submitEl= q('#cmtSubmit');
    const warnEl  = q('#cmtWarn');

    let offset = 0;
    const LIMIT = 10;
    let total = 0;

    function checkEmpty(){
      const hasAny = listEl.children.length > 0;
      emptyEl.style.display = hasAny ? 'none':'block';
      moreWrap.style.display = (offset < total) ? 'flex':'none';
    }
    function bumpCount(delta){
      const cur = +cmtCountEl.textContent || 0;
      cmtCountEl.textContent = Math.max(0, cur + delta);
    }

    async function loadMore(){
      submitEl.disabled = true;
      try{
        const {items, total: _total} = await apiListComments(id, {offset, limit: LIMIT});
        total = _total ?? total;
        items.forEach(c => listEl.appendChild(renderCommentItem(c, meKey, authorKey, id)));
        offset += items.length;
      }catch(e){
        console.warn('list comments failed', e);
      }finally{
        submitEl.disabled = false;
        checkEmpty();
      }
    }

    // åˆæ¬¡åŠ è½½
    await loadMore();

    // å‘å¸ƒè¯„è®º
    submitEl.addEventListener('click', async ()=>{
      warnEl.style.display='none';
      const txt = (inputEl.value||'').trim();
      if(!txt){ warnEl.textContent='è¯·è¾“å…¥å†…å®¹'; warnEl.style.display='block'; return; }
      if(!me){ warnEl.textContent='è¯·å…ˆç™»å½•å†è¯„è®º'; warnEl.style.display='block'; return; }

      submitEl.disabled = true;
      try{
        // ä¹è§‚æ’å…¥ï¼ˆç½®é¡¶ï¼‰
        const draft = {
          id: 'draft-'+Date.now(),
          content: txt,
          createdAt: new Date().toISOString(),
          user: {
            name: me?.nickname||me?.username||me?.displayName||me?.name||me?.email||'æˆ‘',
            avatar: me?.avatarPath||me?.avatarUrl||me?.avatar||'',
            email: me?.email
          }
        };
        const node = renderCommentItem(draft, meKey, authorKey, id);
        listEl.insertBefore(node, listEl.firstChild);
        listEl.scrollTop = 0; // æ–°è¯„è®ºå‡ºç°åæ»šåˆ°é¡¶éƒ¨
        bumpCount(+1);
        emptyEl.style.display='none';
        inputEl.value='';

        // çœŸæ­£æäº¤
        const saved = await apiCreateComment(id, txt);
        if(saved && (saved.id || saved._id)){
          node.replaceWith(renderCommentItem(saved, meKey, authorKey, id));
        }
      }catch(e){
        warnEl.textContent='å‘å¸ƒå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•'; warnEl.style.display='block';
      }finally{
        submitEl.disabled = false;
      }
    });

    // åŠ è½½æ›´å¤šï¼ˆå‡ºç°åœ¨æ»šåŠ¨åŒºä¸‹æ–¹çš„å›ºå®šä½ç½®ï¼‰
    moreBtn.addEventListener('click', loadMore);

    // é¡¶éƒ¨â€œè¯„è®ºâ€æŒ‰é’®ï¼šæ»šåŠ¨åˆ°è¯„è®ºåŒº
    q('#cmtBtn').addEventListener('click', ()=> q('#comments').scrollIntoView({behavior:'smooth', block:'start'}));
  })();
})();
</script>
  <!-- é¡¶éƒ¨å¯¼èˆªäº¤äº’JavaScript -->
  <script>
  /* é¡¶éƒ¨å¯¼èˆªäº¤äº’åŠŸèƒ½ */
  (function(){
    const topNavButton = document.getElementById('topNavButton');
    const topNavMenu = document.getElementById('topNavMenu');
    const topNavOverlay = document.getElementById('topNavOverlay');
    const closeNavBtn = document.getElementById('closeNavBtn');
    const mobileNavLinks = document.querySelectorAll('.mobile-nav-link');

    // é¡¶éƒ¨å¯¼èˆªæŒ‰é”®ç‚¹å‡»äº‹ä»¶
    if(topNavButton && topNavMenu && topNavOverlay) {
      topNavButton.addEventListener('click', () => {
        console.log('é¡¶éƒ¨å¯¼èˆªæŒ‰é”®è¢«ç‚¹å‡»'); // è°ƒè¯•æ—¥å¿—
        topNavMenu.classList.add('active');
        topNavOverlay.classList.add('active');
        document.body.style.overflow = 'hidden';
      });

      // å…³é—­æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      if(closeNavBtn) {
        closeNavBtn.addEventListener('click', () => {
          topNavMenu.classList.remove('active');
          topNavOverlay.classList.remove('active');
          document.body.style.overflow = '';
        });
      }

      // ç‚¹å‡»é®ç½©å…³é—­å¯¼èˆªèœå•
      topNavOverlay.addEventListener('click', () => {
        topNavMenu.classList.remove('active');
        topNavOverlay.classList.remove('active');
        document.body.style.overflow = '';
      });

      // ESCé”®å…³é—­å¯¼èˆªèœå•
      document.addEventListener('keydown', (e) => {
        if(e.key === 'Escape' && topNavMenu.classList.contains('active')) {
          topNavMenu.classList.remove('active');
          topNavOverlay.classList.remove('active');
          document.body.style.overflow = '';
        }
      });
    } else {
      console.warn('é¡¶éƒ¨å¯¼èˆªå…ƒç´ æœªæ‰¾åˆ°:', { topNavButton, topNavMenu, topNavOverlay });
    }

    // ç§»åŠ¨ç«¯å¯¼èˆªé“¾æ¥ç‚¹å‡»äº‹ä»¶
    mobileNavLinks.forEach(link => {
      link.addEventListener('click', () => {
        // ç§»é™¤æ‰€æœ‰activeç±»
        mobileNavLinks.forEach(l => l.classList.remove('active'));
        // æ·»åŠ activeç±»åˆ°å½“å‰ç‚¹å‡»çš„é“¾æ¥
        link.classList.add('active');
      });
    });

    // è§¦æ‘¸æ‰‹åŠ¿æ”¯æŒ
    let startX = 0;
    let startY = 0;
    let currentX = 0;
    let currentY = 0;

    document.addEventListener('touchstart', (e) => {
      startX = e.touches[0].clientX;
      startY = e.touches[0].clientY;
    });

    document.addEventListener('touchmove', (e) => {
      currentX = e.touches[0].clientX;
      currentY = e.touches[0].clientY;
    });

    document.addEventListener('touchend', () => {
      const deltaX = currentX - startX;
      const deltaY = currentY - startY;
      const minSwipeDistance = 50;

      // ä»å·¦å‘å³æ»‘åŠ¨æ‰“å¼€å¯¼èˆªèœå•
      if(deltaX > minSwipeDistance && Math.abs(deltaY) < Math.abs(deltaX) && startX < 50) {
        if(topNavMenu && !topNavMenu.classList.contains('active')) {
          topNavMenu.classList.add('active');
          topNavOverlay.classList.add('active');
          document.body.style.overflow = 'hidden';
        }
      }
      // ä»å³å‘å·¦æ»‘åŠ¨å…³é—­å¯¼èˆªèœå•
      else if(deltaX < -minSwipeDistance && Math.abs(deltaY) < Math.abs(deltaX) && topNavMenu && topNavMenu.classList.contains('active')) {
        topNavMenu.classList.remove('active');
        topNavOverlay.classList.remove('active');
        document.body.style.overflow = '';
      }
    });
  })();</script>

  <!-- æœªè¯»æ¶ˆæ¯åŠŸèƒ½ -->
  <script>
    // è‡ªåŠ¨æ£€æµ‹APIåŸºç¡€URL
    const API_BASE = (() => {
      if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
        return 'http://127.0.0.1:3001';
      }
      return ''; // ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ç›¸å¯¹è·¯å¾„
    })();

    // è·å–æœªè¯»æ¶ˆæ¯æ•°é‡
    async function getUnreadCount() {
      try {
        const res = await fetch(`${API_BASE}/api/messages/unread-count`, { 
          credentials: 'include',
          cache: 'no-cache'
        });
        
        if (res.ok) {
          const data = await res.json();
          return data.count || 0;
        }
      } catch (e) {
        console.warn('è·å–æœªè¯»æ¶ˆæ¯æ•°é‡å¤±è´¥:', e);
      }
      
      // å›é€€åˆ°æœ¬åœ°å­˜å‚¨çš„æœªè¯»æ•°é‡
      try {
        const cached = localStorage.getItem('unreadCount');
        return cached ? parseInt(cached) : 0;
      } catch (e) {
        return 0;
      }
    }

    
    // æ›´æ–°æœªè¯»æ¶ˆæ¯å¾½ç« 
    async function updateUnreadBadge() {
      const chatFab = document.getElementById('chatFab');
      if (!chatFab) return;
      
      const badge = chatFab.querySelector('.badge');
      if (!badge) return;
      
      try {
        const unreadCount = await getUnreadCount();
        console.log('è·å–åˆ°æœªè¯»æ¶ˆæ¯æ•°é‡:', unreadCount);
        
        if (unreadCount > 0) {
          badge.textContent = unreadCount > 99 ? '99+' : unreadCount.toString();
          badge.style.display = 'flex';
          console.log('å¾½ç« æ˜¾ç¤º:', badge.textContent);
        } else {
          badge.style.display = 'none';
          console.log('å¾½ç« éšè—');
        }
        
        // ç¼“å­˜æœªè¯»æ•°é‡
        try {
          localStorage.setItem('unreadCount', unreadCount.toString());
        } catch (e) {
          console.warn('ç¼“å­˜æœªè¯»æ•°é‡å¤±è´¥:', e);
        }
      } catch (error) {
        console.error('æ›´æ–°å¾½ç« æ—¶å‡ºé”™:', error);
        // å‡ºé”™æ—¶éšè—å¾½ç« 
        badge.style.display = 'none';
      }
    }

    // é¡µé¢åŠ è½½å®Œæˆåæ›´æ–°å¾½ç« 
    document.addEventListener('DOMContentLoaded', () => {
      updateUnreadBadge();
      
      // æ¯30ç§’æ›´æ–°ä¸€æ¬¡æœªè¯»æ•°é‡
      setInterval(updateUnreadBadge, 30000);
    });

    // é¡µé¢è·å¾—ç„¦ç‚¹æ—¶æ›´æ–°å¾½ç« 
    document.addEventListener('focus', updateUnreadBadge);
    window.addEventListener('focus', updateUnreadBadge);
    
    // æ·»åŠ æµ‹è¯•åŠŸèƒ½ - åœ¨æ§åˆ¶å°è°ƒç”¨ testBadge(number) æ¥æµ‹è¯•å¾½ç« 
    window.testBadge = function(count) {
      const badge = document.querySelector('#chatFab .badge');
      if (!badge) {
        console.log('æœªæ‰¾åˆ°å¾½ç« å…ƒç´ ');
        return;
      }
      
      if (count > 0) {
        badge.textContent = count > 99 ? '99+' : count.toString();
        badge.style.display = 'flex';
        console.log(`æµ‹è¯•å¾½ç« æ˜¾ç¤º: ${badge.textContent}`);
      } else {
        badge.style.display = 'none';
        console.log('æµ‹è¯•å¾½ç« éšè—');
      }
    };
    
    console.log('å¾½ç« æµ‹è¯•åŠŸèƒ½å·²åŠ è½½ï¼Œä½¿ç”¨ testBadge(number) æ¥æµ‹è¯•');
  </script>
</body>
</html>
