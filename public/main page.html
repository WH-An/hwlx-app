<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æµ·å¤–ç•™å­¦ Â· ä¸»é¡µé¢</title>
  
  <!-- ç§»åŠ¨ç«¯ä¼˜åŒ–CSS -->
  <link rel="stylesheet" href="mobile-optimization.css">
  
  <!-- Open Graph å…ƒæ ‡ç­¾ - ç”¨äºç¤¾äº¤åª’ä½“åˆ†äº« -->
  <meta property="og:title" content="æµ·å¤–ç•™å­¦ Â· ä¸»é¡µé¢" />
  <meta property="og:description" content="æµ·å¤–ç•™å­¦ç”Ÿæ´»æŒ‡å—ï¼ŒåŒ…å«å­¦ä¹ æŒ‡å¯¼ã€ç”Ÿæ´»å°è´´å£«ã€å…¥å­¦æ­¥éª¤ç­‰å®ç”¨ä¿¡æ¯" />
  <meta property="og:image" content="https://raw.githubusercontent.com/WH-An/hwlx-app/main/%E8%93%9D%E9%BB%84%E5%B0%8F%E5%B8%86%E8%88%B9.png" />
  <meta property="og:url" content="https://hai-wai-liu-xue.onrender.com" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="æµ·å¤–ç•™å­¦" />
  
  <!-- Twitter Card å…ƒæ ‡ç­¾ -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="æµ·å¤–ç•™å­¦ Â· ä¸»é¡µé¢" />
  <meta name="twitter:description" content="æµ·å¤–ç•™å­¦ç”Ÿæ´»æŒ‡å—ï¼ŒåŒ…å«å­¦ä¹ æŒ‡å¯¼ã€ç”Ÿæ´»å°è´´å£«ã€å…¥å­¦æ­¥éª¤ç­‰å®ç”¨ä¿¡æ¯" />
  <meta name="twitter:image" content="https://raw.githubusercontent.com/WH-An/hwlx-app/main/%E8%93%9D%E9%BB%84%E5%B0%8F%E5%B8%86%E8%88%B9.png" />
  
  <!-- å…¶ä»–å…ƒæ ‡ç­¾ -->
  <meta name="description" content="æµ·å¤–ç•™å­¦ç”Ÿæ´»æŒ‡å—ï¼ŒåŒ…å«å­¦ä¹ æŒ‡å¯¼ã€ç”Ÿæ´»å°è´´å£«ã€å…¥å­¦æ­¥éª¤ç­‰å®ç”¨ä¿¡æ¯" />
  <meta name="keywords" content="æµ·å¤–ç•™å­¦,ç•™å­¦ç”Ÿæ´»,å­¦ä¹ æŒ‡å¯¼,ç”Ÿæ´»å°è´´å£«,å…¥å­¦æ­¥éª¤" />
  <meta name="author" content="æµ·å¤–ç•™å­¦" />
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --accent:#16a34a;
      --accent-2:#22c55e;
      --border:#e5e7eb;
      --shadow:0 10px 30px rgba(0,0,0,.18);
      --radius:18px;
      --mobile-nav-height: 70px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:'Microsoft YaHei',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'PingFang SC',sans-serif;background:radial-gradient(1200px 600px at 10% -10%,#1f8db8 18%, transparent 60%),radial-gradient(900px 500px at 110% 110%,#2bb8d6 12%, transparent 60%), var(--bg);color:#fff;overflow:visible}

    .container{display:grid;grid-template-columns: 220px 1fr;grid-template-rows: 220px 1fr;gap:18px;min-height:100vh;padding:24px;overflow:visible}

    .sidebar{grid-row:1/3;background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px 16px;color:var(--text);display:flex;flex-direction:column;gap:16px}
    .account-info{display:flex;flex-direction:column;align-items:center;gap:10px;text-decoration:none;color:inherit;border:1px dashed #eef2ff;border-radius:14px;padding:14px;background:#fff}
    .avatar{width:56px;height:56px;border-radius:50%;object-fit:cover}
    .username{font-weight:700}

    .nav-list{list-style:none;margin:6px 0 0;padding:0;display:flex;flex-direction:column;gap:10px}
    .nav-list li{display:block}
    .nav-list a{display:flex;align-items:center;gap:10px;justify-content:flex-start;text-decoration:none;color:var(--text);border:1px solid var(--border);background:#fafafa;border-radius:12px;padding:10px 14px;transition:.2s background,.2s transform}
    .nav-list a:hover{background:#f3f4f6;transform:translateY(-1px)}
    .nav-icon{width:22px;display:inline-flex;justify-content:center}

    .Welcome{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);display:flex;align-items:center;justify-content:center;color:var(--text);font-size:48px;font-weight:800}

    .dropdown{position:absolute;top:28px;right:32px;z-index:10}
    .dropdown-btn{background:#fff;color:#111827;border:1px solid var(--border);border-radius:12px;padding:8px 14px;cursor:pointer;font-weight:700}
    .dropdown-list{position:absolute;right:0;margin-top:8px;background:#fff;border:1px solid var(--border);border-radius:12px;padding:8px 0;list-style:none;display:none;min-width:160px;box-shadow:var(--shadow)}
    .dropdown-list li{border-bottom:1px solid #f1f5f9}
    .dropdown-list li:last-child{border-bottom:none}
    .dropdown-list a{display:block;padding:10px 14px;color:#111827;text-decoration:none}
    .dropdown-list a:hover{background:#f3f4f6}

    .text{position:relative;background:#0b1220;border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);box-shadow:var(--shadow);display:flex;align-items:center;justify-content:center;padding:28px;line-height:1.8;font-size:20px;text-align:center}
    .text::before{content:"";position:absolute;inset:0;border-radius:inherit;background:url('https://raw.githubusercontent.com/WH-An/hwlx-app/main/%E8%93%9D%E9%BB%84%E5%B0%8F%E5%B8%86%E8%88%B9.png') center/cover no-repeat;opacity:.18}
    .text>span{position:relative;z-index:1;max-width:70ch}

    /* ç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆª */
    .mobile-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:var(--panel);border-top:1px solid var(--border);z-index:1000;padding:8px 0}
    .mobile-nav-list{display:flex;justify-content:space-around;list-style:none;margin:0;padding:0}
    .mobile-nav-item{flex:1;text-align:center}
    .mobile-nav-link{display:flex;flex-direction:column;align-items:center;gap:4px;text-decoration:none;color:var(--text);padding:8px 4px;font-size:12px;transition:.2s color}
    .mobile-nav-link:hover,.mobile-nav-link.active{color:var(--accent)}
    .mobile-nav-icon{font-size:20px;margin-bottom:2px}

    /* æ±‰å ¡èœå•æŒ‰é’® */
    .hamburger{display:none;position:fixed;top:20px;left:20px;z-index:1001;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px;cursor:pointer;box-shadow:var(--shadow)}
    .hamburger span{display:block;width:20px;height:2px;background:var(--text);margin:4px 0;transition:.3s}
    .hamburger.active span:nth-child(1){transform:rotate(45deg) translate(5px,5px)}
    .hamburger.active span:nth-child(2){opacity:0}
    .hamburger.active span:nth-child(3){transform:rotate(-45deg) translate(7px,-6px)}

    /* ç§»åŠ¨ç«¯ä¾§è¾¹æ  */
    .mobile-sidebar{position:fixed;top:0;left:-280px;width:280px;height:100vh;background:var(--panel);border-right:1px solid var(--border);z-index:1000;transition:.3s ease;overflow-y:auto;padding:20px 16px}
    .mobile-sidebar.active{left:0}
    .mobile-sidebar-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:999;opacity:0;visibility:hidden;transition:.3s ease}
    .mobile-sidebar-overlay.active{opacity:1;visibility:visible}

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 960px){
      .container{grid-template-columns: 1fr;grid-template-rows:auto auto 1fr;padding:16px;padding-bottom:calc(var(--mobile-nav-height) + 20px)}
      .sidebar{display:none}
      .Welcome{font-size:32px;padding:18px;min-height:120px}
      .dropdown{position:static;justify-self:end;margin-bottom:16px}
      .text{padding:20px;font-size:18px;min-height:120px}
      .text>span{max-width:100%}
      
      /* æ˜¾ç¤ºç§»åŠ¨ç«¯å¯¼èˆª */
      .mobile-nav{display:block}
      .hamburger{display:block}
    }

    @media (max-width: 480px){
      .container{padding:12px;padding-bottom:calc(var(--mobile-nav-height) + 16px)}
      .Welcome{font-size:28px;padding:16px;min-height:100px}
      .text{padding:16px;font-size:16px;min-height:100px}
      .dropdown-btn{padding:6px 12px;font-size:14px}
      .mobile-nav{height:var(--mobile-nav-height)}
      .mobile-nav-link{font-size:11px}
      .mobile-nav-icon{font-size:18px}
    }

    #chatFab{
      position: fixed;
      left: 16px; bottom: calc(var(--mobile-nav-height) + 16px);
      width: 48px; height: 48px; border-radius: 9999px;
      display: flex; align-items: center; justify-content: center;
      background: #0f172a; color: #fff; border: 1px solid rgba(255,255,255,.15);
      box-shadow: 0 10px 24px rgba(0,0,0,.28);
      cursor: pointer; user-select: none; z-index: 999;
      transition: transform .15s ease, box-shadow .15s ease, opacity .2s ease;
    }
    #chatFab:hover{ transform: translateY(-1px); box-shadow: 0 14px 28px rgba(0,0,0,.32); }
    #chatFab:active{ transform: translateY(0); box-shadow: 0 8px 18px rgba(0,0,0,.26); }
    #chatFab .badge{
      position: absolute; right: -2px; top: -2px;
      min-width: 18px; height: 18px; padding: 0 5px;
      display: none; align-items: center; justify-content: center;
      background: #ef4444; color: #fff; border-radius: 9999px;
      font-size: 11px; line-height: 18px; box-shadow: 0 2px 6px rgba(0,0,0,.18);
    }
    @media (max-width: 480px){
      #chatFab{ left: 12px; bottom: calc(var(--mobile-nav-height) + 12px); width: 44px; height: 44px; }
    }
  </style>
</head>
<body>
  <!-- æ±‰å ¡èœå•æŒ‰é’® -->
  <div class="hamburger" id="hamburger">
    <span></span>
    <span></span>
    <span></span>
  </div>

  <!-- ç§»åŠ¨ç«¯ä¾§è¾¹æ  -->
  <div class="mobile-sidebar" id="mobileSidebar">
    <a class="account-info" href="profile.html">
      <img src="https://raw.githubusercontent.com/WH-An/hwlx-app/2df4e97b395bebb7977074fbb31741f3c35da9a0/assets-task_01k3v2vy06fra8er06x602xnpe-1756476933_img_1.webp" alt="å¤´åƒ" class="avatar">
      <span class="username">æˆ‘çš„è´¦å·</span>
    </a>
    <ul class="nav-list">
      <li><a href="main page.html"><span class="nav-icon">ğŸ </span><span class="nav-text">ä¸»é¡µ</span></a></li>
      <li><a href="life-tips.html"><span class="nav-icon">ğŸ’¡</span><span class="nav-text">ç”Ÿæ´»å°è´´å£«</span></a></li>
      <li><a href="study-guide.html"><span class="nav-icon">ğŸ“š</span><span class="nav-text">å­¦ä¹ æŒ‡å¯¼</span></a></li>
      <li><a href="enrollment-steps.html"><span class="nav-icon">ğŸ“</span><span class="nav-text">å…¥å­¦æ­¥éª¤</span></a></li>
      <li><a href="share.html"><span class="nav-icon">ğŸ”—</span><span class="nav-text">åˆ†äº«</span></a></li>
      <li><a href="fun.html"><span class="nav-icon">ğŸ‰</span><span class="nav-text">å¨±ä¹</span></a></li>
      <li><a href="hospital.html"><span class="nav-icon">ğŸ¥</span><span class="nav-text">åŒ»é™¢</span></a></li>
    </ul>
  </div>

  <!-- ç§»åŠ¨ç«¯ä¾§è¾¹æ é®ç½© -->
  <div class="mobile-sidebar-overlay" id="mobileSidebarOverlay"></div>

  <div class="container">
    <div class="sidebar">
      <a class="account-info" href="profile.html">
        <img src="https://raw.githubusercontent.com/WH-An/hwlx-app/2df4e97b395bebb7977074fbb31741f3c35da9a0/assets-task_01k3v2vy06fra8er06x602xnpe-1756476933_img_1.webp" alt="å¤´åƒ" class="avatar">
        <span class="username">æˆ‘çš„è´¦å·</span>
      </a>
      <ul class="nav-list">
        <li><a href="main page.html"><span class="nav-icon">ğŸ </span><span class="nav-text">ä¸»é¡µ</span></a></li>
        <li><a href="life-tips.html"><span class="nav-icon">ğŸ’¡</span><span class="nav-text">ç”Ÿæ´»å°è´´å£«</span></a></li>
        <li><a href="study-guide.html"><span class="nav-icon">ğŸ“š</span><span class="nav-text">å­¦ä¹ æŒ‡å¯¼</span></a></li>
        <li><a href="enrollment-steps.html"><span class="nav-icon">ğŸ“</span><span class="nav-text">å…¥å­¦æ­¥éª¤</span></a></li>
        <li><a href="share.html"><span class="nav-icon">ğŸ”—</span><span class="nav-text">åˆ†äº«</span></a></li>
        <li><a href="fun.html"><span class="nav-icon">ğŸ‰</span><span class="nav-text">å¨±ä¹</span></a></li>
        <li><a href="hospital.html"><span class="nav-icon">ğŸ¥</span><span class="nav-text">åŒ»é™¢</span></a></li>
      </ul>
    </div>

    <div class="Welcome">æ¬¢è¿ä½¿ç”¨æµ·å¤–ç•™å­¦APP</div>

    <div class="dropdown">
      <button class="dropdown-btn">åœ°åŒº â–¼</button>
      <!-- åªæ›¿æ¢è¿™ä¸ª <ul> å°±è¡Œ -->
<ul class="dropdown-list">
  <li><a href="#">å…¨éƒ¨</a></li>
  <li><a href="#">é©¬æ¥è¥¿äºš</a></li>
  <li><a href="#">æ–°åŠ å¡</a></li>
  <li><a href="#">é¦™æ¸¯</a></li>
</ul>

    </div>

    <div class="text">
      <span>è·¨è¶Šæµ·æ´‹ï¼Œä¸åªæ˜¯ä¸ºäº†è¿œæ–¹çš„é£æ™¯ï¼Œæ›´æ˜¯ä¸ºäº†ä½“éªŒä¸åŒçš„æ€ç»´æ–¹å¼ã€‚ç•™å­¦ï¼Œæ˜¯ä¸€åœºå…³äºçŸ¥è¯†ä¸æ–‡åŒ–çš„æ·±åº¦æ¢ç´¢ã€‚</span>
    </div>
  </div>

  <!-- ç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆª -->
  <nav class="mobile-nav">
    <ul class="mobile-nav-list">
      <li class="mobile-nav-item">
        <a href="main page.html" class="mobile-nav-link active">
          <span class="mobile-nav-icon">ğŸ </span>
          <span>ä¸»é¡µ</span>
        </a>
      </li>
      <li class="mobile-nav-item">
        <a href="life-tips.html" class="mobile-nav-link">
          <span class="mobile-nav-icon">ğŸ’¡</span>
          <span>ç”Ÿæ´»</span>
        </a>
      </li>
      <li class="mobile-nav-item">
        <a href="study-guide.html" class="mobile-nav-link">
          <span class="mobile-nav-icon">ğŸ“š</span>
          <span>å­¦ä¹ </span>
        </a>
      </li>
      <li class="mobile-nav-item">
        <a href="enrollment-steps.html" class="mobile-nav-link">
          <span class="mobile-nav-icon">ğŸ“</span>
          <span>å…¥å­¦</span>
        </a>
      </li>
      <li class="mobile-nav-item">
        <a href="share.html" class="mobile-nav-link">
          <span class="mobile-nav-icon">ğŸ”—</span>
          <span>åˆ†äº«</span>
        </a>
      </li>
      <li class="mobile-nav-item">
        <a href="hospital.html" class="mobile-nav-link">
          <span class="mobile-nav-icon">ğŸ¥</span>
          <span>åŒ»é™¢</span>
        </a>
      </li>
    </ul>
  </nav>

  <!-- ç§»åŠ¨ç«¯ä¼˜åŒ–JavaScript - å·²é›†æˆåˆ°ä¸»é¡µä»£ç ä¸­ -->

  <script>
/* ç§»åŠ¨ç«¯äº¤äº’åŠŸèƒ½ - ä¸»é¡µä¸“ç”¨ç‰ˆæœ¬ */
(function(){
  const hamburger = document.getElementById('hamburger');
  const mobileSidebar = document.getElementById('mobileSidebar');
  const mobileSidebarOverlay = document.getElementById('mobileSidebarOverlay');
  const mobileNavLinks = document.querySelectorAll('.mobile-nav-link');

  // æ±‰å ¡èœå•ç‚¹å‡»äº‹ä»¶
  if(hamburger && mobileSidebar && mobileSidebarOverlay) {
    hamburger.addEventListener('click', () => {
      console.log('æ±‰å ¡èœå•è¢«ç‚¹å‡»'); // è°ƒè¯•æ—¥å¿—
      hamburger.classList.toggle('active');
      mobileSidebar.classList.toggle('active');
      mobileSidebarOverlay.classList.toggle('active');
      document.body.style.overflow = mobileSidebar.classList.contains('active') ? 'hidden' : '';
    });

    // ç‚¹å‡»é®ç½©å…³é—­ä¾§è¾¹æ 
    mobileSidebarOverlay.addEventListener('click', () => {
      hamburger.classList.remove('active');
      mobileSidebar.classList.remove('active');
      mobileSidebarOverlay.classList.remove('active');
      document.body.style.overflow = '';
    });

    // ESCé”®å…³é—­ä¾§è¾¹æ 
    document.addEventListener('keydown', (e) => {
      if(e.key === 'Escape' && mobileSidebar.classList.contains('active')) {
        hamburger.classList.remove('active');
        mobileSidebar.classList.remove('active');
        mobileSidebarOverlay.classList.remove('active');
        document.body.style.overflow = '';
      }
    });
  } else {
    console.warn('ç§»åŠ¨ç«¯å¯¼èˆªå…ƒç´ æœªæ‰¾åˆ°:', { hamburger, mobileSidebar, mobileSidebarOverlay });
  }

  // ç§»åŠ¨ç«¯å¯¼èˆªé“¾æ¥ç‚¹å‡»äº‹ä»¶
  mobileNavLinks.forEach(link => {
    link.addEventListener('click', () => {
      // ç§»é™¤æ‰€æœ‰activeç±»
      mobileNavLinks.forEach(l => l.classList.remove('active'));
      // æ·»åŠ activeç±»åˆ°å½“å‰ç‚¹å‡»çš„é“¾æ¥
      link.classList.add('active');
    });
  });

  // è§¦æ‘¸æ‰‹åŠ¿æ”¯æŒ
  let startX = 0;
  let startY = 0;
  let currentX = 0;
  let currentY = 0;

  document.addEventListener('touchstart', (e) => {
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
  });

  document.addEventListener('touchmove', (e) => {
    currentX = e.touches[0].clientX;
    currentY = e.touches[0].clientY;
  });

  document.addEventListener('touchend', () => {
    const deltaX = currentX - startX;
    const deltaY = currentY - startY;
    const minSwipeDistance = 50;

    // ä»å·¦å‘å³æ»‘åŠ¨æ‰“å¼€ä¾§è¾¹æ 
    if(deltaX > minSwipeDistance && Math.abs(deltaY) < Math.abs(deltaX) && startX < 50) {
      if(mobileSidebar && !mobileSidebar.classList.contains('active')) {
        hamburger.classList.add('active');
        mobileSidebar.classList.add('active');
        mobileSidebarOverlay.classList.add('active');
        document.body.style.overflow = 'hidden';
      }
    }
    // ä»å³å‘å·¦æ»‘åŠ¨å…³é—­ä¾§è¾¹æ 
    else if(deltaX < -minSwipeDistance && Math.abs(deltaY) < Math.abs(deltaX) && mobileSidebar && mobileSidebar.classList.contains('active')) {
      hamburger.classList.remove('active');
      mobileSidebar.classList.remove('active');
      mobileSidebarOverlay.classList.remove('active');
      document.body.style.overflow = '';
    }
  });
})();

/* ç™»å½•åçš„ç”¨æˆ·ä¿¡æ¯æ¸²æŸ“ï¼ˆä¼˜å…ˆä»æœåŠ¡å™¨è·å–æœ€æ–°ä¿¡æ¯ï¼‰ */
(async function hydrateUser(){
  try{
    const avatarEl = document.querySelector('.avatar');
    const nameEl   = document.querySelector('.username');

    const FALLBACK_AVATAR_DATAURL = 'https://raw.githubusercontent.com/WH-An/hwlx-app/2df4e97b395bebb7977074fbb31741f3c35da9a0/assets-task_01k3v2vy06fra8er06x602xnpe-1756476933_img_1.webp';

    // æ·»åŠ åŠ è½½çŠ¶æ€
    if (avatarEl) {
      avatarEl.style.opacity = '0.7';
      avatarEl.style.transition = 'opacity 0.3s ease';
    }

    // ä¼˜å…ˆä»æœåŠ¡å™¨è·å–æœ€æ–°ç”¨æˆ·ä¿¡æ¯
    try {
      // è‡ªåŠ¨æ£€æµ‹APIåŸºç¡€URL
      const API_BASE = (() => {
        if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
          return 'http://127.0.0.1:3001';
        }
        return ''; // ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ç›¸å¯¹è·¯å¾„
      })();
      
      const response = await fetch(API_BASE + '/api/users/me', { 
        credentials: 'include' 
      });
      
      if (response.ok) {
        const user = await response.json();
        const displayName = user.nickname || user.username || user.displayName || user.name || user.email || 'æˆ‘çš„è´¦å·';
        let avatar = user.avatarPath || user.avatarUrl || user.avatar || '';

        const explicit = window.BACKEND_ORIGIN && String(window.BACKEND_ORIGIN).trim();
        const sameOrigin = location.origin && !/^file:/i.test(location.origin) ? location.origin : '';
        const devFallback = (location.hostname === 'localhost' || location.hostname === '127.0.0.1') ? 'http://localhost:3001' : '';
        const BACKEND_ORIGIN = explicit || sameOrigin || devFallback;

        if (avatar && !/^https?:\/\//i.test(avatar)) {
          avatar = avatar.startsWith('/') ? (BACKEND_ORIGIN + avatar) : (BACKEND_ORIGIN + '/' + avatar);
        }

        // å¹³æ»‘æ›´æ–°ç”¨æˆ·ä¿¡æ¯
        if (nameEl) { 
          nameEl.textContent = displayName; 
          nameEl.title = displayName; 
        }
        
        if (avatarEl) { 
          // é¢„åŠ è½½å¤´åƒï¼Œé¿å…é—ªçƒ
          const img = new Image();
          img.onload = () => {
            avatarEl.src = avatar || FALLBACK_AVATAR_DATAURL;
            avatarEl.style.opacity = '1';
          };
          img.onerror = () => {
            avatarEl.src = FALLBACK_AVATAR_DATAURL;
            avatarEl.style.opacity = '1';
          };
          img.src = avatar || FALLBACK_AVATAR_DATAURL;
          avatarEl.alt = displayName || 'æˆ‘çš„å¤´åƒ';
        }
        
        // æ›´æ–°æœ¬åœ°å­˜å‚¨
        localStorage.setItem('currentUser', JSON.stringify(user));
        return;
      }
    } catch (e) {
      console.warn('ä»æœåŠ¡å™¨è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨:', e);
    }

    // å¦‚æœæœåŠ¡å™¨è·å–å¤±è´¥ï¼Œå›é€€åˆ°æœ¬åœ°å­˜å‚¨
    const raw = localStorage.getItem('meUser')
         || localStorage.getItem('currentUser')
         || localStorage.getItem('user')
         || localStorage.getItem('USER')
         || localStorage.getItem('auth_user');

    if(!raw){
      if (nameEl) nameEl.textContent = 'æˆ‘çš„è´¦å·';
      if (avatarEl) { 
        avatarEl.src = FALLBACK_AVATAR_DATAURL; 
        avatarEl.alt = 'æˆ‘çš„å¤´åƒ';
        avatarEl.style.opacity = '1';
      }
      return;
    }

    const u = JSON.parse(raw) || {};
    const displayName = u.nickname || u.username || u.displayName || u.name || u.email || 'æˆ‘çš„è´¦å·';
    let avatar = u.avatarPath || u.avatarUrl || u.avatar || '';

    const explicit = window.BACKEND_ORIGIN && String(window.BACKEND_ORIGIN).trim();
    const sameOrigin = location.origin && !/^file:/i.test(location.origin) ? location.origin : '';
    const devFallback = (location.hostname === 'localhost' || location.hostname === '127.0.0.1') ? 'http://localhost:3001' : '';
    const BACKEND_ORIGIN = explicit || sameOrigin || devFallback;

    if (avatar && !/^https?:\/\//i.test(avatar)) {
      avatar = avatar.startsWith('/') ? (BACKEND_ORIGIN + avatar) : (BACKEND_ORIGIN + '/' + avatar);
    }

    if (nameEl) { nameEl.textContent = displayName; nameEl.title = displayName; }
    if (avatarEl) { 
      // é¢„åŠ è½½å¤´åƒï¼Œé¿å…é—ªçƒ
      const img = new Image();
      img.onload = () => {
        avatarEl.src = avatar || FALLBACK_AVATAR_DATAURL;
        avatarEl.style.opacity = '1';
      };
      img.onerror = () => {
        avatarEl.src = FALLBACK_AVATAR_DATAURL;
        avatarEl.style.opacity = '1';
      };
      img.src = avatar || FALLBACK_AVATAR_DATAURL;
      avatarEl.alt = displayName || 'æˆ‘çš„å¤´åƒ';
    }
  }catch(e){ 
    console.error('ç”¨æˆ·ä¿¡æ¯æ¸²æŸ“å¤±è´¥:', e);
    // è®¾ç½®é»˜è®¤å€¼
    const avatarEl = document.querySelector('.avatar');
    const nameEl = document.querySelector('.username');
    if (nameEl) nameEl.textContent = 'æˆ‘çš„è´¦å·';
    if (avatarEl) avatarEl.src = 'data:image/svg+xml;utf8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="128" height="128"><defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#bbb"/><stop offset="100%" stop-color="#eee"/></linearGradient></defs><rect width="100%" height="100%" fill="url(#g)"/><circle cx="64" cy="54" r="26" fill="#fff"/><rect x="24" y="86" width="80" height="28" rx="14" fill="#fff"/></svg>`);
  }
})();

/* æ¶ˆæ¯æ‚¬æµ®æŒ‰é’®ï¼ˆä¿æŒä½ åŸé€»è¾‘ï¼‰ */
(function(){
  // è‡ªåŠ¨æ£€æµ‹APIåŸºç¡€URL
  const BASE_URL = (() => {
    if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
      return 'http://127.0.0.1:3001';
    }
    return ''; // ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ç›¸å¯¹è·¯å¾„
  })();
  const MESSAGES_PATH = '/messages.html';

  let fab = document.getElementById('chatFab');
  if(!fab){
    fab = document.createElement('button');
    fab.id = 'chatFab';
    fab.setAttribute('aria-label','æ¶ˆæ¯');
    fab.title = 'æ¶ˆæ¯';
    fab.innerHTML = 'ğŸ’¬';
    const badge = document.createElement('span'); badge.className = 'badge'; fab.appendChild(badge);
    fab.addEventListener('click', ()=> location.href = MESSAGES_PATH);
    document.body.appendChild(fab);
  }
  const badgeEl = fab.querySelector('.badge');

  const READ_KEY = (me, peer) => `read:${(me||'').toLowerCase()}::${(peer||'').toLowerCase()}`;
  async function apiMe(){ const r = await fetch(BASE_URL + '/api/users/me', { credentials:'include' }); if(!r.ok) throw 0; return r.json(); }
  async function apiThreads(){ const r = await fetch(BASE_URL + '/api/messages/threads', { credentials:'include' }); if(!r.ok) throw 0; return r.json(); }
  async function apiDialog(peer){ const r = await fetch(BASE_URL + '/api/messages?peer=' + encodeURIComponent(peer), { credentials:'include' }); if(!r.ok) throw 0; return r.json(); }
  async function computeUnreadTotal(){
    console.log('å¼€å§‹è®¡ç®—æœªè¯»æ¶ˆæ¯æ•°é‡...');
    let me; try { me = await apiMe(); } catch (e) { console.log('ç”¨æˆ·æœªç™»å½•æˆ–è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', e); setBadge(0); return; }
    const meMail = (me.email||'').toLowerCase();
    console.log('å½“å‰ç”¨æˆ·é‚®ç®±:', meMail);
    let total = 0, threads = [];
    try { threads = await apiThreads(); } catch (e) { console.log('è·å–æ¶ˆæ¯çº¿ç¨‹å¤±è´¥:', e); setBadge(0); return; }
    console.log('æ¶ˆæ¯çº¿ç¨‹æ•°é‡:', threads.length);
    for(const t of threads){
      const peer = (t.peer||'').trim();
      try{
        const msgs = await apiDialog(peer);
        const lastReadISO = localStorage.getItem(READ_KEY(meMail, peer.toLowerCase())) || '1970-01-01T00:00:00.000Z';
        const lastRead = new Date(lastReadISO);
        const unreadCount = msgs.filter(m => String(m.to||'').toLowerCase() === meMail && new Date(m.createdAt) > lastRead).length;
        total += unreadCount;
        console.log(`ä¸ ${peer} çš„æœªè¯»æ¶ˆæ¯: ${unreadCount}`);
      }catch(e){ console.log(`è·å–ä¸ ${peer} çš„å¯¹è¯å¤±è´¥:`, e); }
    }
    console.log('æ€»æœªè¯»æ¶ˆæ¯æ•°é‡:', total);
    setBadge(total);
  }
  function setBadge(n){ 
    console.log('è®¾ç½®å¾½ç« æ•°é‡:', n, 'å¾½ç« å…ƒç´ :', badgeEl);
    if(!badgeEl) { console.log('å¾½ç« å…ƒç´ ä¸å­˜åœ¨'); return; } 
    if(n>0){
      badgeEl.style.display='flex'; 
      badgeEl.textContent = n>99?'99+':String(n);
      console.log('æ˜¾ç¤ºå¾½ç« ï¼Œæ•°é‡:', badgeEl.textContent);
    } else { 
      badgeEl.style.display='none'; 
      console.log('éšè—å¾½ç« ');
    } 
  }
  computeUnreadTotal(); let timer = setInterval(computeUnreadTotal, 15000);
  document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState === 'visible') computeUnreadTotal(); });
  window.addEventListener('beforeunload', ()=> clearInterval(timer));
})();

/* ä¸»é¡µï¼šåœ°åŒºé€‰æ‹©ï¼ˆé˜»æ­¢è·³è½¬â†’ä¿å­˜åˆ° localStorageâ†’å¹¿æ’­ï¼‰ï¼Œä¸æ”¹ç»“æ„/æ ·å¼ */
(function(){
  const btn  = document.querySelector('.dropdown-btn');
  const list = document.querySelector('.dropdown-list');
  if(!btn || !list) return;

  const REGION_KEY = 'region';
  const DEFAULT_REGION = 'å…¨éƒ¨';
  const baseBtnText = (btn.textContent || '').replace(/ï¼ˆ.*?ï¼‰/g,'').trim();

  function updateBtn(region){ btn.textContent = `${baseBtnText}ï¼ˆ${region}ï¼‰`; }
  function setRegion(region){
    const value = (region || '').trim() || DEFAULT_REGION;
    localStorage.setItem(REGION_KEY, value);
    updateBtn(value);
    document.dispatchEvent(new CustomEvent('regionchange', { detail:{ region:value } }));
  }

  // åˆå§‹åŒ–ï¼šä¿è¯é»˜è®¤æ˜¯â€œå…¨éƒ¨â€ï¼Œå¹¶åŒæ­¥æŒ‰é’®
  if(!localStorage.getItem(REGION_KEY)){ localStorage.setItem(REGION_KEY, DEFAULT_REGION); }
  updateBtn(localStorage.getItem(REGION_KEY) || DEFAULT_REGION);

  // å±•å¼€/æ”¶èµ·ï¼ˆåªåˆ‡ displayï¼‰
  btn.addEventListener('click', (e)=>{
    e.stopPropagation();
    const show = getComputedStyle(list).display === 'none';
    list.style.display = show ? 'block' : 'none';
  });
  document.addEventListener('click', ()=> list.style.display = 'none');

  // æ‹¦æˆª a çš„é»˜è®¤è·³è½¬ï¼Œç”¨å…¶æ–‡æœ¬ä½œä¸ºåœ°åŒºï¼›æé«˜ä¼˜å…ˆçº§é¿å…æ—§ç›‘å¬æŠ¢å…ˆ
  list.querySelectorAll('a').forEach(a=>{
    a.addEventListener('click', (e)=>{
      e.preventDefault();
      e.stopImmediatePropagation();
      const region = (a.textContent || '').trim();
      setRegion(region);
      list.style.display = 'none';
      return false;
    }, { capture:true });
  });
})();

(function(){
  const REGION_KEY = 'region';
  const DEFAULT_REGION = 'å…¨éƒ¨';
  // è‡ªåŠ¨æ£€æµ‹APIåŸºç¡€URL
  const API_BASE = (() => {
    if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
      return 'http://127.0.0.1:3001';
    }
    return ''; // ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ç›¸å¯¹è·¯å¾„
  })();
  const ITEM_SELECTOR = '.card';
  const LIST = document.getElementById('masonry');

  const norm = s => String(s||'').replace(/\s+/g,'').toLowerCase();
  const getRegion = () => localStorage.getItem(REGION_KEY) || DEFAULT_REGION;

  const areaMap = new Map();
  async function fetchAreaByEmail(email){
    const key = (email||'').trim().toLowerCase();
    if(!key) return '';
    if(areaMap.has(key)) return areaMap.get(key);
    try{
      const r = await fetch(`${API_BASE}/api/users/by-email?email=${encodeURIComponent(key)}`, { credentials:'include' });
      if(!r.ok){ areaMap.set(key,''); return ''; }
      const u = await r.json(); const area = (u.area || '').trim();
      areaMap.set(key, area); return area;
    }catch{ areaMap.set(key,''); return ''; }
  }
  async function preloadAreas(posts){
    const emails = [...new Set((posts||[]).map(p => (p.authorEmail||'').trim().toLowerCase()).filter(Boolean))];
    await Promise.all(emails.map(fetchAreaByEmail));
  }
  async function applyRegionFilter(posts){
    const want = norm(getRegion());
    const cards = Array.from(document.querySelectorAll(ITEM_SELECTOR));
    const n = Math.min(cards.length, (posts||[]).length);
    if(n===0) return;
    await preloadAreas(posts);
    let shown = 0;
    for(let i=0;i<n;i++){
      const card = cards[i], post = posts[i]||{}, email = (post.authorEmail||'').trim().toLowerCase();
      if(want===norm(DEFAULT_REGION) || !email || !(areaMap.get(email)||'')){
        card.style.display=''; card.setAttribute('aria-hidden','false'); shown++; continue;
      }
      const hit = norm(areaMap.get(email)).includes(want);
      card.style.display = hit ? '' : 'none';
      card.setAttribute('aria-hidden', hit ? 'false' : 'true');
      if(hit) shown++;
    }
    const counter = document.querySelector('#resultCount'); if(counter) counter.textContent = String(shown);
  }
  const _origRenderPosts = window.renderPosts;
  if(typeof _origRenderPosts === 'function'){
    window.renderPosts = function(posts){ _origRenderPosts(posts); window.__renderedPosts__ = posts||[]; applyRegionFilter(window.__renderedPosts__); };
  }
  document.addEventListener('regionchange', ()=> applyRegionFilter(window.__renderedPosts__||[]));
  if(window.MutationObserver && LIST){
    const mo = new MutationObserver(()=> applyRegionFilter(window.__renderedPosts__||[]));
    mo.observe(LIST, { childList:true, subtree:false });
  }
})();

  </script>
</body>
</html>
