<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>åå°ç®¡ç† Â· å‘å¸ƒå†…å®¹</title>
  <!-- ç§»åŠ¨ç«¯ä¼˜åŒ–CSS -->
  <link rel="stylesheet" href="mobile-optimization.css">
  

  
  <style>
    :root{--bg:#0b0f14;--panel:#ffffff;--text:#0f172a;--muted:#64748b;--accent:#16a34a;--danger:#ef4444;--border:#e5e7eb;--shadow:0 10px 30px rgba(0,0,0,.18);--radius:18px}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:'Microsoft YaHei',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'PingFang SC',sans-serif;background:radial-gradient(1200px 600px at 10% -10%,#1f8db8 18%, transparent 60%),radial-gradient(900px 500px at 110% 110%,#2bb8d6 12%, transparent 60%),var(--bg);color:#fff}
          .layout{display:grid;grid-template-columns:220px 1fr;gap:18px;height:100vh;padding:24px;overflow:visible}
    .sidebar{background:var(--panel);color:var(--text);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px 16px;display:flex;flex-direction:column;gap:16px}
    .account-info{display:flex;flex-direction:column;align-items:center;gap:10px;text-decoration:none;color:inherit;border:1px dashed #eef2ff;border-radius:14px;padding:14px;background:#fff}
    .avatar{width:56px;height:56px;border-radius:50%;object-fit:cover}
    .username{font-weight:700}
    .nav-list{list-style:none;margin:6px 0 0;padding:0;display:flex;flex-direction:column;gap:10px}
    .nav-list a{display:flex;align-items:center;gap:10px;text-decoration:none;color:var(--text);border:1px solid var(--border);background:#fafafa;border-radius:12px;padding:10px 14px;transition:.2s}
    .nav-list a:hover{background:#f3f4f6;transform:translateY(-1px)}
    .nav-icon{width:22px;display:inline-flex;justify-content:center}
    .main{background:var(--panel);color:var(--text);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px;display:flex;flex-direction:column;gap:14px;height:100%;overflow:hidden}
    h1{font-size:18px;margin:0}
    .bar{display:flex;gap:10px;align-items:center}
    .bar .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;cursor:pointer;border:1px solid var(--border);background:#fff;color:#111827;border-radius:12px;padding:8px 12px;font-weight:700;transition:.15s}
    .btn:hover{background:#f3f4f6}
    .btn-danger{border-color:#fecaca;color:#991b1b}
    .btn-danger:hover{background:#fee2e2}
    .grid{display:grid;grid-template-columns:1fr;gap:14px;min-height:0}
    .card{border:1px solid var(--border);border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.06);background:#fff;overflow:hidden;display:flex;flex-direction:column}
    .card h2{font-size:16px;margin:0;padding:12px 14px;border-bottom:1px solid var(--border)}
    .card .body{padding:12px 14px;overflow:auto}
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
    .field label{font-size:12px;color:#334155}
    .field input,.field textarea,.field select{border:1px solid var(--border);border-radius:12px;padding:10px 12px;font-size:14px;outline:none}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    table{width:100%;border-collapse:collapse}
    th,td{font-size:13px;text-align:left;border-bottom:1px solid var(--border);padding:8px}
    tbody tr:hover{background:#fafafa}
    .pill{display:inline-flex;align-items:center;gap:6px;font-size:12px;border:1px solid var(--border);border-radius:999px;padding:4px 8px;background:#fff}
    .pill.pin{border-color:#bbf7d0;background:#f0fdf4;color:#166534}
    .muted{color:#64748b}
    .right{justify-content:flex-end}
    .danger{color:#b91c1c}
    .tip{font-size:12px;color:#64748b}
    .image-preview{position:relative;width:80px;height:80px;border:1px solid var(--border);border-radius:8px;overflow:hidden;background:#f9fafb}
    .image-preview img{width:100%;height:100%;object-fit:cover}
    .image-preview .remove{position:absolute;top:2px;right:2px;width:20px;height:20px;background:rgba(0,0,0,.6);color:#fff;border:none;border-radius:50%;cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center}
    .image-preview .remove:hover{background:rgba(0,0,0,.8)}
    .drop-zone{transition:all .2s ease}
    .drop-zone.dragover{border-color:#16a34a;background-color:#f0fdf4}
    .toast{position:fixed;right:16px;bottom:16px;background:#0f172a;color:#fff;border:1px solid rgba(255,255,255,.18);border-radius:12px;padding:10px 14px;box-shadow:0 10px 24px rgba(0,0,0,.3);opacity:0;transform:translateY(6px);transition:.2s;z-index:9999}
    .toast.show{opacity:1;transform:translateY(0)}
    .modal{position:fixed;inset:0;background:rgba(2,6,23,.5);display:none;align-items:center;justify-content:center;padding:16px;z-index:1000}
    .modal .panel{width:min(720px,96vw);background:#fff;border-radius:16px;border:1px solid var(--border);box-shadow:var(--shadow);color:#111827;overflow:hidden}
    .modal header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border)}
    .modal header h3{margin:0;font-size:15px}
    .modal .content{padding:12px 14px;max-height:70vh;overflow:auto}
    .empty{padding:18px;text-align:center;color:#64748b}
  

    
    /* å·¦ä¸‹è§’å¯¼èˆªæŒ‰é”® */
    .top-nav-button{display:none;position:fixed;bottom:calc(var(--mobile-nav-height) + 20px);left:20px;z-index:1001;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px;cursor:pointer;box-shadow:var(--shadow);width:48px;height:48px;display:flex;align-items:center;justify-content:center}
    .top-nav-button .nav-icon{font-size:20px;color:var(--text)}
    .top-nav-button:hover{transform:translateY(-1px);box-shadow:0 14px 28px rgba(0,0,0,.32)}
    .top-nav-button:active{transform:translateY(0);box-shadow:0 8px 18px rgba(0,0,0,.26)}

    /* é¡¶éƒ¨å¯¼èˆªèœå• */
    .top-nav-menu{position:fixed;top:0;left:-320px;width:320px;height:100vh;background:var(--panel);border-right:1px solid var(--border);z-index:1000;transition:.3s ease;overflow-y:auto}
    .top-nav-menu.active{left:0}
    .top-nav-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:999;opacity:0;visibility:hidden;transition:.3s ease}
    .top-nav-overlay.active{opacity:1;visibility:visible}
    
    .nav-header{display:flex;justify-content:space-between;align-items:center;padding:20px;border-bottom:1px solid var(--border)}
    .nav-title{font-size:18px;font-weight:700;color:var(--text)}
    .close-btn{background:none;border:none;font-size:24px;color:var(--text);cursor:pointer;padding:0;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:6px;transition:.2s}
    .close-btn:hover{background:var(--border)}
    
    .top-nav-menu .nav-list{list-style:none;margin:0;padding:20px}
    .top-nav-menu .nav-list li{margin-bottom:8px}
    .top-nav-menu .nav-list a{display:flex;align-items:center;gap:12px;text-decoration:none;color:var(--text);padding:12px;border-radius:8px;transition:.2s}
    .top-nav-menu .nav-list a:hover{background:var(--border)}
    .top-nav-menu .nav-list .nav-icon{font-size:18px;width:24px;text-align:center}

    /* ç§»åŠ¨ç«¯å“åº”å¼ä¼˜åŒ– */
    @media (max-width: 960px) {
      .container {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
        padding: 16px;
        padding-bottom: calc(var(--mobile-nav-height) + 20px);
      }
      
      .sidebar {
        display: none;
      }
      
      .panel {
        padding: 16px;
        border-radius: 16px;
      }
      
      .search-box {
        flex-direction: column;
        gap: 12px;
      }
      
      .search-box input {
        padding: 14px 16px;
        font-size: 16px;
      }
      
      .search-box button {
        padding: 14px 16px;
        font-size: 16px;
      }
      
      .panel-title {
        font-size: 20px;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: 12px;
        padding-bottom: calc(var(--mobile-nav-height) + 16px);
      }
      
      .panel {
        padding: 12px;
        border-radius: 12px;
      }
      
      .search-box input {
        padding: 16px;
        font-size: 16px;
      }
      
      .search-box button {
        padding: 16px;
        font-size: 16px;
      }
      
      .panel-title {
        font-size: 18px;
      }
      
      .card {
        border-radius: 12px;
        margin-bottom: 12px;
      }
      
      .card-text {
        padding: 12px;
        font-size: 14px;
      }
    }
</style>

</head>
<body>
  
  <!-- å·¦ä¸Šè§’å¯¼èˆªæŒ‰é”® -->
  <div class="top-nav-button" id="topNavButton">
    <span class="nav-icon">ğŸ’¬</span>
  </div>

  <!-- é¡¶éƒ¨å¯¼èˆªèœå• -->
  <div class="top-nav-menu" id="topNavMenu">
    <div class="nav-header">
      <span class="nav-title">å¯¼èˆªèœå•</span>
      <button class="close-btn" id="closeNavBtn">Ã—</button>
    </div>
    <ul class="nav-list">
      <li><a href="main page.html"><span class="nav-icon">ğŸ </span><span>ä¸»é¡µ</span></a></li>
      <li><a href="life-tips.html"><span class="nav-icon">ğŸ’¡</span><span>ç”Ÿæ´»å°è´´å£«</span></a></li>
      <li><a href="study-guide.html"><span class="nav-icon">ğŸ“š</span><span>å­¦ä¹ æŒ‡å¯¼</span></a></li>
      <li><a href="profile.html"><span class="nav-icon">ğŸ‘¤</span><span>ä¸ªäººä¸»é¡µ</span></a></li>
      <li><a href="enrollment-steps.html"><span class="nav-icon">ğŸ“</span><span>å…¥å­¦æ­¥éª¤</span></a></li>
      <li><a href="share.html"><span class="nav-icon">ğŸ”—</span><span>åˆ†äº«</span></a></li>
      <li><a href="fun.html"><span class="nav-icon">ğŸ‰</span><span>å¨±ä¹</span></a></li>
      <li><a href="hospital.html"><span class="nav-icon">ğŸ¥</span><span>åŒ»é™¢</span></a></li>
      <li><a href="messages.html"><span class="nav-icon">ğŸ’¬</span><span>æ¶ˆæ¯</span></a></li>
    </ul>
  </div>

  <!-- é¡¶éƒ¨å¯¼èˆªé®ç½© -->
  <div class="top-nav-overlay" id="topNavOverlay"></div>
  <div class="mobile-sidebar-overlay" id="mobileSidebarOverlay"></div>


  <div class="layout">
    <aside class="sidebar">
      <a class="account-info" href="admin-profile.html">
        <img src="" alt="å¤´åƒ" class="avatar">
        <span class="username">æˆ‘çš„è´¦å·</span>
      </a>
      <ul class="nav-list">
        <li><a href="admin-all.html"><span class="nav-icon">âš™ï¸</span><span>åå°ç®¡ç†</span></a></li>
        <li><a href="admin-publish.html"><span class="nav-icon">ğŸ“</span><span>å‘å¸ƒå†…å®¹</span></a></li>
        <li><a href="admin-posts.html"><span class="nav-icon">ğŸ“‹</span><span>å¸–å­ç®¡ç†</span></a></li>
      </ul>
    </aside>

    <main class="main">
      <div class="bar">
        <!-- filled by page script if needed -->
      </div>

      
  <div class="grid">
    <section class="card" id="publish">
      <h2>å‘å¸ƒä¿¡æ¯åˆ°å½“å‰åˆ†ç±»</h2>
      <div class="body">
        <form id="publishForm">
          <div class="row">
            <div class="field" style="flex:1 1 260px">
              <label>æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰</label>
              <input type="text" name="title" placeholder="ä¾‹å¦‚ï¼šé‡è¦é€šçŸ¥ / æ”»ç•¥ / è®¾æ–½æ›´æ–°â€¦"/>
            </div>
            <div class="field" style="flex:1 1 260px">
              <label>ä½œè€…é‚®ç®±ï¼ˆç”¨äºé€šçŸ¥ï¼‰</label>
              <input type="email" name="authorEmail" placeholder="someone@example.com"/>
            </div>
          </div>
          <div class="field">
            <label>æ­£æ–‡/æè¿°</label>
            <textarea name="desc" rows="4" placeholder="è¾“å…¥è¦å‘å¸ƒçš„å†…å®¹â€¦" required></textarea>
          </div>
          <div class="field" id="regionField" style="display: none;">
            <label>åœ°åŒºé€‰æ‹©</label>
            <select name="region" class="field" style="border:1px solid var(--border);border-radius:12px;padding:10px 12px;font-size:14px;outline:none">
              <option value="">è¯·é€‰æ‹©ä½ æ‰€åœ¨çš„åœ°åŒº</option>
              <option value="putrajaya">Putrajaya</option>
              <option value="cyberjaya">Cyberjaya</option>
              <option value="petaling-jaya">Petaling Jaya</option>
              <option value="puchong">Puchong</option>
              <option value="subang-jaya">Subang Jaya</option>
              <option value="kajang">Kajang</option>
              <option value="seri-kembangan">Seri Kembangan</option>
              <option value="bangi">Bangi</option>
              <option value="cheras">Cheras</option>
              <option value="sungai-buloh">Sungai Buloh</option>
              <option value="shah-alam">Shah Alam</option>
              <option value="klang">Klang</option>
              <option value="port-klang">Port Klang</option>
              <option value="banting">Banting</option>
              <option value="rawang">Rawang</option>
              <option value="sepang">Sepang</option>
              <option value="melaka">Melaka</option>
              <option value="johor">Johor</option>
              <option value="perak">Perak</option>
              <option value="pahang">Pahang</option>
              <option value="perlis">Perlis</option>
              <option value="terengganu">Terengganu</option>
              <option value="kelantan">Kelantan</option>
              <option value="kedah">Kedah</option>
              <option value="pulau-pinang">Pulau Pinang</option>
              <option value="sarawak">Sarawak</option>
              <option value="university-campuses">University Campuses</option>
            </select>
          </div>
          <div class="field">
            <label>å›¾ç‰‡ä¸Šä¼ ï¼ˆå¯é€‰ï¼Œæ”¯æŒå¤šé€‰å’Œæ‹–æ‹½ï¼‰</label>
            <input type="file" id="imageUpload" multiple accept="image/*" style="display: none;"/>
            <div class="row" style="gap: 8px; align-items: center;">
              <button type="button" class="btn" onclick="document.getElementById('imageUpload').click()">
                ğŸ“ é€‰æ‹©å›¾ç‰‡
              </button>
              <span class="tip" id="imageCount">æœªé€‰æ‹©å›¾ç‰‡</span>
            </div>
            <div id="imagePreview" class="row drop-zone" style="margin-top: 8px; gap: 8px; flex-wrap: wrap; min-height: 40px; border: 2px dashed #e5e7eb; border-radius: 8px; padding: 8px; align-items: center; justify-content: center;" 
                 ondrop="handleDrop(event)" 
                 ondragover="handleDragOver(event)" 
                 ondragleave="handleDragLeave(event)">
              <span class="tip" id="dropHint">æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„æˆ–ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®é€‰æ‹©</span>
            </div>
          </div>
          <div class="row right">
            <label class="row" style="gap:6px"><input type="checkbox" name="pinned"/> ç½®é¡¶</label>
            <button class="btn" type="submit">å‘å¸ƒåˆ°è¯¥åˆ†ç±»</button>
          </div>
          <div class="tip">æäº¤åå°†å…ˆä¸Šä¼ å›¾ç‰‡åˆ° <code>/api/upload</code>ï¼Œç„¶åè°ƒç”¨ <code>POST /api/posts</code> å‘å¸ƒå†…å®¹ã€‚åˆ†ç±»ç”±æœ¬é¡µé¡¶éƒ¨ä¸‹æ‹‰æ¡†é€‰æ‹©ã€‚</div>
        </form>
      </div>
    </section>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const CATEGORY_ALIAS = { 'life-tips':'life', 'study-guide':'study', 'enrollment-steps':'enroll' };
    function backendCat(cat){ return (CATEGORY_ALIAS[cat]||cat||'hospital').toLowerCase(); }
    let currentCategory = 'hospital';

    // é¡¶éƒ¨åˆ†ç±»æ¡
    function renderBar(){
      const bar = document.querySelector('.bar');
      if(!bar) return;
      bar.innerHTML = `
        <h1>åå°ç®¡ç† Â· å‘å¸ƒå†…å®¹</h1>
        <div class="spacer"></div>
        <label class="row" style="gap:8px">
          <span class="muted" style="font-size:12px">é€‰æ‹©åˆ†ç±»ï¼š</span>
          <select id="categorySelect" class="btn">
            <option value="hospital">åŒ»é™¢ï¼ˆhospitalï¼‰</option>
            <option value="share">åˆ†äº«ï¼ˆshareï¼‰</option>
            <option value="life-tips">ç”Ÿæ´»å°è´´å£«ï¼ˆlife-tipsï¼‰</option>
            <option value="study-guide">å­¦ä¹ æŒ‡å¯¼ï¼ˆstudy-guideï¼‰</option>
            <option value="enrollment-steps">å…¥å­¦æ­¥éª¤ï¼ˆenrollment-stepsï¼‰</option>
            <option value="fun">å¨±ä¹ï¼ˆfunï¼‰</option>
          </select>
        </label>
      `;
      const sel = document.getElementById('categorySelect');
      const saved = localStorage.getItem('admin.category');
      if(saved) { currentCategory = saved; sel.value = saved; }
      sel.addEventListener('change', e=>{
        currentCategory = e.target.value;
        localStorage.setItem('admin.category', currentCategory);
        
        // å½“é€‰æ‹©åŒ»é™¢åˆ†ç±»æ—¶æ˜¾ç¤ºåœ°åŒºé€‰æ‹©æ¡†
        const regionField = document.getElementById('regionField');
        if (regionField) {
          if (currentCategory === 'hospital') {
            regionField.style.display = 'block';
          } else {
            regionField.style.display = 'none';
          }
        }
      });
      
      // åˆå§‹åŒ–æ—¶æ£€æŸ¥å½“å‰åˆ†ç±»
      const regionField = document.getElementById('regionField');
      if (regionField && currentCategory === 'hospital') {
        regionField.style.display = 'block';
      }
    }

    let selectedImages = [];

    // å›¾ç‰‡ä¸Šä¼ å’Œé¢„è§ˆåŠŸèƒ½
    function handleImageUpload(files) {
      const preview = document.getElementById('imagePreview');
      const count = document.getElementById('imageCount');
      const dropHint = document.getElementById('dropHint');
      
      // æ¸…ç©ºç°æœ‰é¢„è§ˆ
      preview.innerHTML = '';
      selectedImages = [];
      
      if (files.length === 0) {
        count.textContent = 'æœªé€‰æ‹©å›¾ç‰‡';
        dropHint.style.display = 'block';
        return;
      }
      
      // éªŒè¯æ–‡ä»¶ç±»å‹å’Œå¤§å°
      const validFiles = Array.from(files).filter(file => {
        if (!file.type.startsWith('image/')) {
          toast(`æ–‡ä»¶ ${file.name} ä¸æ˜¯å›¾ç‰‡æ ¼å¼`);
          return false;
        }
        if (file.size > 5 * 1024 * 1024) { // 5MBé™åˆ¶
          toast(`æ–‡ä»¶ ${file.name} å¤ªå¤§ï¼Œè¯·é€‰æ‹©å°äº5MBçš„å›¾ç‰‡`);
          return false;
        }
        return true;
      });
      
      if (validFiles.length === 0) {
        count.textContent = 'æœªé€‰æ‹©æœ‰æ•ˆå›¾ç‰‡';
        return;
      }
      
      count.textContent = `å·²é€‰æ‹© ${validFiles.length} å¼ å›¾ç‰‡`;
      
      validFiles.forEach((file, index) => {
        // åˆ›å»ºé¢„è§ˆå…ƒç´ 
        const previewItem = document.createElement('div');
        previewItem.className = 'image-preview';
        
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        img.alt = `é¢„è§ˆå›¾ç‰‡ ${index + 1}`;
        
        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove';
        removeBtn.textContent = 'Ã—';
        removeBtn.title = 'ç§»é™¤å›¾ç‰‡';
        removeBtn.onclick = () => {
          previewItem.remove();
          selectedImages = selectedImages.filter((_, i) => i !== index);
          updateImageCount();
        };
        
        previewItem.appendChild(img);
        previewItem.appendChild(removeBtn);
        preview.appendChild(previewItem);
        
        // å­˜å‚¨æ–‡ä»¶
        selectedImages.push(file);
      });
    }
    
    function updateImageCount() {
      const count = document.getElementById('imageCount');
      const preview = document.getElementById('imagePreview');
      const dropHint = document.getElementById('dropHint');
      const imageCount = preview.children.length;
      
      if (imageCount === 0) {
        count.textContent = 'æœªé€‰æ‹©å›¾ç‰‡';
        dropHint.style.display = 'block';
      } else {
        count.textContent = `å·²é€‰æ‹© ${imageCount} å¼ å›¾ç‰‡`;
        dropHint.style.display = 'none';
      }
    }
    
    // æ‹–æ‹½åŠŸèƒ½
    function handleDragOver(e) {
      e.preventDefault();
      e.currentTarget.classList.add('dragover');
    }
    
    function handleDragLeave(e) {
      e.preventDefault();
      e.currentTarget.classList.remove('dragover');
    }
    
    function handleDrop(e) {
      e.preventDefault();
      e.currentTarget.classList.remove('dragover');
      
      const files = Array.from(e.dataTransfer.files);
      if (files.length > 0) {
        handleImageUpload(files);
      }
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      renderBar();

      // å›¾ç‰‡ä¸Šä¼ äº‹ä»¶ç›‘å¬
      document.getElementById('imageUpload').addEventListener('change', (e) => {
        handleImageUpload(e.target.files);
      });

      document.getElementById('publishForm').addEventListener('submit', async (e)=>{
        e.preventDefault();
        
        if(!e.target.desc.value.trim()){ 
          toast('æ­£æ–‡å¿…å¡«'); 
          return; 
        }
        
        try {
          // å…ˆä¸Šä¼ å›¾ç‰‡
          const uploadedImages = [];
          if (selectedImages.length > 0) {
            toast(`æ­£åœ¨ä¸Šä¼  ${selectedImages.length} å¼ å›¾ç‰‡...`);
            
            for (let i = 0; i < selectedImages.length; i++) {
              const file = selectedImages[i];
              try {
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch(API_BASE + '/api/upload', {
                  method: 'POST',
                  body: formData,
                  credentials: 'include'
                });
                
                if (response.ok) {
                  const result = await response.json();
                  const imageUrl = result.url || result.path || result.file || '';
                  if (imageUrl) {
                    uploadedImages.push(imageUrl);
                    toast(`å›¾ç‰‡ ${i + 1}/${selectedImages.length} ä¸Šä¼ æˆåŠŸ`);
                  }
                } else {
                  toast(`å›¾ç‰‡ ${file.name} ä¸Šä¼ å¤±è´¥`);
                }
              } catch (uploadError) {
                console.warn('å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', uploadError);
                toast(`å›¾ç‰‡ ${file.name} ä¸Šä¼ å¤±è´¥ï¼Œå°†è·³è¿‡`);
              }
            }
            
            if (uploadedImages.length > 0) {
              toast(`æˆåŠŸä¸Šä¼  ${uploadedImages.length} å¼ å›¾ç‰‡`);
            }
          }
          
          // å‡†å¤‡å‘å¸ƒæ•°æ®
          let title = (e.target.title.value || '').trim();
          const desc = (e.target.desc.value || '').trim();
          
          // å¦‚æœæ ‡é¢˜ä¸ºç©ºï¼Œæ ¹æ®å†…å®¹ç”Ÿæˆé»˜è®¤æ ‡é¢˜
          if (!title) {
            const contentPreview = desc.substring(0, 20);
            title = contentPreview ? `${contentPreview}...` : 'æ–°å¸–å­';
          }
          
          const payload = {
            title: title,
            desc: desc,
            category: backendCat(currentCategory),
            images: uploadedImages,
            pinned: e.target.pinned.checked,
            authorEmail: (e.target.authorEmail.value || '').trim()
          };
          
          // å¦‚æœæ˜¯åŒ»é™¢åˆ†ç±»ï¼Œæ·»åŠ åœ°åŒºä¿¡æ¯
          if (currentCategory === 'hospital') {
            const region = (e.target.region.value || '').trim();
            if (region) {
              payload.region = region;
            }
          }
          
          // å‘å¸ƒå¸–å­
          await api('/api/posts', { method:'POST', body: JSON.stringify(payload) });
          toast('å‘å¸ƒæˆåŠŸ');
          
          // é‡ç½®è¡¨å•
          e.target.reset();
          selectedImages = [];
          document.getElementById('imagePreview').innerHTML = '';
          document.getElementById('imageCount').textContent = 'æœªé€‰æ‹©å›¾ç‰‡';
          document.getElementById('dropHint').style.display = 'block';
          
        } catch(err) { 
          toast('å‘å¸ƒå¤±è´¥ï¼š' + err.message); 
        }
      });
    });
  </script>

    </main>
  </div>

  
  <script>
    // è‡ªåŠ¨æ£€æµ‹APIåŸºç¡€URL
  const API_BASE = (() => {
    if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
      return 'http://127.0.0.1:3001';
    }
    return ''; // ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ç›¸å¯¹è·¯å¾„
  })();
    const $ = sel => document.querySelector(sel);
    function toast(msg, ms=2000){ const el=$('#toast'); if(!el) return; el.textContent=msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'), ms); }
    async function api(path, opt={}){
      const url = path.startsWith('http')? path : API_BASE + path;
      const res = await fetch(url, { credentials:'include', headers:{'Content-Type':'application/json', ...(opt.headers||{})}, ...opt });
      if(!res.ok){ let text=''; try{text=await res.text()}catch{} throw new Error(res.status+': '+text); }
      const ct = res.headers.get('content-type')||'';
      return ct.includes('application/json')? res.json(): res.text();
    }
    async function hydrateAccount(){
      // ç®¡ç†å‘˜é¡µé¢ä»localStorageè·å–ç®¡ç†å‘˜ä¿¡æ¯
      const adminUser = JSON.parse(localStorage.getItem('adminUser') || localStorage.getItem('tempAdminUser') || '{}');
      const name = adminUser.name || adminUser.nickname || 'æµ·å¤–ç•™å­¦';
      const avatar = adminUser.avatarPath || adminUser.avatar || '';
      const n = document.querySelector('.username'); if(n) n.textContent = name;
      const img = document.querySelector('.avatar'); if(img) img.src = avatar || '';
    }
    document.addEventListener('DOMContentLoaded', hydrateAccount);
  </script>

  <!-- é¡¶éƒ¨å¯¼èˆªäº¤äº’JavaScript -->
  <script>
  /* é¡¶éƒ¨å¯¼èˆªäº¤äº’åŠŸèƒ½ */
  (function(){
    const topNavButton = document.getElementById('topNavButton');
    const topNavMenu = document.getElementById('topNavMenu');
    const topNavOverlay = document.getElementById('topNavOverlay');
    const closeNavBtn = document.getElementById('closeNavBtn');
    const mobileNavLinks = document.querySelectorAll('.mobile-nav-link');

    // é¡¶éƒ¨å¯¼èˆªæŒ‰é”®ç‚¹å‡»äº‹ä»¶
    if(topNavButton && topNavMenu && topNavOverlay) {
      topNavButton.addEventListener('click', () => {
        console.log('é¡¶éƒ¨å¯¼èˆªæŒ‰é”®è¢«ç‚¹å‡»'); // è°ƒè¯•æ—¥å¿—
        topNavMenu.classList.add('active');
        topNavOverlay.classList.add('active');
        document.body.style.overflow = 'hidden';
      });

      // å…³é—­æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      if(closeNavBtn) {
        closeNavBtn.addEventListener('click', () => {
          topNavMenu.classList.remove('active');
          topNavOverlay.classList.remove('active');
          document.body.style.overflow = '';
        });
      }

      // ç‚¹å‡»é®ç½©å…³é—­å¯¼èˆªèœå•
      topNavOverlay.addEventListener('click', () => {
        topNavMenu.classList.remove('active');
        topNavOverlay.classList.remove('active');
        document.body.style.overflow = '';
      });

      // ESCé”®å…³é—­å¯¼èˆªèœå•
      document.addEventListener('keydown', (e) => {
        if(e.key === 'Escape' && topNavMenu.classList.contains('active')) {
          topNavMenu.classList.remove('active');
          topNavOverlay.classList.remove('active');
          document.body.style.overflow = '';
        }
      });
    } else {
      console.warn('é¡¶éƒ¨å¯¼èˆªå…ƒç´ æœªæ‰¾åˆ°:', { topNavButton, topNavMenu, topNavOverlay });
    }

    // ç§»åŠ¨ç«¯å¯¼èˆªé“¾æ¥ç‚¹å‡»äº‹ä»¶
    mobileNavLinks.forEach(link => {
      link.addEventListener('click', () => {
        // ç§»é™¤æ‰€æœ‰activeç±»
        mobileNavLinks.forEach(l => l.classList.remove('active'));
        // æ·»åŠ activeç±»åˆ°å½“å‰ç‚¹å‡»çš„é“¾æ¥
        link.classList.add('active');
      });
    });

    // è§¦æ‘¸æ‰‹åŠ¿æ”¯æŒ
    let startX = 0;
    let startY = 0;
    let currentX = 0;
    let currentY = 0;

    document.addEventListener('touchstart', (e) => {
      startX = e.touches[0].clientX;
      startY = e.touches[0].clientY;
    });

    document.addEventListener('touchmove', (e) => {
      currentX = e.touches[0].clientX;
      currentY = e.touches[0].clientY;
    });

    document.addEventListener('touchend', () => {
      const deltaX = currentX - startX;
      const deltaY = currentY - startY;
      const minSwipeDistance = 50;

      // ä»å·¦å‘å³æ»‘åŠ¨æ‰“å¼€å¯¼èˆªèœå•
      if(deltaX > minSwipeDistance && Math.abs(deltaY) < Math.abs(deltaX) && startX < 50) {
        if(topNavMenu && !topNavMenu.classList.contains('active')) {
          topNavMenu.classList.add('active');
          topNavOverlay.classList.add('active');
          document.body.style.overflow = 'hidden';
        }
      }
      // ä»å³å‘å·¦æ»‘åŠ¨å…³é—­å¯¼èˆªèœå•
      else if(deltaX < -minSwipeDistance && Math.abs(deltaY) < Math.abs(deltaX) && topNavMenu && topNavMenu.classList.contains('active')) {
        topNavMenu.classList.remove('active');
        topNavOverlay.classList.remove('active');
        document.body.style.overflow = '';
      }
    });
  })();</script>
</body>
</html>